<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>crafting-interpreters-zh</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">å‰è¨€</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æ¬¢è¿</li><li class="chapter-item expanded "><a href="welcome/welcome.html"><strong aria-hidden="true">1.</strong> æ¬¢è¿</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="welcome/introduction.html"><strong aria-hidden="true">1.1.</strong> ä»‹ç»</a></li></ol></li><li class="chapter-item expanded "><a href="welcome/a-map-of-the-territory.html"><strong aria-hidden="true">2.</strong> æ€»è§ˆå›¾</a></li><li class="chapter-item expanded "><a href="welcome/the-lox-language.html"><strong aria-hidden="true">3.</strong> Loxè¯­è¨€</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">crafting-interpreters-zh</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="åŸºæœ¬ä»‹ç»"><a class="header" href="#åŸºæœ¬ä»‹ç»">åŸºæœ¬ä»‹ç»</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ¬¢è¿"><a class="header" href="#æ¬¢è¿">æ¬¢è¿</a></h1>
<p>This may be the beginning of a grand adventure. Programming languages encompass a h
uge space to explore and play in. Plenty of room for your own creations to share with others or just enjoy yourself. Brilliant computer scientists and software engineers have spent entire careers traversing this land without ever reaching the end. If this book is your first entry into the country, welcome.</p>
<p>The pages of this book give you a guided tour through some of the world of languages. But before we strap on our hiking boots and venture out, we should familiarize ourselves with the territory. The chapters in this part introduce you to the basic concepts used by programming languages and how those concepts are organized.</p>
<p>We will also get acquainted with Lox, the languages we'll spend the rest of the book implementing(twice).</p>
<hr />
<p>è¿™å°†æ˜¯ä¸€æ¬¡ä¼Ÿå¤§çš„å†’é™©ã€‚ç¨‹åºç¼–ç¨‹æ‹¥æœ‰æ— é™çš„æ¢ç´¢å’Œåº”ç”¨ç©ºé—´ã€‚ä½ å¯ä»¥ä¸ä»–äººåˆ†äº«ç¼–ç¨‹ä¹è¶£æˆ–è€…åªæ˜¯è‡ªå¨±è‡ªä¹ã€‚æ°å‡ºçš„è®¡ç®—æœºç§‘å­¦å®¶å’Œè½¯ä»¶å·¥ç¨‹å¸ˆä¸€ç›´åœ¨ç¼–ç¨‹é¢†åŸŸæ¢ç´¢ï¼Œç»ˆå…¶ä¸€ç”Ÿä¹åœ¨å…¶ä¸­ã€‚å¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦è¿™ä¸ªé¢†åŸŸï¼Œé‚£ä¹ˆçƒ­çƒˆæ¬¢è¿ä½ ï¼</p>
<p>æœ¬ä¹¦å°†å’Œä½ ä¸€èµ·å‚è§‚è¯­è¨€ä¸–ç•Œã€‚ä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬å¼€å§‹å†’é™©ä¹‹å‰ï¼Œéœ€è¦å…ˆäº†è§£è¦è¸è¶³çš„åœŸåœ°ã€‚æ¥ä¸‹æ¥ç« èŠ‚ï¼Œå°†å‘æ‚¨ä»‹ç»ç¼–ç¨‹è¯­è¨€ä¸­çš„å¸¸ç”¨æ¦‚å¿µå’Œè¿™äº›åŸºæœ¬æ¦‚å¿µçš„ç»„ç»‡æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬è¿˜å°†ä»‹ç»ä¸€é—¨æ–°çš„è¯­è¨€ Lox, æœ¬ä¹¦ä¼šå¸¦ä½ å®ç°2æ¬¡ Lox è¯­è¨€ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»‹ç»"><a class="header" href="#ä»‹ç»">ä»‹ç»</a></h1>
<blockquote>
<p>fairy tales are more than true: not because they tell us that dragons exist, but because they tell us that dragons can be beaten. </p>
<p align="right"> â€”â€” G.K. Chesterton by way of Neil Gaiman, Coraline </p>
<p>ç«¥è¯ç»ä¸ä»…æ˜¯çœŸå®çš„: ä¸ä»…ä»…åœ¨äºå®ƒå‘Šè¯‰æˆ‘ä»¬é¾™çš„å­˜åœ¨ï¼Œæ›´åœ¨äºå®ƒå‘Šè¯‰æˆ‘ä»¬å‹‡å£«å¯ä»¥æˆ˜èƒœæ¶é¾™ã€‚</p>
<p align="right"> â€”â€” G.K. Chesterton by way of Neil Gaiman, Coraline </p>
</blockquote>
<p>I'm really excited we're going on this journey together. This is a book on implementing interpreters for programming languages. It's also a book on how to design a language worth implementing. It's the book I wish I'd had when I first started getting into languages, and it's the book I've been writing in my head for nearly a decade.</p>
<p>éå¸¸é«˜å…´æˆ‘ä»¬å¯ä»¥ä¸€èµ·å¼€å¯æ–°çš„æ—…ç¨‹ï¼Œ</p>
<p>è¿™æ˜¯ä¸€æœ¬ä»‹ç»ç¼–ç¨‹è¯­è¨€è§£é‡Šå™¨çš„ä¹¦ï¼Œ è¿™æœ¬ä¹¦è¿˜ä¼šä»‹ç»å¦‚ä½•è‡ªå·±å®ç°ä¸€é—¨è¯­è¨€ã€‚</p>
<p>è¿™æœ¬ä¹¦åœ¨æˆ‘è„‘æµ·ä¸­å·²ç»åå¤ç¼–è¾‘äº†åå¹´äº†ï¼Œå¤šä¹ˆå¸Œæœ›åœ¨æˆ‘åˆšæ¥è§¦ç¼–ç¨‹è¯­è¨€æ—¶å€™èƒ½é‡åˆ°è¿™ç§ä¹¦ç±ã€‚ğŸ¶</p>
<blockquote>
<p>to my friends and family, sorry I've been so absentminded!</p>
<p>å¯¹äºæˆ‘çš„æœ‹å‹å’Œå®¶äººï¼Œå¾ˆæŠ±æ­‰æˆ‘ä¸€ç›´å¿ƒä¸åœ¨ç„‰ã€‚</p>
</blockquote>
<p>In these pages, we will walk step-by-step through two complete interpreters for a full-featured language. I assume this is your first foray into languages, so I'll cover each concept and line of code you need to build a complete, usable, fast language implementation.</p>
<p>In order to cram two full implementations inside one book without it turning into a doorstop, this text is lighter on theory than others. As we build each piece of the system, I will introduce the history and concepts behind it. I'll try to get your familiar with the lingo so that if you ever find yourself at a cocktail party full of PL(parogramming language) researchers, you'll fit in.</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡å®ç°ä¸¤ä¸ªå®Œæ•´çš„ç¼–è¯‘å™¨ï¼Œå»å®ç°ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„è¯­è¨€ã€‚æˆ‘ä¼šå‡è®¾ä½ ç¬¬ä¸€æ¬¡æ¥è§¦è¯­è¨€ç¼–ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä¼šè¯¦ç»†ä»‹ç»æ¯ä¸€ä¸ªæ¦‚å¿µå’Œåˆ—å‡ºè¯¦ç»†çš„ä»£ç ï¼Œè€Œè¿™ä¸€åˆ‡å°†ä¼šæ„å»ºå®Œæ•´ã€å¯ç”¨ã€å¿«é€Ÿçš„è¯­è¨€ã€‚</p>
<p>ä¸ºäº†åœ¨ä¸€æœ¬ä¹¦ä¸­ï¼Œå®ç°ä¸¤ä¸ªç¼–è¯‘å™¨ï¼Œç›¸å¯¹äºå…¶ä»–çš„ç¼–è¯‘è¯­è¨€ä¹¦ç±ï¼Œæˆ‘ä»¬ä¼šæ›´å°‘ä»‹ç»ç¼–è¯‘åŸç†ï¼Œæˆ‘ä»¬ä¸æƒ³æˆä¸ºä»‹ç»ç¼–è¯‘ç†è®ºçš„æ‹¦è·¯è™ã€‚åœ¨æ„å»ºç¼–è¯‘ç³»ç»Ÿçš„æ¯ä¸€ä¸ªéƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç»å…¶èƒŒåçš„å†å²å’Œæ¦‚å¿µã€‚æˆ‘å°†å°½å¯èƒ½ä½¿ç”¨è¡Œè¯ï¼Œè¿™æ ·å³ä½¿å°†æ¥ä½ å‡ºç°åœ¨ä¸€ä¸ªç¼–ç¨‹è¯­è¨€çš„é¸¡å°¾é…’ä¼šï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿèå…¥å…¶ä¸­ã€‚</p>
<blockquote>
<p>Strangely enough, a situation I have found myself in multiple times. You wouldn't believe how much some of them can drink.</p>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘å‘ç°è‡ªå·±å¤šæ¬¡é™·å…¥è¿™ç§åœºæ™¯ã€‚ä½ ä¸åº”è¯¥å‡æƒ³ä»–ä»¬éƒ½å¾ˆèƒ½å–ã€‚</p>
</blockquote>
<p>But we're mostly going to spend our brain juice getting the language up and running. This is not to say theory isn't important. Being able to reason precisely and formally about syntax and semantics is a vital skill when working on a language. But, presonally, I learn best by doing. It's hard for me to wade through paragraphs full of abstract concepts and really absorb them. But if I've coded something, run it, and debugged it, then I get it.</p>
<p>æˆ‘ä»¬å°†èŠ±è´¹ç²¾åŠ›å»å¼€å‘è¿è¡Œè¯­è¨€ï¼Œè€Œè¿™å¹¶ä¸ä»£è¡¨ç†è®ºä¸é‡è¦ã€‚åœ¨å­¦ä¹ è¯­è¨€æ—¶å€™ï¼ŒæŒæ¡è¯­æ³•å’Œè¯­ä¹‰è§„åˆ™éå¸¸é‡è¦ã€‚ä½†æ˜¯ï¼Œä¸ªäººç»éªŒï¼Œæˆ‘æ€»æ˜¯ä»å®è·µä¸­è·å–æ›´å¤šçš„ä¸œè¥¿ï¼Œæˆ‘é€šå¸¸å¾ˆéš¾çœ‹æ‡‚æˆ–è€…çœŸçš„ç†è§£å……æ»¡æŠ½è±¡æ¦‚å¿µçš„æ®µè½ã€‚ä½†æ˜¯ï¼Œä½†æˆ‘ä»£ç ä¸­ç¼–ç ã€è¿è¡Œã€è°ƒè¯•è¿‡æŸä¸ªæ¦‚å¿µï¼Œæˆ‘å°†èƒ½çœŸæ­£æŒæ¡å®ƒã€‚</p>
<blockquote>
<p>Static type systems in particular require rigorous formal reasoning. Hacking on a type system has the same feel as proving a theorem in mathematics. </p>
<p>é™æ€ç±»å‹ç³»ç»Ÿï¼Œå°¤å…¶éœ€è¦ä¸¥æ ¼çš„å½¢å¼æ¨ç†ã€‚åœ¨ç±»å‹ç³»ç»Ÿä¸Šè¿›è¡Œç¼–ç¨‹ï¼Œéå¸¸åƒæ˜¯è¯æ˜ä¸€ä¸ªæ•°å­¦å®šç†ã€‚</p>
</blockquote>
<blockquote>
<p>It turns out this is no coincidence. In the early half of last century, Haskell Curry and William Alvin Howard showed that they are two sides of the same coin: <a href="https://en.wikipedia.org/wiki/Curry%E2%80%93Howard_correspondence">the Curry-Howard isomorphism</a></p>
<p>äº‹å®è¯æ˜ï¼Œè¿™ä¸ªæ„Ÿè§‰å¹¶éæ˜¯å·§åˆã€‚åœ¨20ä¸–çºªä¸ŠåŠå¶ï¼ŒHaskell Curry å’Œ William Alvin Howardä¸¥æ ¼è¯æ˜äº†ç¼–ç¨‹è¯­è¨€å’Œæ•°å­¦è¯æ˜ä¹‹é—´çš„å…³ç³»ï¼Œç§°ä¸º<a href="https://en.wikipedia.org/wiki/Curry%E2%80%93Howard_correspondence">æŸ¯é‡Œ-éœåå¾·åŒæ„</a></p>
</blockquote>
<p>That's my goal for you. I want you to come away with a solid intuition of how a real language lives and breathes. My hope is that when you read other, more theoretical books later, the concepts there will firmly stick in your mind, adhered to this tangible substrate.</p>
<p>è¿™ä¸ªæœ¬ä¹¦çš„ä¸€ä¸ªç›®æ ‡ï¼Œå¯ä»¥è®©ä½ æ›´åŠ çœŸåˆ‡çš„è®¤è¯†ä¸€é—¨è¯­è¨€ï¼Œå¯ä»¥å‡­ç›´è§‰æ„ŸçŸ¥ä¸€é—¨è¯­è¨€å¦‚ä½•ç¼–å†™è¿è¡Œã€‚å¸Œæœ›å½“ä»¥åå­¦ä¹ æ›´å¤šçš„ç¼–è¯‘åŸç†æ—¶å€™ï¼Œé€šè¿‡ç°åœ¨åŸ¹å…»çš„ç›´è§‰ï¼Œå¯ä»¥ç‰¢ç‰¢è®°ä½ä¹¦ä¸­çš„æ¦‚å¿µã€‚</p>
<h2 id="ä¸€why-learn-this-stuff"><a class="header" href="#ä¸€why-learn-this-stuff">ä¸€ã€Why learn this stuff?</a></h2>
<p>ä¸ºä»€ä¹ˆè¦å­¦ä¹ è¿™äº›ä¸œè¥¿ï¼Ÿ</p>
<p>Every introduction to every compiler book seems to have this section. I don't know what it is about programming languages that causes such existential doubt. I don't think ornithology books worry about justifying their existence. They assume the reader loves birds and start teaching.</p>
<p>But programming languages are a little different. I suppose it is true that the odds of any of us creating a broadly successful, general-purpose programming language are slim. The designers of the world's widely used languages could fit in a Volkswagen bus, even without putting the pop-top camper up. If joining that elite group was the only reason to learn languages, it would be hard to justify. Fortunately, it isn't.</p>
<p>ä¼¼ä¹æ¯æœ¬ç¼–è¯‘å™¨ä»‹ç»ä¹¦ç±ï¼Œä¼¼ä¹éƒ½åŒ…å«è¿™ä¸ªè®¨è®ºã€‚æˆ‘ä¸çŸ¥é“ï¼Œä¸ºä»€ä¹ˆç¼–ç¨‹è¯­è¨€ä¼šå‡ºç°è¿™æ ·çš„ç–‘æƒ‘ã€‚é¸Ÿç±»å­¦ç ”ç©¶ä¹¦ç±ä»æ¥ä¸è®¤ä¸ºäººä»¬ä¼šæ€€ç–‘å®ƒæ˜¯å¦è¯¥å­˜åœ¨ï¼Œä»–ä»¬æ€»æ˜¯å‡è®¾è¯»è€…å–œæ¬¢é¸Ÿï¼Œç„¶åå¼€å§‹æ•™å­¦ã€‚</p>
<p>ä½†æ˜¯ç¼–ç¨‹è¯­è¨€æ€»æ˜¯æœ‰ç‚¹ä¸ä¸€æ ·ã€‚æˆ‘è®¤ä¸ºï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†äººï¼Œéƒ½æ— æ³•åˆ›å»ºä¸€ä¸ªå¹¿æ³›æˆåŠŸçš„é€šç”¨ç¼–ç¨‹è¯­è¨€ã€‚ä¸–ç•Œä¸Šæœ€å¹¿æ³›ä½¿ç”¨çš„è¯­è¨€è®¾è®¡è€…å¯ä»¥é€‚åº”é©¾é©¶å¤§ä¼—æ±½è½¦ï¼Œå³ä½¿è½¦ä¸Šæ²¡æœ‰å®‰è£…æµè¡Œçš„éœ²è¥è®¾å¤‡ã€‚å¦‚æœå­¦ä¹ ç¼–è¯‘å™¨ï¼Œä»…ä»…æ˜¯ä¸ºäº†åŠ å…¥è¿™ä¸ªç¼–ç¨‹ç²¾è‹±ç¾¤ä½“ï¼Œé‚£ä¹ˆå¤§å¯ä¸å¿…ã€‚å¹¸è¿çš„æ˜¯ï¼Œäº‹å®ä¹Ÿå¹¶éå¦‚æ­¤ã€‚</p>
<h3 id="11-little-language-are-everywhere"><a class="header" href="#11-little-language-are-everywhere">1.1 Little language are everywhere</a></h3>
<p>For every successful general-purpose language, there are a thousand successful niche ones. We used to call them â€œlittle languagesâ€, but inflation in the jargon economy led to the name â€œdomain-specific languagesâ€.These are pidgins tailor-built to a specific task. Think application scripting languages, template engines, markup formats, and configuration files.</p>
<p>Almost every large software project needs a handful of these. When you can, itâ€™s good to reuse an existing one instead of rolling your own.</p>
<p>A random selection of some little languages you might run into.</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/little-languages.png?raw=true" alt="A random selection of some little languages you might run into." /></p>
<p>But thereâ€™s still a good chance youâ€™ll find yourself needing to whip up a parser or other tool when there isnâ€™t an existing library that fits your needs. Even when you are reusing some existing implementation, youâ€™ll inevitably end up needing to debug and maintain it and poke around in its guts.</p>
<p>å¯¹äºæ¯ä¸€ç§é€šç”¨çš„æµè¡Œè¯­è¨€ï¼Œéƒ½å¯¹åº”ç€æˆåƒå°ä¼—è¯­è¨€ã€‚æˆ‘ä»¬å¯ä»¥ç§°ä¸ºè¿™äº›è¯­è¨€ä¸ºå°ä¼—è¯­è¨€ï¼Œä½†æ˜¯åœ¨è¡Œä¸šæœ¯è¯­ä¸­ï¼Œé€šå¸¸äººä»¬ä¼šä½¿ç”¨é¢†åŸŸç‰¹å®šè¯­è¨€(DSL)æ¥æè¿°ã€‚å®ƒä»¬éƒ½æ˜¯ä¸ºäº†æ‰§è¡Œç‰¹å®šä»»åŠ¡è®¾è®¡ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œè„šæœ¬è¯­è¨€ã€æ¨¡ç‰ˆå¼•æ“ã€æ ‡è®°æ ¼å¼ã€é…ç½®æ–‡ä»¶ã€‚</p>
<p>å‡ ä¹æ¯ä¸ªå¤§å‹é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æ€»ä¼šä½¿ç”¨ä¸Šå›¾ä¸­çš„éƒ¨åˆ†è¯­è¨€ã€‚é€šå¸¸æˆ‘ä»¬ä¼šå¤ç”¨å·²ç»å‡ºç°çš„è¯­è¨€ï¼Œè€Œä¸æ˜¯è‡ªå·±é€ è½®å­ã€‚ä½†æ˜¯ï¼Œå½“ä½ è€ƒè™‘åˆ°æ–‡æ¡£ã€è°ƒè¯•ã€ç¼–è¾‘å™¨æ”¯æŒã€è¯­æ³•é«˜äº®å’Œå…¶ä»–ç±»ä¼¼åŠŸèƒ½ï¼Œå°±éœ€è¦è‡ªå·±åŠ¨æ‰‹äº†ã€‚ğŸ˜„</p>
<p>å½“æ²¡æœ‰ç°æœ‰åº“åŒ¹é…æ–°éœ€æ±‚æ—¶å€™ï¼Œå¯èƒ½éœ€è¦å¼€å‘æ–°çš„è§£æå™¨æˆ–è€…ä¸€äº›å°å·¥å…·ã€‚å³ä½¿å¯¹äºæŸäº›æ­£åœ¨ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“ï¼Œä¹Ÿä¼šéœ€è¦ä¸æ–­è¿›è¡Œè°ƒè¯•å’Œç»´æŠ¤ï¼Œå¹¶ä¸”éœ€è¦å¯¹å…¶æ·±å…¥ç ”ç©¶ã€‚</p>
<h3 id="12-languages-are-great-exercise"><a class="header" href="#12-languages-are-great-exercise">1.2 Languages are great exercise</a></h3>
<p>è¯­è¨€æ˜¯å¥½çš„é”»ç‚¼</p>
<p>Long distance runners sometimes train with weights strapped to their ankles or at high altitudes where the atmosphere is thin. When they later unburden themselves, the new relative ease of light limbs and oxygen-rich air enables them to run farther and faster.</p>
<p>Implementing a language is a real test of programming skill. The code is complex and performance critical. You must master recursion, dynamic arrays, trees, graphs, and hash tables. You probably use hash tables at least in your day-to-day programming, but do you really understand them?</p>
<p>While I intend to show you that an interpreter isnâ€™t as daunting as you might believe, implementing one well is still a challenge.</p>
<p>é•¿è·‘è¿åŠ¨å‘˜ä¼šåœ¨è®­ç»ƒæ—¶å€™ï¼Œåœ¨è„šè¸ä¸Šç»‘ä¸Šé‡ç‰©ï¼Œæˆ–è€…åœ¨é«˜æµ·æ‹”ã€ç©ºæ°”ç¨€è–„åœ°åŒºè®­ç»ƒã€‚å½“ä»–ä»¬å¸ä¸‹è´Ÿé‡æ—¶å€™ï¼Œç›¸å¯¹è½»æ¾çš„å››è‚¢å’Œæ­£å¸¸çš„æ°§æ°”ï¼Œä½¿å¾—ä»–ä»¬ï¼Œå¯ä»¥è·‘å¾—æ›´å¿«æ›´è¿œã€‚</p>
<p>å®ç°ä¸€é—¨è¯­è¨€æ˜¯å¯¹ç¼–ç¨‹æŠ€èƒ½çš„çœŸæ­£æµ‹è¯•ã€‚ä»£ç ä¼šéå¸¸å¤æ‚ï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿå¾ˆé‡è¦ã€‚ä½ å¿…é¡»æŒæ¡é€’å½’ç®—æ³•ã€åŠ¨æ€æ•°ç»„ã€æ ‘ã€å›¾å’Œå“ˆå¸Œè¡¨ã€‚å¯èƒ½ä½ æ¯æ—¥çš„ç¼–ç¨‹ä»£ç ä¸­éƒ½ä¼šä½¿ç”¨å“ˆå¸Œè¡¨ï¼Œä½†æ˜¯ä½ çœŸçš„ç†è§£å®ƒå—ï¼Ÿå¥½å§ï¼Œè®©æˆ‘ä»¬ä»å¤´å¼€å§‹ï¼Œæˆ‘ä¿è¯ä½ ä¸€å®šå¯ä»¥å­¦ä¼šçš„ã€‚</p>
<p>è™½ç„¶æˆ‘æƒ³å‘ä½ ä»¬å±•ç¤ºï¼Œç¼–è¯‘å™¨å¹¶ä¸åƒæˆ‘ä»¬è®¤ä¸ºçš„é‚£ä¹ˆå¯æ€•ï¼Œä½†æ˜¯å®ç°ä¸€ä¸ªå¥½çš„ç¼–è¯‘å™¨ä»ç„¶æ˜¯ä¸€ä¸ªæœ‰æŒ‘æˆ˜çš„ä»»åŠ¡ã€‚å½“ä½ åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œä½ ä¼šå˜å¾—æ›´åŠ å¼ºå¤§ï¼Œå¹¶ä¸”åœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­ï¼Œä½¿ç”¨æ•°æ®ç»“æ„å’Œç®—æ³•ä¼šæ›´åŠ ç†Ÿç»ƒã€‚</p>
<h3 id="13-one-more-reason"><a class="header" href="#13-one-more-reason">1.3 One more reason</a></h3>
<p>å¦ä¸€ä¸ªåŸå› </p>
<p>This last reason is hard for me to admit, because itâ€™s so close to my heart. Ever since I learned to program as a kid, I felt there was something magical about languages. When I first tapped out BASIC programs one key at a time I couldnâ€™t conceive how BASIC itself was made.</p>
<p>Later, the mixture of awe and terror on my college friendsâ€™ faces when talking about their compilers class was enough to convince me language hackers were a different breed of humanâ€”some sort of wizards granted privileged access to arcane arts.</p>
<p>Itâ€™s a charming image, but it has a darker side. I didnâ€™t feel like a wizard, so I was left thinking I lacked some inborn quality necessary to join the cabal. Though Iâ€™ve been fascinated by languages ever since I doodled made-up keywords in my school notebook, it took me decades to muster the courage to try to really learn them. </p>
<p>When I did finally start cobbling together my own little interpreters, I quickly learned that, of course, there is no magic at all.</p>
<p>There are a few techniques you donâ€™t often encounter outside of languages, and some parts are a little difficult.  But not more difficult than other obstacles youâ€™ve overcome. My hope is that if youâ€™ve felt intimidated by languages and this book helps you overcome that fear, maybe Iâ€™ll leave you just a tiny bit braver than you were before.</p>
<p>And, who knows, maybe you will make the next great language. Someone has to.</p>
<p>æœ€åä¸€ä¸ªåŸå› æˆ‘æœ¬äººå¾ˆéš¾æ‰¿è®¤ï¼Œå› ä¸ºå®ƒä¸€ç›´æ·±è—æˆ‘å¿ƒåº•ã€‚å½“æˆ‘å°æ—¶å€™å­¦ä¼šæ¥è§¦ç¼–ç¨‹ï¼Œæˆ‘å°±è§‰å¾—ç¼–ç¨‹è¯­è¨€éå¸¸ç¥å¥‡ã€‚å½“æˆ‘ç¬¬ä¸€æ¬¡ä¸€ä¸ªæŒ‰é”®ä¸€ä¸ªæŒ‰é”®æ•²å‡º BASIC ç¨‹åºæ—¶å€™ï¼Œæˆ‘æ— æ³•æƒ³è±¡ BASIC å†…éƒ¨æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚</p>
<p>åæ¥ï¼Œå½“æˆ‘çš„æœ‹å‹ä»¬è°ˆè®ºèµ·ç¼–è¯‘å™¨è¯¾ç¨‹æ—¶å€™ï¼Œä»–ä»¬è„¸ä¸Šå……æ»¡äº†æ•¬ç•å’Œææƒ§ï¼Œè¿™åŠ æ·±äº†æˆ‘çš„æƒ³æ³•ï¼šç¼–è¯‘å™¨é»‘å®¢æ˜¯å¦å¤–ä¸€ç§äººç±»ï¼Œä¸€äº›å·«å¸ˆæ‰èƒ½æ‹¥æœ‰çš„å¤©èµ‹ã€‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªè¿·äººçš„å½¢è±¡ï¼Œä½†æ˜¯å®ƒä¹Ÿæœ‰é»‘æš—çš„ä¸€é¢ï¼Œæˆ‘ä¸è§‰å¾—è‡ªå·±æ˜¯ä¸€ä¸ªå·«å¸ˆï¼Œæ‰€ä»¥æˆ‘ä¸è®¤ä¸ºè‡ªå·±æ‹¥æœ‰å·«å¸ˆçš„å¤©èµ‹ã€‚è™½ç„¶ä»æˆ‘åœ¨å­¦æ ¡ç¬”è®°æœ¬ä¸Šï¼Œä¹±å†™å…³é”®è¯æ—¶å€™ï¼Œå°±å¯¹äºç¼–ç¨‹è¯­è¨€ååˆ†ç€è¿·ï¼Œä½†æ˜¯ï¼Œæˆ‘èŠ±äº†å‡ åå¹´æ—¶é—´æ‰çœŸæ­£å¼€å§‹å­¦ä¹ ç¼–è¯‘å™¨ã€‚ç¼–è¯‘å™¨çš„é‚£ç§ç¥å¥‡ä¹‹å¤„ã€ä¸ç®€å•çš„æ„Ÿè§‰ï¼Œè®©æˆ‘ä¸€ç›´å¾˜å¾Šåœ¨é—¨å¤–ã€‚</p>
<p>å½“æˆ‘å¼€å§‹ç¼–å†™è‡ªå·±çš„ç¼–è¯‘å™¨æ—¶å€™ï¼Œå¾ˆå¿«å°±æ˜ç™½äº†ï¼Œè¿™ä¸ªé¢†åŸŸæ ¹æœ¬æ²¡æœ‰é­”æ³•ã€‚ä»…ä»…åªæ˜¯ä»£ç ï¼Œè¯†åˆ«ä»£ç çš„ä¹Ÿéƒ½æ˜¯æ™®é€šäººã€‚</p>
<p>æœ‰ä¸€äº›è¯­è¨€ä¹‹å¤–çš„æŠ€å·§ï¼Œæˆ‘ä»¬ä¸ä¼šç»å¸¸é‡åˆ°ï¼Œä½†æ˜¯è¿™ä¸€éƒ¨åˆ†æœ‰äº›éš¾åº¦ã€‚ä½†æ˜¯ï¼Œä¹Ÿä¸ä¼šæ¯”ä½ æ‰€å…‹æœçš„å…¶ä»–éšœç¢æ›´åŠ æ£˜æ‰‹ã€‚æˆ‘çš„å¸Œæœ›æ˜¯ï¼Œå¦‚æœä½ å’Œæˆ‘ä¸€æ ·ï¼Œå¯¹ç¼–è¯‘å™¨æ„Ÿåˆ°ææƒ§ï¼Œé‚£ä¹ˆè¿™æœ¬ä¹¦å°†å¸®åŠ©ä½ å…‹æœè¿™ä¸ªææƒ§ï¼Œä¹Ÿè®¸è¿™ä¹‹åï¼Œä½ å°†å˜å¾—æ›´åŠ å‹‡æ•¢ã€‚</p>
<p>æœ€åï¼Œä½ è¿˜å¯èƒ½æˆä¸ºä¸‹ä¸€ä¸ªä¼Ÿå¤§è¯­è¨€çš„åˆ›å§‹äººï¼Œå¿…é¡»æœ‰äººå»åšã€‚è°çŸ¥é“å‘¢ï¼Ÿ</p>
<h2 id="äºŒhow-the-book-is-organized"><a class="header" href="#äºŒhow-the-book-is-organized">äºŒã€How the book is organized</a></h2>
<p>æœ¬ä¹¦çš„ç»„ç»‡æ–¹å¼</p>
<p>This book is broken into three parts. You're reading the first one now. It's a couple of chapters to get you oriented, teach you some of the lingo that language hackers use, and introduce you to Lox, the language we'll be implementing.</p>
<p>Each of the other two parts builds one complete Lox interpreter. Within those parts, each chapter is structured the same way. The chapter takes a single language feature, tachers you the concepts bebind it, and walks you through an implementation.</p>
<p>It took a good bit of trial and error on my part, but I managed to carve up the two interpreters into chapter-sized chunks that build on the previous chapters but require nothing from later ones. From the very first chapter, you'll have a working program you can run and play with. With each passing chapter, it grows increasing full-featured until you eventually have a complete language.</p>
<p>Aside from copious, scintillating English prose, chapters have a few other delightful facets.</p>
<p>è¿™æœ¬ä¹¦å°†åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œç°åœ¨æ­£åœ¨é˜…è¯»çš„æ˜¯ç¬¬ä¸€éƒ¨åˆ†ã€‚è¿™å‡ ç« ä¼šè®©ä½ æœ‰ä¸€äº›æ–¹å‘æ„Ÿï¼Œæ•™ä½ ä½¿ç”¨é»‘å®¢å¸¸ç”¨çš„æœ¯è¯­ã€‚ç„¶åï¼Œä¼šä»‹ç»Loxè¯­è¨€ï¼Œæˆ‘ä»¬å°†è¦å®ç°çš„è¯­è¨€ã€‚</p>
<p>å…¶ä»–ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¼šåˆ†åˆ«å®ç°ä¸€ä¸ªå®Œæ•´çš„ç¼–è¯‘å™¨ã€‚åœ¨è¿™ä¸¤ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸€ç« çš„ç»“æ„éƒ½æ˜¯ç›¸åŒçš„ï¼Œæœ¬ç« èŠ‚é‡‡ç”¨å•ä¸€è¯­è¨€åŠŸèƒ½ï¼Œå‘æ‚¨ä»‹ç»èƒŒåçš„æ¦‚å¿µï¼Œå¹¶ä¸”å¼•å¯¼ä½ å»å®ç°è§£æå™¨ã€‚</p>
<p>å¯¹æˆ‘æ¥è¯´ï¼Œéœ€è¦ä¸€äº›å°è¯•å’Œè¯•é”™ï¼Œä½†æˆ‘è¿˜æ˜¯æŠŠä¸¤ä¸ªç¼–è¯‘å™¨åˆ†ä¸ºç« èŠ‚å¤§å°çš„éƒ¨åˆ†ï¼Œè¿™äº›ç« èŠ‚åŸºäºå‰é¢å‡ ç« çš„åŸºç¡€çŸ¥è¯†ï¼Œä¸éœ€è¦ç†è§£åé¢å‡ ç« çš„å†…å®¹ã€‚ä»ç¬¬ä¸€ç« å¼€å§‹ï¼Œä½ å°±æ‹¥æœ‰äº†ä¸€ä¸ªå¯ä»¥è¿è¡Œå’Œä½¿ç”¨çš„å·¥ä½œç¨‹åºã€‚éšç€æ›´å¤šç« èŠ‚çš„å­¦ä¹ ï¼Œè¿™ä¸ªå·¥ä½œç¨‹åºä¼šè¶Šæ¥è¶Šå…¨é¢ï¼Œç›´åˆ°æœ€ç»ˆï¼Œä½ ä¼šæ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„ç¼–ç¨‹è¯­è¨€ã€‚</p>
<p>é™¤äº†ä¸°å¯Œã€åä¸½çš„æ­£æ–‡å¤–ï¼Œæ¯ä¸ªç« èŠ‚è¿˜æœ‰ä¸€äº›ä»¤äººæ„‰å¿«çš„éƒ¨åˆ†ã€‚</p>
<h3 id="21-the-code"><a class="header" href="#21-the-code">2.1 The code</a></h3>
<p>We're about crafting interpreters, so this book contains real code. Every single line of code needed is included, and each snippet tells you where to insert it in your ever-growing implementation.</p>
<p>Many other language books and language implementations use tools like <a href="https://en.wikipedia.org/wiki/Lex_(software)">Lex</a> and <a href="https://en.wikipedia.org/wiki/Yacc">Yacc</a>, so-called <strong>compiler-compilers</strong>, that automatically generate some of the source files for an implementation from some higher-level description. There are pros and cons to tool like those, and strong opinionsâ€”â€”some might say religious convictions â€”â€” on both sides.</p>
<p>We will abstain from using them here. I want to ensure there are no dark corners where magic and confusion can hide, so weâ€™ll write everything by hand. As youâ€™ll see, itâ€™s not as bad as it sounds, and it means you really will understand each line of code and how both interpreters work.</p>
<p>A book has different constraints from the â€œreal worldâ€ and so the coding style here might not always reflect the best way to write maintainable production software. If I seem a little cavalier about, say, omitting private or declaring a global variable, understand I do so to keep the code easier on your eyes. The pages here arenâ€™t as wide as your IDE and every character counts.</p>
<p>Also, the code doesnâ€™t have many comments. Thatâ€™s because each handful of lines is surrounded by several paragraphs of honest-to-God prose explaining it. When you write a book to accompany your program, you are welcome to omit comments too. Otherwise, you should probably use // a little more than I do.</p>
<p>While the book contains every line of code and teaches what each means, it does not describe the machinery needed to compile and run the interpreter. I assume you can slap together a makefile or a project in your IDE of choice in order to get the code to run. </p>
<p>æˆ‘ä»¬æ˜¯ä»‹ç»ç¼–è¯‘å™¨çš„ï¼Œæ‰€ä»¥æœ¬ä¹¦ä¼šåŒ…å«çœŸæ˜¯å¯ç”¨çš„ä»£ç ã€‚æ¯è¡Œä»£ç ï¼Œæ¯ä¸ªä»£ç æ®µï¼Œéƒ½ä¼šå‘Šè¯‰ä½ å®ƒä»¬çš„ä½œç”¨å’Œåœ¨å®ç°çš„ä¸æ–­å®Œå–„çš„ç¼–è¯‘å™¨ä¸­çš„ä½ç½®ã€‚</p>
<p>è®¸å¤šå…¶ä»–è¯­è¨€ä¹¦ç±å’Œè¯­è¨€å®ç°ä¹¦ç±ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨ Lexï¼ŒYaccç­‰ç§°ä¸ºç¼–è¯‘ç¼–è¯‘å™¨çš„ç¼–è¯‘è¯­è¨€ï¼Œè¿™äº›è¯­è¨€ï¼Œå¯ä»¥ä»æ›´é«˜çº§çš„æè¿°ä¸­è‡ªåŠ¨ç”Ÿæˆæºæ–‡ä»¶ã€‚ ç›´æ¥ä½¿ç”¨è¿™äº›è¯­è¨€å·¥å…·ï¼Œæœ‰å¥½å¤„ä¹Ÿæœ‰å¼Šç«¯ï¼Œè€Œå¯¹äºè¿™ä¸¤ä¸ªè§‚ç‚¹ï¼Œéƒ½æœ‰å¾ˆå¤šå®—æ•™ä¿¡ä»°èˆ¬çš„æ‹¥è¶¸ã€‚</p>
<p>æœ¬ä¹¦ä¸­å°†é¿å…ä½¿ç”¨ç¼–è¯‘å™¨è¯­è¨€ï¼Œæˆ‘æƒ³è¦ç¡®ä¿æ²¡æœ‰é»‘æš—çš„è§’è½ï¼Œéšè—ç€ä¸€äº›é­”æ³•å’ŒæœªçŸ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ‰‹å†™æ‰€æœ‰å†…å®¹ã€‚æ­£å¦‚ä½ çœ‹åˆ°çš„ï¼Œè¿™å¹¶ä¸åƒå¬èµ·æ¥é‚£ä¹ˆç³Ÿç³•ï¼Œè¿™æ„å‘³ç€ä½ å°†çœŸæ­£ç†è§£æ¯ä¸€è¡Œä»£ç ï¼Œå¹¶ä¸”çœŸçš„ç†è§£è¿™ä¸¤ä¸ªç¼–è¯‘å™¨æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>ä¸€æœ¬ä¹¦ä¸åŒäºçœŸå®ä¸–ç•Œçš„çº¦æŸï¼Œå› æ­¤æœ¬ä¹¦çš„ç¼–ç é£æ ¼å¯èƒ½å¹¶ä¸æ˜¯ç¼–å†™å¯ç»´æŠ¤æ€§ç”Ÿäº§çº§åˆ«è½¯ä»¶çš„æœ€ä½³å®è·µã€‚å¦‚æœæˆ‘çœç•¥äº† private æˆ–è€… å¿½ç•¥äº†å…¨å±€å˜é‡å£°æ˜ï¼Œè¯·ç†è§£æˆ‘è¿™ä¹ˆåšæ˜¯ä¸ºäº†è®©ä»£ç æ›´åŠ å®¹æ˜“ç†è§£ï¼Œè€Œä¸æ˜¯æ¥æºäºå‚²æ…¢ã€‚è¿™é‡Œçš„é¡µé¢æ²¡æœ‰ IDE é‚£ä¹ˆå®½ï¼Œä½†æ˜¯å®ƒä»¬éƒ½éå¸¸é‡è¦ã€‚</p>
<p>æ­¤å¤–ï¼Œä»£ç æ²¡æœ‰å¤ªå¤šçš„æ³¨é‡Šï¼Œè¿™æ˜¯å› ä¸ºæ¯æ®µä»£ç ä¸Šä¸‹æ–‡ï¼Œéƒ½æ˜¯å¯¹å…¶çš„å¤§æ®µæ­£æ–‡è¯´æ˜ã€‚å½“ä½ è‡ªå·±ç¼–å†™ä¸€æœ¬ä»£ç å®ç°çš„ä¹¦ç±æ—¶å€™ï¼Œä¹Ÿæ¬¢è¿ä½ çœç•¥å…¶ä¸­çš„æ³¨é‡Šã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´å¤šçš„ //</p>
<p>è™½ç„¶è¿™æœ¬ä¹¦åŒ…å«äº†ç¼–è¯‘å™¨çš„æ¯ä¸€è¡Œä»£ç ï¼Œä»‹ç»äº†æ¯ä¸€è¡Œä»£ç çš„å«ä¹‰ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰æè¿°ç¼–è¯‘å’Œè¿è¡Œä»£ç çš„å…·ä½“æœºå™¨ä¿¡æ¯ã€‚æˆ‘é¢„æƒ³ä½ å¯ä»¥ä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„ IDE åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æˆ–æ˜¯ä¸€ä¸ªé¡¹ç›®ã€‚è¿™äº›å…·ä½“æœºå™¨è¯´æ˜å¾ˆå¿«å°±ä¼šè¿‡æ—¶ï¼Œæˆ‘å¸Œæœ›è¿™æœ¬ä¹¦å¯ä»¥åƒ XOç™½å…°åœ°ä¸€æ ·å†ä¹…å¼¥æ–°ï¼Œè€Œä¸æ˜¯åƒ backyard hoochï¼ˆä¸€ç›´ä¿è´¨æœŸä¸é•¿çš„èœ‚èœœé…’ï¼‰ä¸€æ ·å¾ˆå¿«è¿‡æ—¶ã€‚</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/yak.png?raw=true" alt="yak" /></p>
<blockquote>
<p>Yacc is a tool that takes in a grammar file and produces a source file for a compiler, so itâ€™s sort of like a â€œcompilerâ€ that outputs a compiler, which is where we get the term â€œcompiler-compilerâ€.</p>
<p>Yacc wasnâ€™t the first of its ilk, which is why itâ€™s named â€œYaccâ€â€”Yet Another Compiler-Compiler. A later similar tool is Bison, named as a pun on the pronunciation of Yacc like â€œyakâ€.</p>
<p>If you find all of these little self-references and puns charming and fun, youâ€™ll fit right in here. If not, well, maybe the language nerd sense of humor is an acquired taste.</p>
<p>Yacc æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥æ¥æ”¶è¯­æ³•æ–‡ä»¶ï¼Œç„¶åä¸ºç¼–è¯‘å™¨ç”Ÿæˆæºæ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œå®ƒå¥½åƒæ˜¯ä¸€ä¸ªå¯ä»¥è¾“å‡º&quot;ç¼–è¯‘å™¨&quot;çš„ç¼–è¯‘å™¨ï¼Œä¸€èˆ¬ä½¿ç”¨æœ¯è¯­&quot;ç¼–è¯‘å™¨ç¼–è¯‘ç¨‹åº&quot;å½¢å®¹ Yacc</p>
<p>Yaccå¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ª&quot;ç¼–è¯‘å™¨ç¼–è¯‘ç¨‹åº&quot;, è¿™å°±æ˜¯è¿™ä¸ªç¨‹åºç¼©å†™çš„æ¥æºï¼šå¦ä¸€ä¸ªç¼–è¯‘å™¨ç¼–è¯‘ç¨‹åºã€‚è¿˜æœ‰ä¸€ä¸ªç›¸ä¼¼çš„å·¥å…·ï¼Œç§°ä¸º Bisonï¼ˆé‡ç‰›), å‘½åæ¥æºäº Yaccçš„åŒå…³è¯­ yak ï¼ˆç‰¦ç‰›)ã€‚</p>
<p>å¦‚æœä½ å‘ç°ï¼Œè¿™äº›å°å°çš„è‡ªæˆ‘æš—ç¤ºå’ŒåŒå…³è¯­ï¼Œå¾ˆæœ‰é­…åŠ›å’Œä¹è¶£ï¼Œä½ å°†å¾ˆå¿«é€‚åº”è¿™é‡Œã€‚å¦‚æœä½ å¯¹æ­¤å¹¶ä¸æ„Ÿå†’ï¼Œå¯èƒ½ä¹¦å‘†å­çš„å¹½é»˜æ„Ÿæ˜¯åå¤©å…»æˆçš„ã€‚</p>
</blockquote>
<h3 id="22-snippets"><a class="header" href="#22-snippets">2.2 Snippets</a></h3>
<p>ä»£ç æ®µ</p>
<p>Since the book contains literally every line of code needed for the implementations, the snippets are quite precise. Also, because I try to keep the program in a runnable state even when major features are missing, sometimes we add temporary code that gets replaced in later snippets.</p>
<p>A snippet with all the bells and whistles looks like this:</p>
<p>In the center, you have the new code to add. It may have a few faded out lines above or below to show where it goes in the existing surrounding code. There is also a little blurb telling you in which file and where to place the snippet. If that blurb says â€œreplace _ linesâ€, there is some existing code between the faded lines that you need to remove and replace with the new snippet.</p>
<pre><code class="language-java">
	// lox/Scanner.java in scanToken() replace 1 line
	
	default:
        if (isDigit(c)) {
          number();
        } else {
          Lox.error(line, &quot;Unexpected character.&quot;);
        }
        break;
		
</code></pre>
<p>å› ä¸ºæœ¬ä¹¦ä¸­åŒ…å«æœ‰æ‰€æœ‰ç¼–è¯‘å™¨çš„å®ç°ä»£ç ï¼Œæ‰€ä»¥ä¹¦ä¸­æ¶‰åŠçš„ä»£ç æ®µéå¸¸å‡†ç¡®ã€‚æ­¤å¤–ï¼Œå› ä¸ºæˆ‘è¯•å›¾è®©ç¨‹åºå³ä½¿åœ¨ç¼ºå°‘ä¸»è¦åŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥ä¿æŒå¯è¿è¡ŒçŠ¶æ€ã€‚æ‰€ä»¥ï¼Œæœ‰æ—¶å€™æˆ‘ä¼šæ·»åŠ ä¸´æ—¶ä»£ç ï¼Œåœ¨ä¹‹åç« èŠ‚ä¼šæ›¿æ¢è¿™äº›ä¸´æ—¶ä»£ç ã€‚</p>
<p>ä»£ç æ®µç¤ºä¾‹å¦‚ä¸‹:</p>
<p>ä¸­é—´ä»£ç æ˜¯å®é™…è¦æ·»åŠ çš„ä»£ç ï¼Œä¸Šé¢å’Œä¸‹é¢çš„ä»£ç è¡¨ç¤ºè¦æ·»åŠ ä»£ç çš„ä½ç½®ã€‚è¿˜æœ‰ä¸€ä¸ªå°æç¤ºï¼Œå‘Šè¯‰ä½ è¿™æ®µä»£ç æ·»åŠ åˆ°å“ªä¸ªæ–‡ä»¶çš„å“ªä¸ªå‡½æ•°ä¸­ã€‚å¦‚ä½•å°æç¤ºä¸Šé¢å†™äº† &quot;æ›¿æ¢è¯¥è¡Œ&quot;, è¡¨ç¤ºæ–°å¢çš„ä»£ç éœ€è¦æ›¿æ¢ä¹‹å‰çš„ä»£ç ã€‚</p>
<h3 id="23-asides"><a class="header" href="#23-asides">2.3 Asides</a></h3>
<p>Asides contain biographical sketches, historical background, references to related topics, and suggestions of other areas to explore. Thereâ€™s nothing that you need to know in them to understand later parts of the book, so you can skip them if you want. I wonâ€™t judge you, but I might be a little sad.</p>
<p>Well, some asides do, at least. Most of them are just dumb jokes and amateurish drawings.</p>
<p>æ—ç™½åŒ…å«äº†ä¼ è®°å†å²ã€å†å²èƒŒæ™¯ã€ç›¸å…³ä¸»é¢˜çš„å‚è€ƒæ–‡çŒ®ä»¥åŠæ¨èçš„å»¶ä¼¸é˜…è¯»ã€‚å¦‚æœæ˜¯ä¸ºäº†é˜…è¯»åé¢ç« èŠ‚çš„å†…å®¹ï¼Œä½ ä¸éœ€è¦é˜…è¯»æ—ç™½ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥ç›´æ¥è·³è¿‡æ—ç™½ã€‚æˆ‘ä¸ä¼šæ‰¹è¯„ä½ ï¼Œä½†æ˜¯æˆ‘ä¼šæ„Ÿåˆ°éš¾è¿‡ ğŸ˜«ã€‚</p>
<p>å—¯ï¼Œè¿˜æœ‰äº›æ—ç™½ä¸å°½å¦‚äººæ„ï¼Œè¿™äº›æ—ç™½å¤§éƒ¨åˆ†éƒ½æ˜¯æ„šè ¢çš„ç¬‘è¯å’Œä¸šä½™æ°´å¹³çš„ç»˜ç”»ã€‚</p>
<h3 id="24-challenges"><a class="header" href="#24-challenges">2.4 Challenges</a></h3>
<p>Each chapter ends with a few exercises. Unlike textbook problem sets, which tend to review material you already covered, these are to help you learn more than whatâ€™s in the chapter. They force you to step off the guided path and explore on your own. They will make you research other languages, figure out how to implement features, or otherwise get you out of your comfort zone.</p>
<p>Vanquish the challenges and youâ€™ll come away with a broader understanding and possibly a few bumps and scrapes. Or skip them if you want to stay inside the comfy confines of the tour bus. Itâ€™s your book.</p>
<p>A word of warning: the challenges often ask you to make changes to the interpreter youâ€™re building. Youâ€™ll want to implement those in a copy of your code. The later chapters assume your interpreter is in a pristine (â€œunchallengedâ€?) state.</p>
<p>æ¯ä¸ªç« èŠ‚éƒ½ä»¥ä¸€äº›ç»ƒä¹ é¢˜ç»“æŸã€‚ä½†æ˜¯ä¸åŒäºæ•™ç§‘ä¹¦çš„ä¹ é¢˜é›†ï¼Œå®ƒä»¬é€šå¸¸è®©ä½ å¤ä¹ å·²ç»å­¦è¿‡çš„çŸ¥è¯†ï¼Œæœ¬ä¹¦çš„ä¹ é¢˜æ›´åŠ å€¾å‘äºè®©ä½ å­¦åˆ°æ›´å¤šçš„ä¸œè¥¿ã€‚è¿™äº›ä¹ é¢˜ä¼šè®©ä½ ç¦»å¼€ç« èŠ‚çš„å·²æœ‰è·¯å¾„ï¼Œç‹¬è‡ªæ¢ç´¢æ›´å¤šçš„æœªçŸ¥é¢†åŸŸã€‚å®ƒä»¬ä¼šè®©ä½ å»ç ”ç©¶å…¶ä»–è¯­è¨€ï¼Œå»å¯»æ‰¾å¦‚ä½•å®ç°åŠŸèƒ½ï¼Œæˆ–è€…è®©ä½ èµ°å‡ºèˆ’é€‚åŒºã€‚</p>
<p>æ¥å—ä¹ é¢˜é›†çš„æŒ‘æˆ˜ï¼Œå¹¶ä¸”æˆ˜èƒœå®ƒä»¬ï¼Œä½ å°†ä¼šæœ‰æ›´åŠ å¹¿é˜”çš„è§†é‡ï¼Œè™½ç„¶ä½ å¯èƒ½ä¼šé‡åˆ°ä¸€äº›åå·å’ŒæŒ«æŠ˜ã€‚å¦‚æœä½ æƒ³è¦å‘†åœ¨èˆ’æœçš„æ¸¸è§ˆè½¦å†…ï¼Œä½ ä¹Ÿå¯ä»¥è·³è¿‡è¿™äº›æŒ‘æˆ˜ä¹ é¢˜ï¼Œæ¯•ç«Ÿè¿™æ˜¯ä½ çš„ä¹¦ã€‚</p>
<p>ä¸€å¥è­¦å‘Šâš ï¸ï¼Œè¿™äº›æŒ‘æˆ˜é€šå¸¸ä¼šè¦æ±‚ä½ ä¿®æ”¹å·²æ„å»ºçš„ç¼–è¯‘å™¨ï¼Œå»ºè®®ä½ åœ¨å‰¯æœ¬é¡¹ç›®ä¸­å®ç°è¿™äº›æŒ‘æˆ˜ï¼Œæˆ‘ä»¬åé¢çš„ç« èŠ‚åŸºäºæ²¡æœ‰ä¿®æ”¹çš„ç¼–è¯‘å™¨ã€‚</p>
<h3 id="25-design-notes"><a class="header" href="#25-design-notes">2.5 Design notes</a></h3>
<p>è®¾è®¡æ€è·¯</p>
<p>Most â€œprogramming languageâ€ books are strictly programming language implementation books. They rarely discuss how one might happen to design the language being implemented. Implementation is fun because it is so precisely defined. We programmers seem to have an affinity for things that are black and white, ones and zeroes.</p>
<p>Personally, I think the world needs only so many implementations of FORTRAN 77. At some point, you find yourself designing a new language. Once you start playing that game, then the softer, human side of the equation becomes paramount.  Things like which features are easy to learn, how to balance innovation and familiarity, what syntax is more readable and to whom.</p>
<p>All of that stuff profoundly affects the success of your new language. I want your language to succeed, so in some chapters I end with a â€œdesign noteâ€, a little essay on some corner of the human aspect of programming languages. Iâ€™m no expert on thisâ€”I donâ€™t know if anyone really isâ€”so take these with a large pinch of salt. That should make them tastier food for thought, which is my main aim.</p>
<p>I know a lot of language hackers whose careers are based on this. You slide a language spec under their door, wait a few months, and code and benchmark results come out. Hopefully your new language doesnâ€™t hardcode assumptions about the width of a punched card into its grammar.</p>
<p>å¤§å¤šæ•°çš„ç¼–ç¨‹è¯­è¨€ä¹¦ç±ï¼Œéƒ½æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„ç¼–å†™ä»£ç å®ç°ï¼Œä»–ä»¬å¾ˆå°‘è®¨è®ºå¦‚ä½•è®¾è®¡ä¸€é—¨è¯­è¨€ã€è®¾è®¡ä¸€æ®µå®ç°ã€‚å®ç°éå¸¸æœ‰è¶£ï¼Œå› ä¸ºå®ƒæ˜¯ç¡®å®šçš„ï¼Œè€Œä¸”è¢«ç²¾ç¡®å®šä¹‰ã€‚æˆ‘ä»¬ç¨‹åºå‘˜ä¼¼ä¹å¯¹äºç¡®å®šæ€§çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ï¼šé»‘ä¸ç™½ï¼Œ1ä¸0ï¼Œå¤©ç”Ÿæœ‰å¥½æ„Ÿã€‚</p>
<p>å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘è®¤ä¸ºä¸–ç•Œä¸Šåªéœ€è¦ Fortran77 ï¼ˆ1976å¹´ï¼Œç¾å›½æ ‡å‡†åŒ–åä¼šé‡æ–°å¯¹Fortranï¼ˆx3.9-1966ï¼‰è¿›è¡Œäº†è¯„ä¼°ï¼Œå…¬å¸ƒäº†æ–°çš„Fortranæ ‡å‡†ï¼Œä¹Ÿå°±æ˜¯Fortran 77ã€‚Fortran 77æ˜¯å…·æœ‰ç»“æ„åŒ–ç‰¹æ€§çš„ç¼–ç¨‹è¯­è¨€ã€‚Fortran77åœ¨çŸ­æ—¶é—´å†…è·å–äº†å·¨å¤§çš„æˆåŠŸï¼Œå¹¿æ³›åœ°åº”ç”¨äºç§‘å­¦å’Œå·¥ç¨‹è®¡ç®—ï¼Œå‡ ä¹ç»Ÿæ²»äº†æ•°å€¼è®¡ç®—é¢†åŸŸã€‚ï¼‰ä¸­å®ç°çš„åŠŸèƒ½ã€‚ä½†æ˜¯åœ¨æŸäº›æ—¶å€™ï¼Œä½ å‘ç°è‡ªå·±åœ¨è®¾è®¡ä¸€é—¨æ–°è¯­è¨€ã€‚ä¸€æ—¦ä½ å¼€å§‹è®¾è®¡è¯­è¨€è¿™ä¸ªæ¸¸æˆï¼Œé‚£ä¹ˆäººæ€§åŒ–çš„ä¸€é¢å˜å¾—éå¸¸é‡è¦ã€‚éœ€è¦è€ƒè™‘æ›´åŠ å…·ä½“çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šå“ªäº›åŠŸèƒ½æ›´æ˜“äºå­¦ä¹ ï¼Œå¦‚ä½•å¹³è¡¡åˆ›æ–°å’Œä¿ç•™ï¼Œå“ªäº›è¯­æ³•æ›´æ˜“äºé˜…è¯»ï¼Œå­¦ä¹ è¯­è¨€çš„äººç¾¤æ˜¯è°ï¼Ÿ</p>
<p>æ‰€æœ‰è¿™äº›éƒ½æ·±åˆ»çš„å½±å“ç€ä¸€é—¨æ–°è¯­è¨€çš„æˆåŠŸä¸å¦ã€‚æˆ‘å¸Œæœ›ä½ çš„æ–°è¯­è¨€å¯ä»¥æˆåŠŸï¼Œæ‰€ä»¥æˆ‘ä¼šåœ¨æŸäº›ç« èŠ‚çš„ç»“å°¾ï¼Œå‘è¡¨ä¸€äº›è®¾è®¡æ–¹é¢çš„æ€è€ƒï¼Œè¿™æ˜¯ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­äººä»¬è®¾è®¡çš„æœ€ä½³å®è·µã€‚æˆ‘ä¸æ˜¯è®¾è®¡æ–¹é¢çš„ä¸“å®¶ï¼Œä¸çŸ¥é“æ˜¯å¦æœ‰äººçœŸçš„è¿™ä¹ˆæƒ³â€”åœ¨ä¸€äº›ç¼–ç¨‹è¯­è¨€çš„æ­£æ–‡ä¸­ï¼Œæ·»åŠ ä¸€äº›è®¾è®¡æ–¹é¢çš„å†…å®¹ã€‚è¿™åº”è¯¥ä¼šè®©è®¾è®¡å†…å®¹ç§°ä¸ºæ›´åŠ ç¾å‘³çš„æ€æƒ³é£Ÿç²®ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘çš„ä¸»è¦ç›®æ ‡ã€‚</p>
<p>æˆ‘è®¤è¯†å¾ˆå¤šç¼–ç¨‹è€æ‰‹ï¼Œä»–ä»¬çš„èŒä¸šå°±åœ¨äºæ­¤â€”â€”ä½ å°†ä¸€é—¨è¯­è¨€çš„è§„èŒƒå‘ŠçŸ¥ä»–ä»¬ï¼Œç­‰å¾…å‡ ä¸ªæœˆï¼Œä½ å°†ä¼šå¾—åˆ°è¿™é—¨æ–°è¯­è¨€çš„ä»£ç å’ŒåŸºå‡†æµ‹è¯•ç»“æœã€‚å¸Œæœ›ä½ çš„æ–°è¯­è¨€ï¼Œä¸ä¼šå°†ç©¿å­”çº¸çš„å®½åº¦ä¿¡æ¯ï¼Œç¡¬ç¼–ç åˆ°è¯­è¨€è¯­æ³•ä¸­ã€‚</p>
<h2 id="ä¸‰the-first-interpreter"><a class="header" href="#ä¸‰the-first-interpreter">ä¸‰ã€The First Interpreter</a></h2>
<p>ç¬¬ä¸€ä¸ªç¼–è¯‘å™¨</p>
<p>Weâ€™ll write our first interpreter, jlox, in Java. The focus is on concepts. Weâ€™ll write the simplest, cleanest code we can to correctly implement the semantics of the language. This will get us comfortable with the basic techniques and also hone our understanding of exactly how the language is supposed to behave.</p>
<p>The book uses Java and C, but readers have ported the code to many other languages. If the languages I picked arenâ€™t your bag, take a look at those.</p>
<p>Java is a great language for this. Itâ€™s high level enough that we donâ€™t get overwhelmed by fiddly implementation details, but itâ€™s still pretty explicit. Unlike in scripting languages, there tends to be less complex machinery hiding under the hood, and youâ€™ve got static types to see what data structures youâ€™re working with.</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨JAVAè¯­è¨€å®ç°ç¬¬ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œjloxï¼Œç¬¬ä¸€ä¸ªç¼–è¯‘å™¨çš„é‡ç‚¹æ˜¯åŸºæœ¬æ¦‚å¿µï¼Œæˆ‘ä»¬å°†ç¼–å†™æœ€ç®€æ´ã€æœ€åŸºç¡€çš„ä»£ç ï¼Œå®ç°ç¼–è¯‘å™¨çš„è¯­ä¹‰ã€‚è¿™å°†è®©æˆ‘ä»¬ç†Ÿæ‚‰åŸºæœ¬çš„æŠ€æœ¯ï¼Œè®©æˆ‘ä»¬èƒ½æ›´åŠ å‡†ç¡®ç†è§£è¯­è¨€è¡Œä¸ºã€‚</p>
<p>æœ¬ä¹¦å°†ä½¿ç”¨ JAVA, Cè¯­è¨€ï¼Œä½†æ˜¯è¯»è€…å¯èƒ½æ›´åŠ ç†Ÿæ‚‰å…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ï¼Œå¦‚æœæˆ‘ä½¿ç”¨çš„è¯­è¨€ä¸æ˜¯ä½ çš„èœï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ä½ æœ€ç†Ÿæ‚‰çš„è¯­è¨€ã€‚</p>
<p>JAVAæ˜¯ä¸€é—¨å¾ˆå¥½çš„è¯­è¨€ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨åº•å±‚çš„å¤§é‡å®ç°ç»†èŠ‚ï¼Œå› ä¸ºJAVAæ˜¯ä¸€é—¨é«˜çº§è¯­è¨€ï¼Œæ‹¥æœ‰æ›´å¤šçš„ç¡®å®šæ€§ã€‚å’Œè„šæœ¬è¯­è¨€ä¸åŒçš„æ˜¯ï¼ŒJAVAä¸ä¸åŒæœºå™¨çš„å…³è”æ€§å¹¶æ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Œé€šå¸¸ï¼Œä½ å¯ä»¥ä½¿ç”¨é™æ€ç±»å‹å»è·å–æŸ¥çœ‹å½“å‰æ­£åœ¨ä½¿ç”¨çš„ç»“æ„ä½“ã€‚</p>
<p>I also chose Java specifically because it is an object-oriented language.  That paradigm swept the programming world in the â€™90s and is now the dominant way of thinking for millions of programmers. Odds are good youâ€™re already used to organizing code into classes and methods, so weâ€™ll keep you in that comfort zone.</p>
<p>While academic language folks sometimes look down on object-oriented languages, the reality is that they are widely used even for language work. GCC and LLVM are written in C++, as are most JavaScript virtual machines. Object-oriented languages are ubiquitous, and the tools and compilers for a language are often written in the same language.</p>
<p>And, finally, Java is hugely popular. That means thereâ€™s a good chance you already know it, so thereâ€™s less for you to learn to get going in the book. If you arenâ€™t that familiar with Java, donâ€™t freak out. I try to stick to a fairly minimal subset of it.  I use the diamond operator from Java 7 to make things a little more terse,  but thatâ€™s about it as far as â€œadvancedâ€ features go. If you know another object-oriented language, like C# or C++, you can muddle through.</p>
<p>By the end of part II, weâ€™ll have a simple, readable implementation. Itâ€™s not very fast, but itâ€™s correct. However, we are only able to accomplish that by building on the Java virtual machineâ€™s own runtime facilities. We want to learn how Java itself implements those things.</p>
<p>æˆ‘ä»¬é€‰æ‹©Javaï¼Œè¿˜å› ä¸ºå®ƒæ˜¯ä¸€é—¨é¢å‘å¯¹è±¡çš„è¯­è¨€ã€‚è¿™ç§ç¼–ç¨‹èŒƒå¼åœ¨90å¹´ä»£å¸­å·äº†æ•´ä¸ªä¸–ç•Œï¼Œç°åœ¨ä¹Ÿæ˜¯æ•°ç™¾ä¸‡ç¨‹åºå‘˜çš„ä¸»æµæ€ç»´æ–¹å¼ã€‚å¾ˆå¯èƒ½ä½ å·²ç»ä¹ æƒ¯äº†å°†ä»£ç ç»„ç»‡æˆç±»å’Œæ–¹æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¹Ÿä¼šè®©ä½ å¤„äºèˆ’é€‚åŒºä¸­ã€‚</p>
<p>è™½ç„¶ï¼Œå­¦æœ¯ç ”ç©¶è¯­è¨€çš„äººä»¬ï¼Œæœ‰æ—¶å€™çœ‹ä¸èµ·é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œä½†æ˜¯å®é™…æƒ…å†µæ˜¯ï¼Œå³ä½¿åœ¨ä»–ä»¬æ—¥å¸¸ç¼–ç¨‹å·¥ä½œä¸­ï¼Œä¹Ÿä¼šå¹¿æ³›ä½¿ç”¨é¢å‘å¯¹è±¡è¯­è¨€ã€‚GCC/LLVM è¿˜æœ‰å¤§å¤šæ•°çš„ JavaScript è™šæ‹Ÿæœºéƒ½æ˜¯ä½¿ç”¨é¢å‘å¯¹è±¡çš„C++è¯­è¨€å®ç°çš„ã€‚é¢å‘å¯¹è±¡è¯­è¨€æ— å¤„ä¸åœ¨ï¼Œä¸€é—¨è¯­è¨€çš„ç¼–è¯‘å™¨å’Œå·¥å…·ï¼Œé€šå¸¸ä¼šä½¿ç”¨ç›¸åŒçš„è¯­è¨€å®ç°ã€‚</p>
<p>æœ€åï¼ŒJavaéå¸¸æµè¡Œã€‚è¿™æ„å‘³ç€ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½æœºä¼šå»ä½¿ç”¨ç†Ÿæ‚‰è¿™é—¨è¯­è¨€ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰Javaï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œæœ¬ä¹¦ä¸­åªä¼šä½¿ç”¨ä¸€å°éƒ¨åˆ†åŠŸèƒ½ï¼Œæˆ‘å°†ä½¿ç”¨Java7 æ ‡å‡†é‡Œé¢çš„è¿ç®—ç¬¦ï¼Œç›¸å¯¹äºä½¿ç”¨æ›´å¤šçš„é«˜çº§ç”¨æ³•ï¼Œè¿™ä¼šè®©ç¼–ç¨‹å˜å¾—æ›´åŠ ç®€æ´ã€‚å¦‚æœä½ è¿˜ç†Ÿæ‚‰å…¶ä»–çš„é¢å‘å¯¹è±¡è¯­è¨€ï¼Œä¾‹å¦‚: C#, C++, ä½ ä¹Ÿå¯ä»¥å°è¯•ä½¿ç”¨å®ƒä»¬å»å®ç°ç¼–è¯‘å™¨ã€‚</p>
<p>åœ¨ç¬¬äºŒéƒ¨åˆ†ç»“æŸæ—¶å€™ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªç®€å•æ˜“è¯»çš„ç¼–è¯‘å™¨å®ç°ï¼Œå®ƒçš„è¿è¡Œæ€§èƒ½ä¸æ˜¯å¾ˆé«˜ï¼Œä½†æ˜¯å¯ä»¥ä¿è¯å‡†ç¡®æ€§ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å®ç°çš„ç¼–è¯‘å™¨ï¼Œæ˜¯åŸºäºJava è¯­è¨€å’Œ Java è™šæ‹Ÿæœºåº•å±‚ã€‚æˆ‘ä»¬æƒ³è¦äº†è§£ Javaæœ¬èº«æ˜¯å¦‚ä½•å®ç°è¿™äº›åŠŸèƒ½çš„ã€‚</p>
<p>A compiler reads files in one language, translates them, and outputs files in another language.
You can implement a compiler in any language, including the same language it compiles, a process called self-hosting.</p>
<p>You canâ€™t compile your compiler using itself yet, but if you have another compiler for your language written in some other language, you use that one to compile your compiler once. Now you can use the compiled version of your own compiler to compile future versions of itself, and you can discard the original one compiled from the other compiler. This is called bootstrapping, from the image of pulling yourself up by your own bootstraps.</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/bootstrap.png?raw=true" alt="bootstraps" /></p>
<p>ç¼–è¯‘å™¨è¯»å–ä¸€ç§è¯­è¨€çš„åŸå§‹æ–‡ä»¶ï¼Œç¿»è¯‘å®ƒä»¬ï¼Œç„¶åè¾“å‡ºå¦å¤–ä¸€é—¨è¯­è¨€çš„æ–‡ä»¶ã€‚ä½ å¯ä»¥ç”¨ä»»ä½•è¯­è¨€å®ç°ç¼–è¯‘å™¨ï¼Œç”šè‡³ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯­è¨€å»å®ç°è¯¥è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œè¿™é€šå¸¸è¢«ç§°ä¸ºè‡ªç¼–è¯‘ã€‚</p>
<p>ä¸€å¼€å§‹ï¼Œä½ æ— æ³•ä½¿ç”¨ç›¸åŒçš„è¯­è¨€å†™æˆä¸€ä¸ªç¼–è¯‘å™¨ï¼Œä½†æ˜¯å¦‚æœä½ å·²ç»ä½¿ç”¨è¿‡å…¶ä»–è¯­è¨€å®ç°äº†æ–°è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥ä½¿ç”¨å·²ç»å®ç°çš„ç¼–è¯‘å™¨ï¼Œå»ç¼–è¯‘ä¸€æ¬¡ï¼Œç„¶åä½ å¯ä»¥è·å–åˆ°ä½¿ç”¨æ–°è¯­è¨€å®ç°çš„ç¼–è¯‘å™¨ã€‚æ¥ä¸‹æ¥ï¼Œä½ å¯ä»¥æ„‰å¿«çš„ä½¿ç”¨æ–°çš„ç¼–è¯‘å™¨ï¼Œå»å‡çº§æ–°çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥æ‰”æ‰ä¹‹å‰çš„å…¶ä»–è¯­è¨€å†™æˆçš„ç¼–è¯‘å™¨äº†ã€‚ä¸“ä¸šæœ¯è¯­ä¸€èˆ¬ç§°ä¸ºè‡ªä¸¾ï¼Œå›¾ä¸­å½¢è±¡çš„æè¿°äº†ä¸€ä¸ªäººçš„è‡ªä¸¾ã€‚</p>
<h2 id="å››the-second-interpreter"><a class="header" href="#å››the-second-interpreter">å››ã€The Second Interpreter</a></h2>
<p>ç¬¬äºŒä¸ªç¼–è¯‘å™¨</p>
<p>So in the next part, we start all over again, but this time in C. C is the perfect language for understanding how an implementation really works, all the way down to the bytes in memory and the code flowing through the CPU.</p>
<p>A big reason that weâ€™re using C is so I can show you things C is particularly good at, but that does mean youâ€™ll need to be pretty comfortable with it. You donâ€™t have to be the reincarnation of Dennis Ritchie, but you shouldnâ€™t be spooked by pointers either.</p>
<p>If you arenâ€™t there yet, pick up an introductory book on C and chew through it, then come back here when youâ€™re done. In return, youâ€™ll come away from this book an even stronger C programmer. Thatâ€™s useful given how many language implementations are written in C: Lua, CPython, and Rubyâ€™s MRI, to name a few.</p>
<p>In our C interpreter, clox, we are forced to implement for ourselves all the things Java gave us for free. Weâ€™ll write our own dynamic array and hash table. Weâ€™ll decide how objects are represented in memory, and build a garbage collector to reclaim them.</p>
<blockquote>
<p>I pronounce the name like â€œsea-locksâ€, but you can say it â€œclocksâ€ or even â€œclochâ€, where you pronounce the â€œxâ€ like the Greeks do if it makes you happy.</p>
<p>æˆ‘æŠŠè¿™ä¸ªåå­—è¯»æˆ&quot;sea-locks&quot;, ä½†æ˜¯ä½ ä¹Ÿå¯ä»¥è¯»æˆï¼Œ&quot;clocks&quot; æˆ–è€… &quot;cloch&quot;, å¦‚æœä½ å¼€å¿ƒçš„è¯ï¼Œè¿˜å¯ä»¥åƒå¸Œè…Šäººä¸€æ ·è¯» &quot;x&quot;</p>
</blockquote>
<p>Our Java implementation was focused on being correct. Now that we have that down, weâ€™ll turn to also being fast. Our C interpreter will contain a compiler that translates Lox to an efficient bytecode representation (donâ€™t worry, Iâ€™ll get into what that means soon), which it then executes. This is the same technique used by implementations of Lua, Python, Ruby, PHP, and many other successful languages.</p>
<blockquote>
<p>Did you think this was just an interpreter book? Itâ€™s a compiler book as well. Two for the price of one!</p>
<p>ä½ è®¤ä¸ºè¿™åªæ˜¯ä¸€æœ¬è§£é‡Šå™¨ä»‹ç»ä¹¦ç±å—ï¼Œå…¶å®å®ƒè¿˜æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ä»‹ç»ä¹¦ç±ã€‚è¿™ä¸¤è€…æ²¡æœ‰æœ¬è´¨åŒºåˆ«ã€‚</p>
</blockquote>
<p>Weâ€™ll even try our hand at benchmarking and optimization. By the end, weâ€™ll have a robust, accurate, fast interpreter for our language, able to keep up with other professional caliber implementations out there. Not bad for one book and a few thousand lines of code.</p>
<p>åœ¨ä¸‹ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†ä»å¤´å¼€å§‹ï¼Œä½†æ˜¯è¿™ä¸€æ¬¡å°†ä½¿ç”¨Cè¯­è¨€ã€‚Cè¯­è¨€å¯ä»¥è®©æˆ‘ä»¬æ›´å¥½çš„ç†è§£è®¡ç®—æœºæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œæ·±å…¥åˆ°åº•å±‚ï¼Œä¾‹å¦‚ï¼šå†…å­˜ä¸­çš„å­—èŠ‚å’Œ cpu æ‰§è¡Œçš„ä»£ç ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨Cè¯­è¨€å®ç°ç¼–è¯‘å™¨ï¼Œçš„ä¸€ä¸ªé‡è¦åŸå› æ˜¯ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨Cè¯­è¨€ä¸€äº›ç‰¹åˆ«æ“…é•¿çš„åŠŸèƒ½ï¼Œä½†æ˜¯è¿™ä¹Ÿæ„å‘³ç€ä½ å¿…é¡»éå¸¸ç†Ÿæ‚‰Cè¯­è¨€ã€‚ä½ ä¸éœ€è¦åƒåˆ›å§‹äºº Dennis Ritchie ä¸€æ ·ç†Ÿæ‚‰ Cè¯­è¨€ï¼Œä½†æ˜¯ä½ è‡³å°‘ä¸èƒ½è¢«æŒ‡é’ˆå“å€’ã€‚</p>
<p>å¦‚æœä½ è¿˜ä¸å¤ªäº†è§£Cè¯­è¨€ï¼Œé‚£ä¹ˆå…ˆæ‹¿èµ·ä¸€æœ¬Cè¯­è¨€å…¥é—¨ä¹¦ç±ä»”ç»†é˜…è¯»åï¼Œå†å›åˆ°è¿™é‡Œã€‚ä½œä¸ºå›æŠ¥ï¼Œä½ å°†å˜æˆä¸€ä¸ªæ›´å¼ºå¤§çš„Cè¯­è¨€ç¨‹åºå‘˜ã€‚ä½ å¯ä»¥å…ˆçœ‹çœ‹æœ‰å“ªäº›è¯­è¨€æ˜¯åŸºäºCè¯­è¨€å®ç°çš„ï¼šLuaï¼ŒCPythonï¼ŒRubyçš„MRIå®ç°ï¼Œç­‰ç­‰ã€‚</p>
<p>åœ¨Cè¯­è¨€å®ç°çš„è§£é‡Šå™¨ clox ä¸­ï¼Œæˆ‘ä»¬å°†è¦å®ç°ä¸€äº› Javaä¸­åŸç”Ÿå­˜åœ¨çš„ç»“æ„ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬å°†å®ç°åŠ¨æ€æ•°ç»„å’Œå“ˆå¸Œè¡¨ï¼Œæˆ‘ä»¬å°†è®¾è®¡å†³å®šå¦‚ä½•åœ¨å†…å­˜ä¸­è¡¨ç¤ºå¯¹è±¡ï¼Œå¹¶ä¸”æ„å»ºåƒåœ¾é‡‡é›†å™¨å›æ”¶å®ƒä»¬ã€‚</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨Javaè¯­è¨€å®ç°çš„ç¼–è¯‘å™¨ jloxä¸»è¦ä¸“æ³¨äºå‡†ç¡®æ€§ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†å‡†ç¡®æ€§ï¼Œæ¥ä¸‹æ¥å°†ä¸“æ³¨äºæ€§èƒ½ã€‚æˆ‘ä»¬çš„cloxè§£é‡Šå™¨ï¼Œå°†å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå°†lox ç¼–è¯‘ä¸ºæœ‰æ•ˆçš„å­—èŠ‚ç ï¼ˆåˆ«æ‹…å¿ƒï¼Œå¾ˆå¿«æˆ‘å°†è§£é‡Šå®ƒæ˜¯ä»€ä¹ˆï¼‰ï¼Œç„¶åæ‰§è¡Œå­—èŠ‚ç ã€‚è¿™ä¸å…¶ä»–è¯­è¨€çš„å®ç°ä½¿ç”¨ç›¸åŒæŠ€æœ¯ï¼Œä¾‹å¦‚ï¼šLuaï¼ŒPythonï¼ŒRubyï¼ŒPHPç­‰ç­‰ã€‚</p>
<p>æˆ‘ä»¬ç”šè‡³ä¼šå°è¯•åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–ã€‚åˆ°æœ€åï¼Œæˆ‘ä»¬å°†å®ç°ä¸€ä¸ªå¼ºå¤§ã€å‡†ç¡®ã€å¿«é€Ÿçš„è¯­è¨€è§£é‡Šå™¨ï¼Œèƒ½å¤Ÿå’Œå…¶ä»–ä¸“ä¸šçº§åˆ«çš„è¯­è¨€åª²ç¾ï¼Œè€Œè¿™å¯¹äºä¸€æœ¬ä¹¦å’Œå‡ åƒè¡Œä»£ç è€Œè¨€ï¼Œå¹¶ä¸ç®€å•ã€‚</p>
<h2 id="äº”-challenges"><a class="header" href="#äº”-challenges">äº”ã€ Challenges</a></h2>
<p>ä¹ é¢˜</p>
<ol>
<li>
<p>There are at least siz domain-specific languages used in the <a href="https://github.com/munificent/craftinginterpreters">little system I cobbled together</a> to write and publish this book. What are they?</p>
<p>åœ¨æˆ‘ç¼–å†™æœ¬ä¹¦ä¸­ï¼Œè‡³å°‘ä½¿ç”¨äº†6ç§å°ä¼—è¯­è¨€ï¼Œè¯·åˆ—ä¸¾ä¸­å®ƒä»¬ï¼Ÿ</p>
</li>
<li>
<p>Get a &quot;Hello, world!&quot; program written and running in Java. Set up whatever makefiles or IDE projects you need to get it working. If you have a debugger, get comfortable with it and step through your program as it runs.</p>
<p>ä½¿ç”¨ Javaè¯­è¨€å®ç°ä¸€ä¸ª &quot;hello, world&quot; ç¨‹åºï¼Œæè¿°ä¸€ä¸‹ä½ ä½¿ç”¨çš„IDE å’Œé…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨IDEä¸­ä¹ æƒ¯è°ƒè¯•ã€‚</p>
</li>
<li>
<p>Do the same thing for C. To get some practice with pointers, define a <a href="https://en.wikipedia.org/wiki/Doubly_linked_list">doubly linked list</a> of heap-allocated strings. Write functions to insert, find, and delete items from it. Test them.</p>
<p>ä½¿ç”¨Cè¯­è¨€å®ç°ä¸€ä¸ª &quot;hello, world&quot; ç¨‹åºï¼Œä¸ºäº†ç»ƒä¹ æŒ‡é’ˆï¼Œå®šä¹‰ä¸€ä¸ªå †åˆ†é…å­—ç¬¦ä¸²çš„åŒé“¾è¡¨ï¼Œç¼–å†™å‡½æ•°æ’å…¥ã€æŸ¥æ‰¾ã€åˆ é™¤é“¾è¡¨å…ƒç´ ã€‚</p>
</li>
</ol>
<h2 id="å…­design-note-whats-in-a-name"><a class="header" href="#å…­design-note-whats-in-a-name">å…­ã€Design Note: What's in a name?</a></h2>
<p>è®¾è®¡è¯´æ˜ï¼šå¦‚ä½•å‘½åï¼Ÿ</p>
<p>One of the hardest challenges in writing book was coming up with a name for the language it implements. I went through pages of candidates before I found one that worked. As you'll discover on the first day you start building your own language, naming is deviously hard. A good name satisfies a few criteria:</p>
<ol>
<li>
<p>It isn't in use.</p>
<p>You can run into all sorts of trouble, legal and social, if you inadvertently step on someone elseâ€™s name.</p>
</li>
<li>
<p>It's easy to pronounce. If things go well, hordes of people will be saying and writing your languageâ€™s name. Anything longer than a couple of syllables or a handful of letters will annoy them to no end.</p>
</li>
<li>
<p>It's distinct enough to search for. People will Google your languageâ€™s name to learn about it, so you want a word thatâ€™s rare enough that most results point to your docs. Though, with the amount of AI search engines are packing today, thatâ€™s less of an issue. Still, you wonâ€™t be doing your users any favors if you name your language â€œforâ€.</p>
</li>
<li>
<p>It doesn't have negative connotations across a number of cultures. This is hard to be on guard for, but itâ€™s worth considering. The designer of Nimrod ended up renaming his language to â€œNimâ€ because too many people remember that Bugs Bunny used â€œNimrodâ€ as an insult. (Bugs was using it ironically.)</p>
</li>
</ol>
<p>If your potential name makes it through that gauntlet, keep it. Donâ€™t get hung up on trying to find an appellation that captures the quintessence of your language.</p>
<p>æœ¬ä¹¦ç¼–å†™è¿‡ç¨‹ä¸­ä¸€ä¸ªæŒ‘æˆ˜æ˜¯ï¼Œå¦‚ä½•ä¸ºå®ç°çš„è¯­è¨€å‘½åã€‚æˆ‘éœ€è¦ä»ä¼—å¤šçš„å€™é€‰ä¸­ï¼Œæ‰¾åˆ°æœ€åˆé€‚çš„ã€‚æ­£å¦‚ä½ åœ¨æ„å»ºè‡ªå·±è¯­è¨€æ—¶å€™ä¼šé‡åˆ°çš„ä¸€æ ·ï¼Œå‘½åéå¸¸å›°éš¾ï¼Œä¸€ä¸ªå¥½çš„å‘½åç¬¦åˆä¸‹é¢çš„æ ‡å‡†ï¼š</p>
<ol>
<li>
<p>è¯¥åå­—ä¹‹å‰æ²¡æœ‰è¢«ä½¿ç”¨ã€‚å¦‚æœä½ ä¸å°å¿ƒä½¿ç”¨äº†ä»–äººçš„å‘½åï¼Œå¯èƒ½ä¼šæœ‰éå¸¸å¤šçš„éº»çƒ¦ï¼ŒåŒ…å«æ³•å¾‹å’Œç¤¾ä¼šé—®é¢˜ã€‚</p>
</li>
<li>
<p>è¯¥åå­—éœ€è¦æœ—æœ—ä¸Šå£ï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¼šæœ‰éå¸¸å¤šäººä¹¦å†™ã€è¯´å‡ºä½ çš„è¯­è¨€åç§°ï¼Œè€Œä»»ä½•æ‹—å£çš„åå­—ï¼Œéƒ½ä¼šç»™äººä»¬å¸¦æ¥å›°æƒ‘ã€‚</p>
</li>
<li>
<p>è¯¥åå­—éœ€è¦è¶³å¤Ÿç‰¹åˆ«ï¼Œæ›´å®¹æ˜“æœç´¢åˆ°ã€‚äººä»¬ç¬¬ä¸€æ—¶é—´ä¼šä½¿ç”¨æœç´¢å¼•æ“äº†è§£ä½ çš„è¯­è¨€ï¼Œå¦‚æœä½ ä½¿ç”¨ä¸€ä¸ªè¶³å¤Ÿç‰¹åˆ«çš„å•è¯å‘½åï¼Œé‚£ä¹ˆå¤§å®¶å°†å¾ˆå®¹æ˜“è·å–åˆ°ã€‚å°½ç®¡ï¼Œéšç€æœç´¢å¼•æ“æ‹¥æœ‰æ›´å¤šçš„AIèƒ½åŠ›ï¼Œæ›´å®¹æ˜“æ˜¾ç¤ºä½ çš„è¯­è¨€ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æŠŠè‡ªå·±çš„æ–°è¯­è¨€å‘½åä¸º&quot;for&quot;, é‚£ä¹ˆè¿™é€šå¸¸ä¸èƒ½å¸¦ç»™ä½¿ç”¨è€…ä»»ä½•å¸®åŠ©ã€‚</p>
</li>
<li>
<p>è¯¥åå­—åœ¨å…¶ä»–æ–‡åŒ–ä¸­æ²¡æœ‰è´Ÿé¢å«ä¹‰ã€‚è¿™ä¸€ç‚¹å¾ˆéš¾é˜²èŒƒï¼Œä½†æ˜¯éœ€è¦è®¤çœŸè€ƒè™‘ã€‚Nimrod çš„è®¾è®¡è€…æœ€ç»ˆå°†è¿™ä¸ªè¯­è¨€å‘½åä¸º &quot;Nim&quot;, Bugs Bunnyæ›¾ç»æ•…æ„ä½¿ç”¨æœ‰äº‰è®®çš„åç§° Nimrod å‘½åæ–°çš„è¯­è¨€ï¼Œäººä»¬ä¾ç„¶è®°å¾—ã€‚</p>
</li>
</ol>
<p>å¦‚æœä½ çš„å€™é€‰å‘½åï¼Œé€šè¿‡äº†ä¸Šé¢çš„æ ‡å‡†ï¼Œé‚£ä¹ˆç•™ç€å®ƒå§ã€‚ä¸è¦è¯•å›¾å»æ‰¾åˆ°ä¸€ä¸ªèƒ½æŠ“ä½ä½ çš„è¯­è¨€ç²¾é«“çš„åç§°ã€‚å¦‚æœè¯´ä¸–ç•Œä¸Šå…¶ä»–å·²ç»æˆåŠŸçš„è¯­è¨€æ•™ä¼šäº†æˆ‘ä»¬ä»€ä¹ˆçš„è¯ï¼Œé‚£å°±æ˜¯è¯­è¨€åå­—å’Œè¯­è¨€ç²¾é«“æ²¡æœ‰å…³è”ã€‚ä½ æ‰€éœ€è¦çš„åªæ˜¯ä¸€ä¸ªï¼Œç‹¬ç‰¹çš„åç§°ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ€»è§ˆå›¾"><a class="header" href="#æ€»è§ˆå›¾">æ€»è§ˆå›¾</a></h1>
<h2 id="a-map-of-the-territory"><a class="header" href="#a-map-of-the-territory">A Map of the Territory</a></h2>
<blockquote>
<p>you must have a map, no matter how rough. Otherwise you wander all over the place. In The Lord of the Rings I never made anyone go farther than he could on a given day.</p>
<p align="right">â€”â€” J.R.R. Tolkien</p>
</blockquote>
<p>é¢†åœŸå›¾</p>
<blockquote>
<p>ä¸ç®¡æœ‰å¤šä¹ˆç²—ç³™ï¼Œä½ éƒ½å¿…é¡»æ‹¥æœ‰ä¸€å¹…é¢†åœŸåœ°å›¾ï¼Œå¦åˆ™ä½ å°†åˆ°å¤„æ¸¸è¡ã€‚åœ¨ã€ŠæŒ‡ç¯ç‹ã€‹ä¸­ï¼Œæˆ‘ä»æ¥éƒ½æ²¡æœ‰è®©ä»»ä½•äººä¸€å¤©å†…èµ°çš„æ›´è¿œã€‚</p>
<p align="right">â€”â€” J.R.R. Tolkien</p>
</blockquote>
<p>We donâ€™t want to wander all over the place, so before we set off, letâ€™s scan the territory charted by previous language implementers. It will help us understand where we are going and the alternate routes others have taken.</p>
<p>First, let me establish a shorthand.  Much of this book is about a languageâ€™s implementation, which is distinct from the language itself in some sort of Platonic ideal form. Things like â€œstackâ€, â€œbytecodeâ€, and â€œrecursive descentâ€, are nuts and bolts one particular implementation might use. From the userâ€™s perspective, as long as the resulting contraption faithfully follows the languageâ€™s specification, itâ€™s all implementation detail.</p>
<p>Weâ€™re going to spend a lot of time on those details, so if I have to write â€œlanguage implementationâ€ every single time I mention them, Iâ€™ll wear my fingers off. Instead, Iâ€™ll use â€œlanguageâ€ to refer to either a language or an implementation of it, or both, unless the distinction matters.</p>
<p>æˆ‘ä»¬ä¸æƒ³åˆ°å¤„çé€›ï¼Œæ‰€ä»¥åœ¨å‡ºå‘ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæµè§ˆä¸€ä¸‹ä»¥å‰çš„è¯­è¨€å®ç°è€…ç»˜åˆ¶çš„é¢†åœŸå›¾ã€‚è¿™å°†å¸®åŠ©æˆ‘ä»¬ç†è§£æˆ‘ä»¬çš„ç›®æ ‡ï¼Œäº†è§£æ›´å¤šçš„æ›¿ä»£è·¯å¾„ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªæ¦‚è§ˆã€‚æœ¬ä¹¦çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½æ˜¯å¦‚ä½•å®ç°ä¸€é—¨è¯­è¨€ï¼Œè¿™å’Œä¸€é—¨è¯­è¨€æœ¬èº«æŸæ‹‰å›¾å¼çš„ç†æƒ³æ¦‚å¿µæœ‰æ‰€ä¸åŒã€‚ åƒæ˜¯æ ˆã€å­—èŠ‚ç ã€é€’å½’ä¸‹é™ç­‰ä¸œè¥¿ï¼Œæ˜¯ä¸€ä¸ªç‰¹å®šå®ç°å¯èƒ½ä¼šç”¨åˆ°çš„å…·ä½“ç»†èŠ‚ã€‚ ä»ç”¨æˆ·çš„è§’åº¦ï¼Œåªè¦ç”Ÿæˆçš„å†…å®¹è¿˜éµå¾ªç€è¯­è¨€çš„è§„èŒƒï¼Œå®ƒå°±æ˜¯æ‰€æœ‰çš„å®ç°ç»†èŠ‚ã€‚</p>
<p>æˆ‘ä»¬å°†åœ¨è¿™äº›ç»†èŠ‚ä¸ŠèŠ±è´¹å¤§é‡æ—¶é—´ï¼Œå› æ­¤ï¼Œå¦‚æœæ¯æ¬¡æåˆ°è¿™äº›ç»†èŠ‚ï¼Œæˆ‘éƒ½è¦åŠ ä¸Šè¯­è¨€å®ç°è¯´æ˜ï¼Œé‚£ä¹ˆæˆ‘ä¼šç´¯æ™•çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘å°†ä½¿ç”¨è¯­è¨€æ¥è¡¨ç¤ºä¸€é—¨è¯­è¨€æˆ–è€…è¿™é—¨è¯­è¨€çš„å®ç°ï¼Œæˆ–è€…ä¸¤è€…ï¼Œé™¤éä¸¤è€…çš„åŒºåˆ«éå¸¸é‡è¦ã€‚</p>
<h2 id="ä¸€the-parts-of-a-language"><a class="header" href="#ä¸€the-parts-of-a-language">ä¸€ã€The Parts of a Language</a></h2>
<p>è¯­è¨€çš„ç»„æˆéƒ¨åˆ†</p>
<p>Engineers have been building programming languages since the Dark Ages of computing. As soon as we could talk to computers, we discovered doing so was too hard, and we enlisted their help. I find it fascinating that even though todayâ€™s machines are literally a million times faster and have orders of magnitude more storage, the way we build programming languages is virtually unchanged.</p>
<p>Though the area explored by language designers is vast, the trails theyâ€™ve carved through it are few. Not every language takes the exact same pathâ€”some take a shortcut or twoâ€”but otherwise they are reassuringly similar, from Rear Admiral Grace Hopperâ€™s first COBOL compiler all the way to some hot, new, transpile-to-JavaScript language whose â€œdocumentationâ€ consists entirely of a single, poorly edited README in a Git repository somewhere.</p>
<p>è‡ªè®¡ç®—çš„é»‘æš—æ—¶ä»£ä»¥æ¥ï¼Œå·¥ç¨‹å¸ˆä»¬ä¸€ç›´åœ¨æ„å»ºç¼–ç¨‹è¯­è¨€ã€‚å½“æˆ‘ä»¬å¯ä»¥ä¸ç”µè„‘äº¤æµæ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°è¿™æ ·åšå¤ªéš¾äº†ï¼Œéœ€è¦ç”µè„‘çš„å¸®åŠ©ã€‚æˆ‘å‘ç°ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ï¼Œå³ä½¿ä»Šå¤©çš„æœºå™¨è¿è¡Œé€Ÿåº¦å¿«äº†æ•°ç™¾ä¸‡å€ï¼Œå­˜å‚¨é‡ä¹Ÿå¢åŠ äº†å‡ ä¸ªæ•°é‡çº§ï¼Œä½†æ˜¯æˆ‘ä»¬æ„å»ºç¼–ç¨‹è¯­è¨€çš„æ–¹å¼å‡ ä¹æ²¡æœ‰ä»»ä½•æ”¹å˜ã€‚</p>
<p>è™½ç„¶ï¼Œè¯­è¨€è®¾è®¡è€…æ¢ç´¢çš„é¢†åŸŸéå¸¸å¤§ï¼Œä½†æ˜¯ä»–ä»¬åœ¨å…¶ä¸­å¼€è¾Ÿçš„é“è·¯å´éå¸¸å°‘ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„è¯­è¨€éƒ½èµ°ç›¸åŒçš„è·¯å¾„ï¼Œæœ‰äº›è¯­è¨€çš„å®ç°ï¼Œä¼šèµ°ä¸€ã€ä¸¤æ¡æ·å¾„ã€‚ä½†æ˜¯ä»å¦ä¸€ä¸ªè§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬éƒ½æ˜¯ç›¸ä¼¼çš„ã€‚ä»ç¬¬ä¸€ä¸ª COBOLç¼–è¯‘å™¨åˆ°ç°åœ¨æœ€æ–°çš„å¯ä»¥è½¬æ¢ä¸º JavaScriptçš„è¯­è¨€ï¼Œåœ¨å®ƒä»¬ gitä»“åº“READMEæ–‡ä»¶ä¸­çš„æè¿°éƒ½æ˜¯ç›¸ä¼¼çš„ã€‚</p>
<blockquote>
<p>There are certainly dead ends, sad little cul-de-sacs of CS papers with zero citations and now-forgotten optimizations that only made sense when memory was measured in individual bytes.</p>
<p>æ¯«æ— ç–‘é—®ï¼Œè®¡ç®—æœºç§‘å­¦è®ºæ–‡å­˜åœ¨ä¸€äº›æ­»èƒ¡åŒã€‚è¿™äº›è®ºæ–‡ç°åœ¨å·²ç»æ²¡æœ‰äººå¼•ç”¨ï¼Œéƒ½æ˜¯åœ¨å†…å­˜éœ€è¦ä»¥ä¸€ä¸ªä¸€ä¸ªå­—èŠ‚æ¥è¡¡é‡æ—¶æœŸçš„ä¼˜åŒ–ä½¿ç”¨è®ºæ–‡ã€‚</p>
</blockquote>
<p>I visualize the network of paths an implementation may choose as climbing a mountain. You start off at the bottom with the program as raw source text, literally just a string of characters. Each phase analyzes the program and transforms it to some higher-level representation where the semanticsâ€”what the author wants the computer to doâ€”become more apparent.</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/mountain.png?raw=true" alt="a map of the territory" /></p>
<p>Eventually we reach the peak. We have a birdâ€™s-eye view of the userâ€™s program and can see what their code means. We begin our descent down the other side of the mountain. We transform this highest-level representation down to successively lower-level forms to get closer and closer to something we know how to make the CPU actually execute.</p>
<p>æˆ‘æŠŠç¼–è¯‘é¢†åŸŸå›¾ï¼Œæƒ³è±¡ä¸ºä¸€å¹…åŒ…å«å¾ˆå¤šè·¯å¾„çš„çˆ¬å±±å›¾ã€‚ä»åº•éƒ¨å¼€å§‹ï¼Œä¸€å¼€å§‹åªæ˜¯ä¸€ä¸ªæ–‡æœ¬ï¼Œå®é™…ä¸Šåªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ç»è¿‡ï¼Œæ¯ä¸ªåˆ†æé˜¶æ®µï¼Œéƒ½ä¼šç”Ÿæˆæ›´åŠ é«˜çº§çš„è¡¨ç¤ºï¼Œè®¾è®¡è€…å¸Œæœ›è®¡ç®—æœºæ‰§è¡Œçš„è¯­è¨€éƒ½æ›´åŠ æ˜ç¡®ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬çˆ¬ä¸Šäº†å±±é¡¶ã€‚æˆ‘ä»¬é¸Ÿç°å…¨å±€ï¼Œå¯ä»¥å¾—åˆ°ä½¿ç”¨è€…ç¼–å†™çš„ä»£ç å«ä¹‰ã€‚æˆ‘ä»¬ä»å±±çš„å¦ä¸€è¾¹å¼€å§‹ä¸‹å±±ï¼Œæˆ‘ä»¬å°†è¿ç»­å°†é«˜çº§åˆ«çš„è¡¨ç¤ºè½¬æ¢ä¸ºæ›´ä½çº§åˆ«çš„è¡¨ç¤ºï¼Œä»¥è¶Šæ¥è¶Šæ¥è¿‘è®¡ç®—æœº CPUæ‰§è¡Œçš„è¯­è¨€ã€‚</p>
<p>Letâ€™s trace through each of those trails and points of interest. Our journey begins on the left with the bare text of the userâ€™s source code:</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/string.png?raw=true" alt="string" /></p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¿½è¸ªæ¯ä¸€æ¡è·¯å¾„ã€æ¯ä¸€ä¸ªåœç•™ç‚¹ï¼Œæˆ‘ä»¬çš„æ—…é€”ä»å·¦è¾¹å±±è„šå¼€å§‹ï¼ˆç”¨æˆ·æºä»£ç ï¼‰ã€‚</p>
<h3 id="11-scanning"><a class="header" href="#11-scanning">1.1 Scanning</a></h3>
<p>æ‰«æ</p>
<p>The first step is scanning, also known as lexing, or (if youâ€™re trying to impress someone) lexical analysis. They all mean pretty much the same thing. I like â€œlexingâ€ because it sounds like something an evil supervillain would do, but Iâ€™ll use â€œscanningâ€ because it seems to be marginally more commonplace.</p>
<p>A scanner (or lexer) takes in the linear stream of characters and chunks them together into a series of something more akin to â€œwordsâ€. In programming languages, each of these words is called a token. Some tokens are single characters, like ( and ,. Others may be several characters long, like numbers (123), string literals (&quot;hi!&quot;), and identifiers (min).</p>
<p>Some characters in a source file donâ€™t actually mean anything. Whitespace is often insignificant, and comments, by definition, are ignored by the language. The scanner usually discards these, leaving a clean sequence of meaningful tokens.</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/tokens.png?raw=true" alt="tokens" /></p>
<p>ç¬¬ä¸€æ­¥æ˜¯æ‰«æï¼Œä¹Ÿç§°ä¸ºè¯æ³•ï¼Œå¦‚æœä½ æƒ³ç»™åˆ«äººç•™ä¸‹æ·±åˆ»å°è±¡ï¼Œè¿˜å¯ä»¥ç§°ä¸ºè¯æ³•åˆ†æã€‚ä»–ä»¬çš„å«ä¹‰éƒ½å·®ä¸å¤šï¼Œæˆ‘æ›´å–œæ¬¢è¯æ³•ï¼Œå› ä¸ºè¿™å¬èµ·æ¥åƒæ˜¯ä¸€ä¸ªæ¶ä½œå‰§ï¼Œä½†æ˜¯æ¥ä¸‹æ¥æˆ‘ä¼šä½¿ç”¨æ‰«æè¡¨ç¤ºè¿™ä¸ªè¿‡ç¨‹ï¼Œå› ä¸ºè¿™ç§è¯´æ³•æ›´åŠ å¸¸è§ã€‚</p>
<p>ä¸€ä¸ªæ‰«æå™¨ï¼Œæ¥æ”¶çº¿æ€§çš„å­—ç¬¦ä¸²ï¼Œå°†å®ƒä»¬åˆ†å—ä¸ºä¸€ä¸ªä¸ªå•è¯ï¼Œåœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œåˆ†æˆçš„å•è¯ç§°ä¸º token, ä¸€äº› token æ˜¯å•å­—ç¬¦ï¼Œä¾‹å¦‚: <code>(</code> <code>,</code> è¿˜æœ‰ä¸€äº›tokené•¿åº¦æ˜¯å¤šä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚: æ•°å­— <code>123</code> ï¼Œå­—ç¬¦ä¸² <code>&quot;hi!&quot;</code> , æ ‡è¯†ç¬¦ <code>min</code></p>
<p>æºæ–‡ä»¶ä¸­çš„æŸäº›å­—ç¬¦æ²¡æœ‰å®é™…æ„ä¹‰ã€‚ç©ºç™½å­—ç¬¦ï¼Œé€šå¸¸æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œè¿˜æœ‰æ³¨é‡Šï¼Œæ ¹æ®è¯­è¨€å®šä¹‰ï¼Œæ³¨é‡Šä¼šè¢«è¯­è¨€å¿½ç•¥ã€‚æ‰«æå™¨é€šå¸¸ä¼šå¿½ç•¥è¿™äº›å†…å®¹ï¼Œæœ€ç»ˆç”Ÿæˆä¸€ä¸ªå¹²å‡€çš„æœ‰æ„ä¹‰çš„token åºåˆ—ã€‚</p>
<h3 id="12-parsing"><a class="header" href="#12-parsing">1.2 Parsing</a></h3>
<p>è§£æ</p>
<p>The next step is parsing. This is where our syntax gets a grammarâ€”the ability to compose larger expressions and statements out of smaller parts. Did you ever diagram sentences in English class? If so, youâ€™ve done what a parser does, except that English has thousands and thousands of â€œkeywordsâ€ and an overflowing cornucopia of ambiguity. Programming languages are much simpler.</p>
<p>A parser takes the flat sequence of tokens and builds a tree structure that mirrors the nested nature of the grammar. These trees have a couple of different namesâ€”parse tree or abstract syntax treeâ€”depending on how close to the bare syntactic structure of the source language they are.  In practice, language hackers usually call them syntax trees, ASTs, or often just trees.</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/ast.png?raw=true" alt="ast" /></p>
<p>ä¸‹ä¸€æ­¥æ˜¯è§£æï¼Œè¿™å°±æ˜¯æˆ‘ä»¬è·å¾—è¯­æ³•çš„åœ°æ–¹ï¼Œè¯­æ³•å¯ä»¥å°†è¾ƒå°çš„éƒ¨åˆ†ç»„åˆæˆè¾ƒå¤§çš„è¡¨è¾¾å¼å’Œè¯­å¥ã€‚ä½ åœ¨è‹±è¯­è¯¾å ‚ä¸Šç”»è¿‡å¥å­å›¾å—ï¼Ÿå¦‚æœæ˜¯è¿™æ ·çš„è¯ï¼Œä½ å·²ç»å®Œæˆäº†è§£æå™¨çš„å·¥ä½œã€‚é™¤äº†è‹±è¯­æœ‰æˆåƒä¸Šä¸‡ä¸ªå…³é”®è¯å’Œæ›´å¤šçš„æ­§ä¹‰ã€‚ç›¸è¾ƒè€Œè¨€ï¼Œç¼–ç¨‹è¯­è¨€å°±ç®€å•å¤ªå¤šäº†ã€‚</p>
<p>è§£æå™¨æ¥æ”¶token åºåˆ—ï¼Œç„¶åæ„å»ºå‡ºååº”è¯­æ³•åµŒå¥—æ€§è´¨çš„æ ‘ç»“æ„ã€‚è¿™äº›æ ‘æœ‰ä¸€äº›ä¸åŒçš„åç§°ï¼Œä¾‹å¦‚ï¼šåç§°è§£ææ ‘ï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼Œå‘½åå–å†³äºè¿™äº›æ ‘å’Œæºè¯­è¨€çš„ç®€å•è¯­æ³•ç»“æ„çš„æ¥è¿‘ç¨‹åº¦ã€‚åœ¨å®è·µä¸­ï¼Œè¯­è¨€é«˜æ‰‹ç»å¸¸ç§°å®ƒä»¬ä¸ºè¯­æ³•æ ‘ï¼ŒASTæˆ–è€…é€šå¸¸å°±ç§°ä¸ºæ ‘ã€‚</p>
<p>Parsing has a long, rich history in computer science that is closely tied to the artificial intelligence community. Many of the techniques used today to parse programming languages were originally conceived to parse human languages by AI researchers who were trying to get computers to talk to us.</p>
<p>It turns out human languages were too messy for the rigid grammars those parsers could handle, but they were a perfect fit for the simpler artificial grammars of programming languages. Alas, we flawed humans still manage to use those simple grammars incorrectly, so the parserâ€™s job also includes letting us know when we do by reporting syntax errors.</p>
<p>è§£æåœ¨è®¡ç®—æœºç§‘å­¦ä¸­æ‹¥æœ‰æ‚ ä¹…ä¸°å¯Œçš„å†å²ï¼Œä¸äººå·¥æ™ºèƒ½é¢†åŸŸå¯†åˆ‡ç›¸å…³ã€‚ä»Šå¤©ç”¨äºè§£æç¼–ç¨‹è¯­è¨€çš„è®¸å¤šæŠ€æœ¯æœ€åˆæ˜¯ç”±äººå·¥æ™ºèƒ½ç ”ç©¶äººå‘˜æ„æ€çš„ï¼Œä»–ä»¬æœ€åˆè®¾æƒ³æ˜¯è®©è®¡ç®—æœºä¸äººå¯¹è¯äº¤æµã€‚</p>
<p>äº‹å®è¯æ˜ï¼Œå¯¹äºè§£æå™¨æ‰€èƒ½è§£æçš„è¯­æ³•è€Œè¨€ï¼Œäººç±»çš„è¯­è¨€å¤ªå¤æ‚äº†ï¼Œä½†æ˜¯è¿™äº›è§£æå™¨å´éå¸¸é€‚åˆç¼–ç¨‹è¯­è¨€ä¸­çš„äººç±»å®šä¹‰çš„è¯­æ³•è§„åˆ™ã€‚å“ï¼Œæˆ‘ä»¬è¿™äº›æ™®é€šçš„äººï¼Œåœ¨ä½¿ç”¨è¿™äº›ç®€å•è¯­æ³•æ—¶å€™ï¼Œä»ç„¶ä¼šçŠ¯é”™è¯¯ï¼Œæ‰€ä»¥ï¼Œè§£æå™¨è¿˜ä¼šæŠ¥å‘Šè¯­æ³•é”™è¯¯ï¼Œè®©æˆ‘ä»¬çŸ¥é“ã€‚</p>
<h3 id="13-static-analysis"><a class="header" href="#13-static-analysis">1.3 Static analysis</a></h3>
<p>é™æ€åˆ†æ</p>
<p>The first two stages are pretty similar across all implementations. Now, the individual characteristics of each language start coming into play. At this point, we know the syntactic structure of the codeâ€”things like which expressions are nested in whichâ€”but we donâ€™t know much more than that.</p>
<p>In an expression like a + b, we know we are adding a and b, but we donâ€™t know what those names refer to. Are they local variables? Global? Where are they defined?</p>
<p>å‰é¢ä¸¤ä¸ªé˜¶æ®µï¼ˆæ‰«æã€è§£æï¼‰åœ¨æ‰€æœ‰çš„å®ç°ä¸­éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œç°åœ¨ï¼Œæ¯ç§è¯­è¨€çš„ç‰¹æ€§å¼€å§‹æ˜¾ç°å‡ºæ¥äº†ã€‚è§£æè¿‡åï¼Œæˆ‘ä»¬çŸ¥é“äº†ä»£ç çš„è¯­æ³•ç»“æ„ï¼Œä¾‹å¦‚ï¼šæˆ‘ä»¬çŸ¥é“äº†åŒ…å«äº†å“ªäº›è¡¨è¾¾å¼ï¼Œä½†æ˜¯æˆ‘ä»¬äº†è§£çš„è¿˜ä¸å¤Ÿå¤šã€‚</p>
<p>åœ¨åƒè¡¨è¾¾å¼ a + bä¸­ï¼Œæˆ‘ä»¬çŸ¥é“è¡¨è¾¾å¼æ˜¯ aä¸bæ±‚å’Œï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸çŸ¥é“aï¼Œbå…·ä½“è¡¨ç¤ºä»€ä¹ˆï¼Œå®ƒä»¬æ˜¯å±€éƒ¨å˜é‡å—ï¼Œæ˜¯å…¨å±€å˜é‡å—ï¼Œå®ƒä»¬æ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„å‘¢ï¼Ÿ</p>
<p>The first bit of analysis that most languages do is called binding or resolution. For each identifier, we find out where that name is defined and wire the two together. This is where scope comes into playâ€”the region of source code where a certain name can be used to refer to a certain declaration.</p>
<p>If the language is statically typed, this is when we type check. Once we know where a and b are declared, we can also figure out their types. Then if those types donâ€™t support being added to each other, we report a type error.</p>
<p>å¤§å¤šæ•°è¯­è¨€çš„ç¬¬ä¸€ç‚¹åˆ†æå«åšï¼Œç»‘å®šæˆ–è§£æã€‚å¯¹äºæ¯ä¸ªæ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°è¯¥æ ‡è¯†ç¬¦åç§°çš„å®šä¹‰ä½ç½®ï¼Œå¹¶ä¸”å°†ä¸¤è€…è¿æ¥åœ¨ä¸€èµ·ï¼Œè¿™å°±æ˜¯ä½œç”¨åŸŸå‘æŒ¥ä½œç”¨çš„åœ°æ–¹â€”â€”æºä»£ç çš„æŸä¸ªåŒºåŸŸä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªå…·ä½“åç§°æ¥å¼•ç”¨æŸä¸ªå£°æ˜ã€‚</p>
<p>å¦‚æœè¯­è¨€æ˜¯é™æ€è¯­è¨€ï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜è¦è¿›è¡Œç±»å‹åˆ¤æ–­ï¼Œä¸€æ—¦æˆ‘ä»¬æ‰¾åˆ°äº† aï¼Œbçš„å£°æ˜ä½ç½®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è·å–åˆ°å®ƒä»¬çš„æ•°æ®ç±»å‹ã€‚ç„¶åï¼Œå¦‚æœè¿™äº›æ•°æ®ç±»å‹ä¸æ”¯æŒåŠ æ³•è§„åˆ™ï¼Œæˆ‘ä»¬å°†æŠ¥å‘Šä¸€ä¸ªç±»å‹é”™è¯¯ã€‚</p>
<blockquote>
<p>The language weâ€™ll build in this book is dynamically typed, so it will do its type checking later, at runtime.</p>
</blockquote>
<blockquote>
<p>æœ¬ä¹¦ä¸­æ„å»ºçš„è¯­è¨€æ˜¯åŠ¨æ€è¯­è¨€ï¼Œæ‰€ä»¥ï¼Œç±»å‹æ£€æŸ¥å°†å‘ç”Ÿåœ¨è¿è¡Œæ—¶ï¼Œè€Œä¸æ˜¯å½“å‰é˜¶æ®µã€‚</p>
</blockquote>
<p>Take a deep breath. We have attained the summit of the mountain and a sweeping view of the userâ€™s program. All this semantic insight that is visible to us from analysis needs to be stored somewhere. There are a few places we can squirrel it away:</p>
<ul>
<li>
<p>Often, it gets stored right back as attributes on the syntax tree itselfâ€”extra fields in the nodes that arenâ€™t initialized during parsing but get filled in later.</p>
</li>
<li>
<p>Other times, we may store data in a lookup table off to the side. Typically, the keys to this table are identifiersâ€”names of variables and declarations. In that case, we call it a symbol table and the values it associates with each key tell us what that identifier refers to.</p>
</li>
<li>
<p>The most powerful bookkeeping tool is to transform the tree into an entirely new data structure that more directly expresses the semantics of the code. Thatâ€™s the next section.</p>
</li>
</ul>
<p>æ·±å‘¼å¸ï¼Œæˆ‘ä»¬å·²ç»ç™»ä¸Šäº†å±±é¡¶ï¼Œç”¨æˆ·ç¨‹åºä¸€è§ˆæ— ä½™ã€‚ä»åˆ†æé˜¶æ®µåï¼Œè·å–åˆ°çš„è¯­ä¹‰é™„åŠ ä¿¡æ¯ï¼Œéœ€è¦ä¿å­˜åœ¨æŸä¸ªåœ°æ–¹ã€‚æœ‰å‡ ä¸ªåœ°æ–¹å¯ä»¥ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚</p>
<ul>
<li>
<p>é€šå¸¸ï¼Œå®ƒä½œä¸ºå±æ€§å­˜å‚¨åœ¨è¯­æ³•æ ‘çš„å…¶ä»–å­—æ®µä¸­ï¼Œè¿™äº›å­—æ®µåœ¨è§£æé˜¶æ®µæ²¡æœ‰åˆå§‹åŒ–ï¼Œä½†æ˜¯åœ¨åˆ†æé˜¶æ®µä¼šè¢«å¡«å……</p>
</li>
<li>
<p>å…¶ä»–æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®ä¿å­˜åœ¨æ—è¾¹çš„æŸ¥æ‰¾è¡¨ä¸­ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¯¥æŸ¥æ‰¾è¡¨çš„keyæ˜¯æ ‡è¯†ç¬¦ï¼ˆå˜é‡åç§°å’Œå£°æ˜ï¼‰ã€‚è¿™è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç§°å…¶ä¸ºç¬¦å·è¡¨ï¼Œè¡¨ä¸­keyå¯¹åº”çš„valueï¼Œè¡¨ç¤ºè¯¥æ ‡è¯†ç¬¦å¯¹åº”çš„å®é™…å€¼æ˜¯ä»€ä¹ˆ</p>
</li>
<li>
<p>æ›´åŠ å¼ºå¤§çš„è®°å½•æ–¹å¼æ˜¯ï¼Œå°†è¯­æ³•æ ‘è½¬æ¢ä¸ºä¸€ä¸ªå…¨æ–°çš„æ•°æ®ç»“æ„ï¼Œæ›´åŠ ç›´æ¥çš„è¡¨ç¤ºä»£ç çš„å«ä¹‰ã€‚è¿™æ˜¯ä¸‹ä¸€èŠ‚çš„å†…å®¹ã€‚</p>
</li>
</ul>
<p>Everything up to this point is considered the front end of the implementation. You might guess everything after this is the back end, but no. Back in the days of yore when â€œfront endâ€ and â€œback endâ€ were coined, compilers were much simpler. Later researchers invented new phases to stuff between the two halves. Rather than discard the old terms, William Wulf and company lumped those new phases into the charming but spatially paradoxical name middle end.</p>
<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæ‰€æœ‰å†…å®¹é˜¶æ®µï¼Œéƒ½æ˜¯å®ç°çš„å‰ç«¯éƒ¨åˆ†ã€‚ä½ å¯èƒ½ä¼šæƒ³è±¡ï¼Œé‚£ä¹ˆä¹‹åçš„å†…å®¹æ˜¯åç«¯äº†ï¼Œå…¶å®å¹¶ä¸æ˜¯ï¼Œå“ˆå“ˆğŸ˜„ã€‚å½“ç¼–è¯‘å™¨ï¼Œåˆšå¼€å§‹æœ‰å‰ç«¯ã€åç«¯æ¦‚å¿µçš„æ—¶å€™ï¼Œé‚£æ—¶å€™çš„ç¼–è¯‘å™¨éå¸¸ç®€å•ã€‚åæ¥ï¼Œç ”ç©¶äººå‘˜åˆå‘æ˜äº†å…¶ä»–é˜¶æ®µï¼Œå®ƒä»¬åœ¨å‰ç«¯ã€åç«¯ä¹‹é—´ã€‚<a href="https://en.wikipedia.org/wiki/William_Wulf">William Wulf</a> å’Œä»–ä»¬å…¬å¸å¹¶æ²¡æœ‰æŠ›å¼ƒæ—§çš„æœ¯è¯­ï¼Œä»–ä»¬æŠŠè¿™äº›æ–°å‘æ˜çš„é˜¶æ®µå½’ä¸ºæœ‰æ„æ€çš„ä½†æ˜¯æœ‰äº›çŸ›ç›¾çš„æœ¯è¯­ï¼Œä¸­é—´ç«¯ã€‚</p>
<h3 id="14-intermediate-representations"><a class="header" href="#14-intermediate-representations">1.4 Intermediate representations</a></h3>
<p>ä¸­é—´è¡¨ç¤ºæ³•</p>
<p>You can think of the compiler as a pipeline where each stageâ€™s job is to organize the data representing the userâ€™s code in a way that makes the next stage simpler to implement. The front end of the pipeline is specific to the source language the program is written in. The back end is concerned with the final architecture where the program will run.</p>
<p>In the middle, the code may be stored in some intermediate representation (IR) that isnâ€™t tightly tied to either the source or destination forms (hence â€œintermediateâ€). Instead, the IR acts as an interface between these two languages.</p>
<p>æˆ‘ä»¬å¯ä»¥å°†ç¼–è¯‘å™¨è§†ä¸ºä¸€ä¸ªç®¡é“ï¼Œæ¯ä¸ªé˜¶æ®µçš„å·¥ä½œæ˜¯ç”¨ä¸€ç§æ›´æ˜“äºå®ç°çš„æ–¹å¼ï¼Œç»„ç»‡è¡¨ç¤ºç”¨æˆ·ä»£ç ã€‚ç®¡é“å‰ç«¯ï¼Œä½œç”¨äºç¼–å†™ç¨‹åºçš„æºè¯­è¨€ï¼Œåç«¯ä¸ç¨‹åºè¿è¡Œçš„æœ€ç»ˆæ¶æ„ç›¸å…³ã€‚</p>
<p>åœ¨ä¸­é—´ç«¯ï¼Œä»£ç å¯èƒ½å­˜å‚¨åœ¨ä¸€äº›ä¸­é—´è¡¨ç¤ºä¸­ï¼Œè¿™äº›è¡¨ç¤ºï¼Œä¸æºè¯­è¨€å’Œç›®æ ‡å½¢å¼éƒ½æ²¡æœ‰ç´§å¯†å…³è”ã€‚ç›¸åï¼Œè¿™ç§ä¸­é—´è¡¨ç¤ºï¼Œå……å½“æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ä¹‹é—´çš„æ¥å£ã€‚</p>
<blockquote>
<p>There are a few well-established styles of IRs out there. Hit your search engine of choice and look for â€œcontrol flow graphâ€, â€œstatic single-assignmentâ€, â€œcontinuation-passing styleâ€, and â€œthree-address codeâ€.</p>
</blockquote>
<blockquote>
<p>æœ‰ä¸€äº›æˆç†Ÿçš„ä¸­é—´è¡¨ç¤ºé£æ ¼ï¼Œæœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ï¼Œæ§åˆ¶æµå›¾ã€é™æ€å•èµ‹å€¼ã€è¿ç»­ä¼ é€’æ ·å¼ã€ä¸‰åœ°å€ä»£ç ç­‰ç­‰ã€‚</p>
</blockquote>
<p>This lets you support multiple source languages and target platforms with less effort. Say you want to implement Pascal, C, and Fortran compilers, and you want to target x86, ARM, and, I dunno, SPARC. Normally, that means youâ€™re signing up to write nine full compilers: Pascalâ†’x86, Câ†’ARM, and every other combination.</p>
<p>A shared intermediate representation reduces that dramatically. You write one front end for each source language that produces the IR. Then one back end for each target architecture. Now you can mix and match those to get every combination.</p>
<p>Thereâ€™s another big reason we might want to transform the code into a form that makes the semantics more apparentâ€‰.â€‰.â€‰. </p>
<p>è¿™ç§æ–¹å¼ï¼Œå¯ä»¥è®©æˆ‘ä»¬æ›´å®¹æ˜“æ”¯æŒå¤šç§æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€çš„åŒ¹é…ã€‚å‡è®¾ä½ æƒ³è¦å®ç°ï¼ŒPascalã€Cã€Fortranè¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œå¹¶ä¸”è¿™äº›ç¼–è¯‘å™¨ï¼Œå¯ä»¥è¿è¡Œåœ¨X86ï¼Œ armï¼ŒSPARCç­‰æ¶æ„ä¸Šï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ä¸­é—´è¡¨ç¤ºï¼Œä½ éœ€è¦å®ç°9ç§ç¼–è¯‘å™¨ï¼Œä¾‹å¦‚: Pascalâ€”â€”&gt; x86ï¼ŒCâ€”â€”&gt; armç­‰ç­‰ã€‚</p>
<p>ä½¿ç”¨ä¸€ç§å…±äº«çš„ä¸­é—´è¡¨ç¤ºï¼Œå¯ä»¥å¤§å¤§å‡å°‘è¿™äº›ç»„åˆã€‚å¯¹äºæ¯ä¸€ç§æºè¯­è¨€ï¼Œç¼–å†™ä¸€ä¸ªå‰ç«¯ï¼Œå°†æºè¯­è¨€è§£æä¸ºä¸­é—´è¡¨ç¤ºï¼Œå¯¹äºæ¯ä¸ªç›®æ ‡æ¶æ„ï¼Œé’ˆå¯¹ä¸­é—´è¡¨ç¤ºï¼Œç¼–å†™ä¸€ä¸ªåç«¯ã€‚æ‰€ä»¥ï¼Œç°åœ¨åªéœ€è¦å®ç° 6 ä¸­å‰ç«¯ã€åç«¯ç»„åˆã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªé‡è¦åŸå› ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ä¸­é—´è¡¨ç¤ºã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸­é—´è¡¨ç¤ºï¼Œå°†ä»£ç è½¬ä¸ºä¸€ç§å½¢å¼ï¼Œä½¿å¾—è¯­ä¹‰æ›´åŠ æ˜æ˜¾ã€‚</p>
<blockquote>
<p>If youâ€™ve ever wondered how GCC supports so many crazy languages and architectures, like Modula-3 on Motorola 68k, now you know. Language front ends target one of a handful of IRs, mainly GIMPLE and RTL. Target back ends like the one for 68k then take those IRs and produce native code.</p>
<p>å¦‚æœä½ æƒ³è¦çŸ¥é“ <a href="https://en.wikipedia.org/wiki/GNU_Compiler_Collection">GCC</a>æ˜¯å¦‚ä½•æ”¯æŒè¿™ä¹ˆå¤šè¯­è¨€å’Œæ¶æ„çš„ï¼Œç°åœ¨ä½ çŸ¥é“åŸå› äº†ã€‚é’ˆå¯¹å‰ç«¯çš„å°‘é‡ä¸­é—´è¡¨ç¤ºï¼Œä¸»è¦æ˜¯ <a href="https://gcc.gnu.org/onlinedocs/gccint/GIMPLE.html">GIMPLE</a> å’Œ <a href="https://gcc.gnu.org/onlinedocs/gccint/RTL.html">RTL</a>, ä¸åŒçš„ç›®æ ‡æ¶æ„ï¼Œè·å–ä¸­é—´è¡¨ç¤ºï¼Œç”Ÿæˆå¯¹åº”çš„æœºå™¨ä»£ç ã€‚</p>
</blockquote>
<h3 id="15-optimization"><a class="header" href="#15-optimization">1.5 Optimization</a></h3>
<p>ä¼˜åŒ–</p>
<p>Once we understand what the userâ€™s program means, we are free to swap it out with a different program that has the same semantics but implements them more efficientlyâ€”we can optimize it.</p>
<p>A simple example is constant folding: if some expression always evaluates to the exact same value, we can do the evaluation at compile time and replace the code for the expression with its result. If the user typed in this:</p>
<pre><code>
pennyArea = 3.14159 * (0.75 / 2) * (0.75 / 2);

</code></pre>
<p>we could do all of that arithmetic in the compiler and change the code to:</p>
<pre><code>pennyArea = 0.4417860938;
</code></pre>
<p>ä¸€æ—¦æˆ‘ä»¬ç†è§£äº†ç”¨æˆ·ç¨‹åºçš„å«ä¹‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªç”±çš„æŠŠç”¨æˆ·ç¨‹åºæ›¿æ¢ä¸ºå…·æœ‰ç›¸åŒè¯­ä¹‰ï¼Œä½†æ˜¯æ›´åŠ é«˜æ•ˆçš„å®ç°çš„å¦å¤–ä¸€ç§ç¨‹åºã€‚æˆ‘ä»¬å¯ä»¥è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>ä¸€ä¸ªç®€å•ç¤ºä¾‹æ˜¯å¸¸æ•°è®¡ç®—ã€‚å¦‚æœæŸä¸ªè¡¨è¾¾å¼çš„è®¡ç®—ç»“æœæ€»æ˜¯ç›¸åŒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘æ—¶å€™è®¡ç®—è¯¥è¡¨è¾¾å¼ï¼Œå¹¶ä¸”ä½¿ç”¨è¡¨è¾¾å¼è®¡ç®—ç»“æœä»£æ›¿è¯¥è¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼Œå®¢æˆ·è¾“å…¥</p>
<pre><code>pennyArea = 3.14159 * (0.75 / 2) * (0.75 / 2);
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘æ—¶å€™è®¡ç®—å‡ºå€¼ï¼Œå°†ä»£ç ä¿®æ”¹ä¸º</p>
<pre><code>pennyArea = 0.4417860938;
</code></pre>
<p>Optimization is a huge part of the programming language business.  Many language hackers spend their entire careers here, squeezing every drop of performance they can out of their compilers to get their benchmarks a fraction of a percent faster. It can become a sort of obsession.</p>
<p>Weâ€™re mostly going to hop over that rathole in this book. Many successful languages have surprisingly few compile-time optimizations. For example, Lua and CPython generate relatively unoptimized code, and focus most of their performance effort on the runtime.</p>
<p>ä¼˜åŒ–æ˜¯ç¼–ç¨‹è¯­è¨€çš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè®¸å¤šè¯­è¨€é«˜æ‰‹åœ¨æ•´ä¸ªèŒä¸šç”Ÿæ¶¯éƒ½åœ¨ä¸æ–­ä¼˜åŒ–ï¼Œä»ç¼–è¯‘å™¨ä¸­æ¦¨å–æ¯ä¸€ç‚¹æ€§èƒ½ï¼Œæœ€ç»ˆä½¿å¾—ä»–ä»¬çš„ç¼–è¯‘å™¨ï¼ŒåŸºå‡†æµ‹è¯•ç»“æœæé«˜äº†0.5%ï¼Œä¼˜åŒ–æ˜¯ä¸€ä¸ªä¸æ–­è¿›è¡Œçš„è¿‡ç¨‹ã€‚</p>
<p>æœ¬ä¹¦ä¸­ï¼Œæˆ‘ä»¬ä¼šè·³è¿‡ä¼˜åŒ–è¿™ä¸ªæ­¥éª¤ï¼Œæœ‰å¾ˆå¤šæˆåŠŸè¯­è¨€ï¼Œä¹Ÿå¾ˆå°‘ä½¿ç”¨ç¼–è¯‘æ—¶ä¼˜åŒ–ã€‚ä¸¾ä¾‹ï¼ŒLua å’Œ CPythonç”Ÿæˆç›¸å¯¹æœªä¼˜åŒ–çš„ä»£ç ï¼Œå°†å¤§éƒ¨åˆ†ä¼˜åŒ–æ”¾åœ¨è¿è¡Œæ—¶ã€‚</p>
<blockquote>
<p>If you canâ€™t resist poking your foot into that hole, some keywords to get you started are â€œconstant propagationâ€, â€œcommon subexpression eliminationâ€, â€œloop invariant code motionâ€, â€œglobal value numberingâ€, â€œstrength reductionâ€, â€œscalar replacement of aggregatesâ€, â€œdead code eliminationâ€, and â€œloop unrollingâ€.</p>
<p>å¦‚æœä½ å¿ä¸ä½æƒ³è¦æ¢ç´¢ä¼˜åŒ–è¿™ä¸ªé¢†åŸŸï¼Œé‚£ä¹ˆä½ å¯ä»¥ä»ä¸€äº›æœ¯è¯­å…¥æ‰‹ï¼Œä¾‹å¦‚: &quot;æ’å®šä¼ æ’­&quot;, &quot;å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤&quot;, &quot;å¾ªç¯ä¸å˜ä»£ç &quot;, &quot;å…¨å±€å€¼ç¼–å·&quot;, &quot;å¼ºåº¦é™ä½&quot;, &quot;èšåˆæ ‡é‡ä»£æ›¿&quot;, &quot;åƒµå°¸ä»£ç æ¶ˆé™¤&quot;, &quot;å¾ªç¯å±•å¼€&quot;ã€‚</p>
</blockquote>
<h3 id="16-code-generation"><a class="header" href="#16-code-generation">1.6 Code generation</a></h3>
<p>ä»£ç ç”Ÿæˆ</p>
<p>We have applied all of the optimizations we can think of to the userâ€™s program. The last step is converting it to a form the machine can actually run. In other words, generating code (or code gen), where â€œcodeâ€ here usually refers to the kind of primitive assembly-like instructions a CPU runs and not the kind of â€œsource codeâ€ a human might want to read.</p>
<p>Finally, we are in the back end, descending the other side of the mountain. From here on out, our representation of the code becomes more and more primitive, like evolution run in reverse, as we get closer to something our simple-minded machine can understand.</p>
<p>We have a decision to make. Do we generate instructions for a real CPU or a virtual one? If we generate real machine code, we get an executable that the OS can load directly onto the chip. Native code is lightning fast, but generating it is a lot of work. Native code is lightning fast, but generating it is a lot of work. </p>
<p>æˆ‘ä»¬å·²ç»å°†èƒ½å¤Ÿæƒ³åˆ°çš„æ‰€æœ‰ä¼˜åŒ–ï¼Œåº”ç”¨äºç”¨æˆ·ä»£ç ä¸­ã€‚æœ€åä¸€æ­¥æ˜¯ï¼Œå°†ä»£ç è½¬æ¢ä¸ºæœºå™¨å¯ä»¥å®é™…è¿è¡Œçš„å½¢å¼ã€‚æ¢å¥è¯è¯´ï¼Œä»£ç ç”Ÿæˆï¼ˆæˆ–è€…ç”Ÿæˆä»£ç ï¼‰ï¼Œè¿™é‡Œçš„ä»£ç æ˜¯æŒ‡ï¼ŒCPUç›´æ¥è¿è¡Œçš„ç±»ä¼¼äºåŸå§‹æ±‡ç¼–çš„æŒ‡ä»¤ï¼Œè€Œä¸ç”¨äººä»¬å¯ä»¥ç›´æ¥é˜…è¯»çš„æºä»£ç ã€‚</p>
<p>æœ€åï¼Œæˆ‘ä»¬å¤„äºåç«¯ï¼Œä»å±±çš„å¦ä¸€ç«¯å¾€ä¸‹èµ°ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å¯¹äºä»£ç çš„è¡¨ç¤ºè¶Šæ¥è¶ŠåŸå§‹ï¼Œå’Œä¸Šå±±æ–¹å‘ç›¸åï¼Œæˆ‘ä»¬å¸Œæœ›ä»£ç å˜ä¸ºæœºå™¨å¯ä»¥ç›´æ¥è¿è¡Œçš„å½¢å¼ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦å†³å®šï¼Œæ˜¯ç”ŸæˆçœŸå®çš„CPUæŒ‡ä»¤ï¼Œè¿˜æ˜¯ç”Ÿæˆè™šæ‹Ÿçš„æŒ‡ä»¤ã€‚å¦‚æœæˆ‘ä»¬ç”ŸæˆçœŸå®çš„æœºå™¨ä»£ç ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥ç›´æ¥åŠ è½½åˆ°èŠ¯ç‰‡ä¸­ã€‚åŸç”Ÿæœ¬æœºä»£ç è¿è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œä½†æ˜¯ï¼Œç”ŸæˆçœŸå®çš„ CPUæŒ‡ä»¤éœ€è¦å¤§é‡çš„å·¥ä½œã€‚ç°åœ¨çš„æ¶æ„ï¼Œæœ‰æˆå †çš„æŒ‡ä»¤é›†ï¼Œå¤æ‚çš„ç®¡é“ï¼Œå’Œèƒ½å¤Ÿå¡æ»¡747é£æœºçš„å†å²é—ç•™åŒ…è¢±ã€‚</p>
<blockquote>
<p>For example, the AAD (â€œASCII Adjust AX Before Divisionâ€) instruction lets you perform division, which sounds useful. Except that instruction takes, as operands, two binary-coded decimal digits packed into a single 16-bit register. When was the last time you needed BCD on a 16-bit machine</p>
<p>ä¸¾ä¾‹ï¼ŒAADæŒ‡ä»¤å¯ä»¥æ‰§è¡Œé™¤æ³•è¿ç®—ï¼Œè¿™å¬èµ·æ¥éå¸¸æœ‰ç”¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒADDæŒ‡ä»¤ä¼šå°†ä¸¤ä¸ªäºŒè¿›åˆ¶ç¼–ç é¢åè¿›åˆ¶æ•°å­—ä½œä¸ºæ“ä½œæ•°å‹ç¼©åˆ°å•ä¸ª16ä½å¯„å­˜å™¨ä¸Šï¼Œä¸Šä¸€æ¬¡ï¼Œä½ éœ€è¦BCDï¼Œå¹¶ä¸”åœ¨16ä½æœºå™¨ï¼Œæ˜¯ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿ</p>
</blockquote>
<p>Speaking the chipâ€™s language also means your compiler is tied to a specific architecture. If your compiler targets x86 machine code, itâ€™s not going to run on an ARM device.  All the way back in the â€™60s, during the Cambrian explosion of computer architectures, that lack of portability was a real obstacle.</p>
<p>To get around that, hackers like Martin Richards and Niklaus Wirth, of BCPL and Pascal fame, respectively, made their compilers produce virtual machine code. Instead of instructions for some real chip, they produced code for a hypothetical, idealized machine. Wirth called this p-code for portable, but today, we generally call it bytecode because each instruction is often a single byte long.</p>
<p>These synthetic instructions are designed to map a little more closely to the languageâ€™s semantics, and not be so tied to the peculiarities of any one computer architecture and its accumulated historical cruft. You can think of it like a dense, binary encoding of the languageâ€™s low-level operations.</p>
<p>è½¬æ¢ä¸ºèŠ¯ç‰‡ç‰¹å®šè¯­è¨€ï¼Œæ„å‘³ç€ä½ çš„ç¼–è¯‘å™¨å’Œç‰¹å®šæ¶æ„ç›¸å…³è”ã€‚å¦‚æœç¼–è¯‘å™¨ä»¥x86 æœºå™¨ä»£ç ä¸ºç›®æ ‡ï¼Œé‚£ä¹ˆå®ƒå°†æ— æ³•åœ¨armæ¶æ„æœºå™¨ä¸Šè¿è¡Œã€‚ä¸€ç›´è¿½æº¯åˆ°ä¸Šä¸–çºª60å¹´ä»£ï¼Œåœ¨å½“æ—¶çš„è®¡ç®—æœºä½“ç³»ç»“æ„çˆ†ç‚¸æ—¶æœŸï¼Œç¼ºä¹å¯ç§»æ¤æ€§çš„ç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç¼ºç‚¹ã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œç¼–ç¨‹é«˜æ‰‹ï¼Œä¾‹å¦‚ï¼šBCPL è¯­è¨€çš„å‘æ˜è€…<a href="https://en.wikipedia.org/wiki/Martin_Richards_(computer_scientist)">Martin Richards</a> å’Œ Pascalè¯­è¨€çš„ä¸»è¦å¼€å‘è€…<a href="https://en.wikipedia.org/wiki/Niklaus_Wirth">Niklaus Wirth</a> ,ä¸çº¦è€ŒåŒçš„ï¼Œè®©ä»–ä»¬å®ç°çš„ç¼–è¯‘å™¨æœ€ç»ˆç”Ÿæˆè™šæ‹Ÿæœºä»£ç ã€‚ä»–ä»¬ä¸ºä¸€ä¸ªå‡æƒ³çš„ã€ç†æƒ³åŒ–çš„æœºå™¨ç”Ÿæˆä»£ç ï¼Œè€Œä¸æ˜¯ä¸ºäº†ä¸€äº›çœŸå®çš„èŠ¯ç‰‡ç”ŸæˆæŒ‡ä»¤ã€‚<a href="https://en.wikipedia.org/wiki/Niklaus_Wirth">Niklaus Wirth</a>ç§°è¿™äº›ä»£ç ä¸ºPä»£ç ï¼Œå› ä¸ºå¯ç§»æ¤å•è¯çš„ç¼©å†™ï¼Œä½†æ˜¯ä»Šå¤©ï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¸ºå­—èŠ‚ç ï¼Œå› ä¸ºæ¯æ¡æŒ‡ä»¤é€šå¸¸åªæœ‰ä¸€ä¸ªå­—èŠ‚é•¿åº¦ã€‚</p>
<p>è¿™äº›åˆæˆæŒ‡ä»¤ï¼Œæ˜¯ä¸ºäº†æ›´åŠ æ¥è¿‘ä»£ç çš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å› ä¸ºæ›´åŠ å…³è”é‚£äº›æ¶æ„æˆ–æ˜¯å…¶åçš„å†å²ã€‚æˆ‘ä»¬å¯ä»¥æƒ³è±¡å­—èŠ‚ç æ˜¯æ›´åŠ åº•å±‚çš„äºŒè¿›åˆ¶ç¼–ç ã€‚</p>
<blockquote>
<p>The basic principle here is that the farther down the pipeline you push the architecture-specific work, the more of the earlier phases you can share across architectures.</p>
<p>åŸºæœ¬çš„åŸåˆ™æ˜¯ï¼Œè¶Šæ™šæŠŠç¼–è¯‘å™¨å±€é™äºç‰¹å®šæ¶æ„ä¸Šï¼Œå°±å¯ä»¥è¶Šå¤šçš„äº«å—ä¸åŒæ¶æ„é—´ä»£ç å…±ç”¨ã€‚</p>
</blockquote>
<blockquote>
<p>There is a tension, though. Many optimizations, like register allocation and instruction selection, work best when they know the strengths and capabilities of a specific chip. Figuring out which parts of your compiler can be shared and which should be target-specific is an art.</p>
<p>ä¸è¿‡ï¼Œå­˜åœ¨ä¸€ç§å‡è¡¡ï¼Œè®¸å¤šä¼˜åŒ–ï¼Œä¾‹å¦‚ï¼šå¯„å­˜å™¨åˆ†é…å’ŒæŒ‡ä»¤é€‰æ‹©ï¼Œå½“ä½ äº†è§£ç‰¹å®šèŠ¯ç‰‡çš„ä¼˜ç‚¹å’Œèƒ½åŠ›æ—¶å€™ï¼Œä½¿ç”¨æ•ˆæœä¼šæ›´å¥½ã€‚ææ¸…æ¥šç¼–è¯‘å™¨å“ªäº›éƒ¨åˆ†å¯ä»¥å…±äº«ï¼Œå“ªäº›éƒ¨åˆ†åªé€‚ç”¨äºç‰¹å®šæ¶æ„ï¼Œæ˜¯ä¸€é—¨è‰ºæœ¯ã€‚</p>
</blockquote>
<h3 id="17-virtual-machine"><a class="header" href="#17-virtual-machine">1.7 Virtual machine</a></h3>
<p>è™šæ‹Ÿæœº</p>
<p>If your compiler produces bytecode, your work isnâ€™t over once thatâ€™s done. Since there is no chip that speaks that bytecode, itâ€™s your job to translate. Again, you have two options. You can write a little mini-compiler for each target architecture that converts the bytecode to native code for that machine. You still have to do work for each chip you support, but this last stage is pretty simple and you get to reuse the rest of the compiler pipeline across all of the machines you support. Youâ€™re basically using your bytecode as an intermediate representation.</p>
<p>Or you can write a virtual machine (VM), a program that emulates a hypothetical chip supporting your virtual architecture at runtime. Running bytecode in a VM is slower than translating it to native code ahead of time because every instruction must be simulated at runtime each time it executes. In return, you get simplicity and portability. Implement your VM in, say, C, and you can run your language on any platform that has a C compiler. This is how the second interpreter we build in this book works.</p>
<p>å¦‚æœä½ çš„ç¼–è¯‘å™¨ï¼Œæœ€ç»ˆäº§ç”Ÿå­—èŠ‚ç ï¼Œé‚£ä¹ˆï¼Œä½ çš„å·¥ä½œè¿˜æ²¡æœ‰ç»“æŸã€‚å¦‚æœä½ çš„å·¥ä½œæ˜¯ç¿»è¯‘çš„è¯ï¼Œé‚£ä¹ˆç°åœ¨æ²¡æœ‰èŠ¯ç‰‡å¯ä»¥ç›´æ¥æ‰§è¡Œå­—èŠ‚ç ã€‚åŒæ ·ï¼Œç°åœ¨ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé€‰æ‹©æ˜¯ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸€ç§ç›®æ ‡æ¶æ„ç¼–å†™ä¸€ä¸ªå°å‹ç¼–è¯‘å™¨ï¼ŒæŠŠå­—èŠ‚ç è½¬æ¢ä¸ºæ¶æ„ä¸­æœºå™¨ä½¿ç”¨çš„æœºå™¨ç ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ”¯æŒçš„æ¯ä¸€ç§èŠ¯ç‰‡ç¼–å†™å¯¹åº”çš„ç¼–è¯‘å™¨ï¼Œä½†æ˜¯æœ€åè¿™ä¸ªé˜¶æ®µéå¸¸ç®€å•ï¼Œä½ ä¹Ÿå¯ä»¥é‡å¤ä½¿ç”¨ç¼–è¯‘å™¨ä¹‹å‰çš„ä»£ç ã€‚æˆ‘ä»¬ä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆçš„å­—èŠ‚ç å½“ä½œä¸­é—´è¡¨ç¤ºã€‚</p>
<p>æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œä¸€ä¸ªåœ¨è¿è¡Œæ—¶å€™ï¼Œæ¨¡æ‹Ÿè™šæ„èŠ¯ç‰‡çš„ç¨‹åºã€‚åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œå­—èŠ‚ç æ¯”ç›´æ¥åœ¨æœ¬æœºè¿è¡Œæœºå™¨ç ï¼Œæ…¢ä¸€äº›ï¼Œå› ä¸ºè™šæ‹Ÿæœºæ¯æ¬¡è¿è¡ŒæŒ‡ä»¤ï¼Œéƒ½å¿…é¡»æ¨¡æ‹Ÿå®é™…æŒ‡ä»¤ã€‚ä½œä¸ºå›æŠ¥ï¼Œæˆ‘ä»¬è·å¾—äº†ç®€å•æ€§å’Œå¯ç§»æ¤æ€§ã€‚å‡è®¾ç”¨Cè¯­è¨€å®ç°è™šæ‹Ÿæœºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•æœ‰Cç¼–è¯‘å™¨çš„æœºå™¨ä¸Šè¿è¡Œä»£ç ã€‚æœ¬ä¹¦ç¬¬äºŒéƒ¨åˆ†å®ç°çš„ç¼–è¯‘å™¨é‡‡ç”¨è¯¥åŸç†ã€‚</p>
<blockquote>
<p>The term â€œvirtual machineâ€ also refers to a different kind of abstraction. A system virtual machine emulates an entire hardware platform and operating system in software. This is how you can play Windows games on your Linux machine, and how cloud providers give customers the user experience of controlling their own â€œserverâ€ without needing to physically allocate separate computers for each user.</p>
<p>The kind of VMs weâ€™ll talk about in this book are language virtual machines or process virtual machines if you want to be unambiguous.</p>
<p>æœ¯è¯­è™šæ‹Ÿæœºæ˜¯ä¸€ç§æŠ½è±¡ã€‚ä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„è™šæ‹Ÿæœºï¼Œä¼šæ¨¡æ‹Ÿæ•´ä¸ªç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿã€‚è¿™å°±æ˜¯ï¼Œä½ å¯ä»¥åœ¨LinuxæœåŠ¡å™¨ä¸Šç©Windowsæ¸¸æˆçš„åŸå› ï¼Œè¿˜æœ‰ï¼Œè¿™ä¹Ÿæ˜¯äº‘æœåŠ¡å‚å•†ï¼Œä¸ºç”¨æˆ·åˆ†é…æŒ‡å®šçš„äº‘æœåŠ¡å™¨ï¼Œè€Œä¸éœ€è¦çœŸå®æä¾›å¯¹åº”çš„æœºå™¨çš„åŸå› ã€‚</p>
<p>ä½†æ˜¯ï¼Œæœ¬ä¹¦ä¸­æ¶‰åŠåˆ°çš„è™šæ‹Ÿæœºï¼Œåªæ˜¯è¯­è¨€è™šæ‹Ÿæœºæˆ–è€…è¿›ç¨‹è™šæ‹Ÿæœºï¼Œå¦‚æœä½ æƒ³è¦ä¸€ä¸ªå‡†ç¡®çš„æè¿°è¯ã€‚</p>
</blockquote>
<h3 id="18-runtime"><a class="header" href="#18-runtime">1.8 Runtime</a></h3>
<p>è¿è¡Œæ—¶</p>
<p>We have finally hammered the userâ€™s program into a form that we can execute. The last step is running it. If we compiled it to machine code, we simply tell the operating system to load the executable and off it goes. If we compiled it to bytecode, we need to start up the VM and load the program into that.</p>
<p>In both cases, for all but the basest of low-level languages, we usually need some services that our language provides while the program is running. For example, if the language automatically manages memory, we need a garbage collector going in order to reclaim unused bits. If our language supports â€œinstance ofâ€ tests so you can see what kind of object you have, then we need some representation to keep track of the type of each object during execution.</p>
<p>All of this stuff is going at runtime, so itâ€™s called, appropriately, the runtime. In a fully compiled language, the code implementing the runtime gets inserted directly into the resulting executable.  In, say, Go, each compiled application has its own copy of Goâ€™s runtime directly embedded in it. If the language is run inside an interpreter or VM, then the runtime lives there. This is how most implementations of languages like Java, Python, and JavaScript work.</p>
<p>æœ€ç»ˆï¼Œæˆ‘ä»¬ç»ˆäºæŠŠç”¨æˆ·ç¨‹åºï¼Œè½¬æ¢ä¸ºä¸€ç§å¯ä»¥æ‰§è¡Œçš„å½¢å¼ã€‚æœ€åä¸€æ­¥æ˜¯è¿è¡Œï¼Œå¦‚æœæˆ‘ä»¬æœ€åç¼–è¯‘ä¸ºæœºå™¨ç ï¼Œæˆ‘ä»¬åªéœ€è¦åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶åè¿è¡Œã€‚å¦‚æœå°†å…¶ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œæˆ‘ä»¬éœ€è¦å¯åŠ¨è™šæ‹Ÿæœºï¼ŒæŠŠç¼–è¯‘çš„å­—èŠ‚ç åŠ è½½åˆ°è™šæ‹Ÿæœºä¸­ã€‚</p>
<p>åœ¨ä¸¤ç§åœºæ™¯ä¸‹ï¼Œé™¤äº†æœ€åŸºæœ¬çš„ä½å±‚è¯­è¨€ï¼Œå½“ç¨‹åºè¿è¡Œæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›ä¸€äº›å…¶ä»–æœåŠ¡ã€‚ä¾‹å¦‚ï¼šå¦‚æœè¯­è¨€æ˜¯è‡ªåŠ¨ç®¡ç†å†…å­˜çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œå›æ”¶ä¸å†ä½¿ç”¨çš„å†…å­˜ã€‚å¦‚æœæˆ‘ä»¬å®ç°çš„è¯­è¨€ï¼Œæ”¯æŒå®ä¾‹æµ‹è¯•ï¼Œä»¥ä¾¿äºè·å–å¯¹è±¡çš„å®é™…æ•°æ®ç±»å‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€äº›åŠŸèƒ½ï¼Œè·Ÿè¸ªè¿è¡Œæ—¶å€™çš„å¯¹è±¡ã€‚</p>
<p>æ‰€æœ‰è¿™äº›éƒ½å‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œæ—¶å€™ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ç§°å‘¼è¿™ä¸ªé˜¶æ®µä¸ºè¿è¡Œæ—¶ã€‚åœ¨ä¸€ä¸ªå®Œå…¨ç¼–è¯‘çš„è¯­è¨€ä¸­ï¼Œè¿è¡Œæ—¶ï¼Œä»£ç å°†ç›´æ¥æ’å…¥åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚ä¸¾ä¾‹ï¼Œåœ¨goè¯­è¨€ä¸­ï¼Œæ¯ä¸ªç¼–è¯‘çš„åº”ç”¨ç¨‹åºéƒ½æœ‰è‡ªå·±çš„ goè¿è¡Œæ—¶å‰¯æœ¬ï¼Œç›´æ¥åµŒå…¥å…¶ä¸­ã€‚å¦‚æœè¯­è¨€åœ¨è§£é‡Šå™¨æˆ–è€…è™šæ‹Ÿæœºä¸­è¿è¡Œï¼Œé‚£ä¹ˆè¿è¡Œæ—¶å°±åœ¨å…¶ä¸­ã€‚è¿™ä¹Ÿæ˜¯ Java/Python/JavaScriptç­‰è¯­è¨€çš„è¿è¡Œå·¥ä½œæ–¹å¼ã€‚</p>
<h2 id="äºŒshortcuts-and-alternate-routes"><a class="header" href="#äºŒshortcuts-and-alternate-routes">äºŒã€Shortcuts and Alternate Routes</a></h2>
<p>å¿«æ·æ–¹å¼å’Œå¤‡é€‰è·¯å¾„</p>
<p>Thatâ€™s the long path covering every possible phase you might implement. Many languages do walk the entire route, but there are a few shortcuts and alternate paths.</p>
<p>è¿™ä¸€æ¡æ¼«é•¿çš„è·¯ï¼Œå¯èƒ½åŒ…å«ä½ çš„å®ç°çš„æ¯ä¸€ä¸ªé˜¶æ®µã€‚è®¸å¤šè¯­è¨€è´¯ç©¿äº†æ•´ä¸ªè¿‡ç¨‹ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›è¯­è¨€ï¼Œä¼šåŒ…å«æ·å¾„å’Œå…¶ä»–å¤‡é€‰è·¯å¾„ã€‚</p>
<h3 id="21-single-pass-compilers"><a class="header" href="#21-single-pass-compilers">2.1 Single-pass compilers</a></h3>
<p>å•é€šé“ç¼–è¯‘å™¨</p>
<p>Some simple compilers interleave parsing, analysis, and code generation so that they produce output code directly in the parser, without ever allocating any syntax trees or other IRs. These single-pass compilers restrict the design of the language. You have no intermediate data structures to store global information about the program, and you donâ€™t revisit any previously parsed part of the code. That means as soon as you see some expression, you need to know enough to correctly compile it.</p>
<p>Pascal and C were designed around this limitation. At the time, memory was so precious that a compiler might not even be able to hold an entire source file in memory, much less the whole program. This is why Pascalâ€™s grammar requires type declarations to appear first in a block. Itâ€™s why in C you canâ€™t call a function above the code that defines it unless you have an explicit forward declaration that tells the compiler what it needs to know to generate code for a call to the later function.</p>
<p>ä¸€äº›ç®€å•çš„ç¼–è¯‘å™¨ï¼Œä¼šæŠŠè§£æé˜¶æ®µã€åˆ†æé˜¶æ®µã€ä»£ç ç”Ÿæˆé˜¶æ®µæ··æ‚åœ¨ä¸€èµ·ï¼Œå®ƒä»¬ç›´æ¥åœ¨è§£æè¿‡ç¨‹ç”Ÿæˆä»£ç ï¼Œè€Œä¸éœ€è¦ç”Ÿæˆè¯­æ³•æ ‘æˆ–è€…å…¶ä»–ä¸­é—´è¡¨ç¤ºã€‚è¿™äº›å•é€šé“ç¼–è¯‘å™¨é™åˆ¶äº†è¯­è¨€çš„è®¾è®¡ã€‚ä½ æ²¡æœ‰ä¸­é—´æ•°æ®ç»“æ„æ¥å­˜å‚¨æœ‰å…³ç¨‹åºçš„å…¨å±€ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•é‡æ–°è®¿é—®ä»»ä½•ä¹‹å‰è§£æè¿‡çš„ä»£ç ã€‚è¿™æ„å‘³ç€ï¼Œä¸€æ—¦çœ‹åˆ°æŸä¸ªè¡¨è¾¾å¼ï¼Œæˆ‘ä»¬éœ€è¦è¶³å¤Ÿçš„ä¿¡æ¯æ¥ï¼Œæ­£ç¡®çš„ç¼–è¯‘è¡¨è¾¾å¼ã€‚</p>
<p>Pascal å’Œ Cè¯­è¨€æ˜¯å›´ç»•ä¸Šé¢çš„é™åˆ¶è®¾è®¡çš„ã€‚å½“æ—¶ï¼Œå†…å­˜éå¸¸å®è´µï¼Œç¼–è¯‘å™¨ç”šè‡³æ— æ³•å°†æ•´ä¸ªæºæ–‡ä»¶æ”¾å…¥åˆ°å†…å­˜ä¸­ï¼Œæ›´ä¸ç”¨è¯´åœ¨å†…å­˜ä¸­ï¼Œä¿å­˜æ•´ä¸ªç¨‹åºäº†ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆPascalè¯­è¨€è¦æ±‚ç±»å‹å£°æ˜é¦–å…ˆå‡ºç°åœ¨ä»£ç å—ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨Cè¯­è¨€ä¸­ï¼Œé™¤éæœ‰ä¸€ä¸ªæ˜ç¡®çš„æ­£å‘å£°æ˜ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨ç”Ÿæˆè°ƒç”¨åé¢çš„å‡½æ•°æ‰€éœ€è¦çš„ä»£ç ï¼Œå¦åˆ™æ— æ³•åœ¨å‡½æ•°å®šä¹‰çš„ä½ç½®ä¸Šé¢ï¼Œè°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<blockquote>
<p>Syntax-directed translation is a structured technique for building these all-at-once compilers. You associate an action with each piece of the grammar, usually one that generates output code. Then, whenever the parser matches that chunk of syntax, it executes the action, building up the target code one rule at a time.</p>
<p>è¯­æ³•å®šå‘ç¿»è¯‘æ˜¯ä¸€ç§ç»“æ„åŒ–æŠ€æœ¯ï¼Œç”¨äºåŒæ—¶æ„å»ºè¿™äº›ç¼–è¯‘å™¨ï¼Œå°†æ¯ä¸€ä¸ªåŠ¨ä½œå’Œæ¯ä¸€ä¸ªè¯­æ³•ç‰‡æ®µç›¸å…³è”ï¼Œé€šå¸¸æ˜¯è¾“å‡ºä»£ç çš„è¯­æ³•ç‰‡æ®µã€‚ç„¶åï¼Œæ¯å½“è§£æå™¨åŒ¹é…è¯¥è¯­æ³•å—æ—¶å€™ï¼Œå®ƒä¼šæ‰§è¡Œæ“ä½œï¼Œä¸€æ¬¡å»ºç«‹ä¸€ä¸ªè§„åˆ™çš„ç›®æ ‡ä»£ç ã€‚</p>
</blockquote>
<h3 id="22-tree-walk-interpreters"><a class="header" href="#22-tree-walk-interpreters">2.2 Tree-walk interpreters</a></h3>
<p>æ ‘éå†è§£é‡Šå™¨</p>
<p>Some programming languages begin executing code right after parsing it to an AST (with maybe a bit of static analysis applied). To run the program, the interpreter traverses the syntax tree one branch and leaf at a time, evaluating each node as it goes.</p>
<p>This implementation style is common for student projects and little languages, but is not widely used for general-purpose languages since it tends to be slow. Some people use â€œinterpreterâ€ to mean only these kinds of implementations, but others define that word more generally, so Iâ€™ll use the inarguably explicit tree-walk interpreter to refer to these. Our first interpreter rolls this way.</p>
<p>è®¸å¤šçš„è¯­è¨€ï¼Œåœ¨è§£æé˜¶æ®µç”Ÿæˆäº†è¯­æ³•æ ‘åï¼Œå°±å¼€å§‹æ‰§è¡Œä»£ç ï¼ˆå¯èƒ½ä¼šä½¿ç”¨ä¸€äº›é™æ€åˆ†æï¼‰ã€‚ä¸ºäº†è¿è¡Œç¨‹åºï¼Œè§£é‡Šå™¨æ¯ä¸€æ¬¡éƒ½ä¼šéå†è¯­æ³•æ ‘çš„ä¸€ä¸ªåˆ†æ”¯å’Œå¶èŠ‚ç‚¹ï¼Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹è¿è¡Œæ—¶å€™ï¼Œè¿›è¡Œè¯„ä¼°ã€‚</p>
<p>è¿™ç§å®ç°é£æ ¼ï¼Œåœ¨å­¦ç”Ÿä½œä¸šå’Œå°çš„è¯­è¨€ä¸­éå¸¸å¸¸è§ï¼Œä½†æ˜¯ï¼Œç”±äºè¿è¡Œé€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ²¡æœ‰å¹¿æ³›çš„åº”ç”¨äºé€šç”¨çš„è¯­è¨€ã€‚ä¸€äº›äººä½¿ç”¨è§£é‡Šå™¨ï¼Œè¡¨ç¤ºè¿™ç§ç±»å‹çš„å®ç°ï¼Œä½†æ˜¯ï¼Œå¦å¤–ä¸€äº›äººï¼Œä½¿ç”¨æ›´åŠ ä¸€èˆ¬çš„æœ¯è¯­æè¿°è¿™ç§å®ç°æ–¹å¼ï¼Œæœ¬ä¹¦ä¸­æˆ‘ä½¿ç”¨æ ‘éå†è§£é‡Šå™¨æ¥æè¿°è¿™ç§å®ç°ã€‚æˆ‘ä»¬ç¬¬ä¸€ä¸ªå®ç°Loxè¯­è¨€é‡‡ç”¨è¿™ç§å®ç°é£æ ¼ã€‚</p>
<blockquote>
<p>A notable exception is early versions of Ruby, which were tree walkers. At 1.9, the canonical implementation of Ruby switched from the original MRI (Matzâ€™s Ruby Interpreter) to Koichi Sasadaâ€™s YARV (Yet Another Ruby VM). YARV is a bytecode virtual machine.</p>
<p>ä¸€ä¸ªè‘—åçš„ä¾‹å­æ˜¯ï¼ŒRubyè¯­è¨€çš„æ—©æœŸç‰ˆæœ¬ï¼Œä½¿ç”¨äº†æ ‘éå†é£æ ¼çš„å®ç°æ–¹å¼ã€‚åœ¨1.9ç‰ˆæœ¬ï¼ŒRubyçš„å®ç°ä»æ—©æœŸçš„MRIå˜æ›´ä¸ºYARVï¼ŒYARVæ˜¯ä¸€ä¸ªå­—èŠ‚ç è™šæ‹Ÿæœºã€‚</p>
</blockquote>
<h3 id="23-transpilers"><a class="header" href="#23-transpilers">2.3 Transpilers</a></h3>
<p>è½¬æ¢æœº</p>
<p>Writing a complete back end for a language can be a lot of work. If you have some existing generic IR to target, you could bolt your front end onto that. Otherwise, it seems like youâ€™re stuck. But what if you treated some other source language as if it were an intermediate representation?</p>
<p>Writing a complete back end for a language can be a lot of work. If you have some existing generic IR to target, you could bolt your front end onto that. Otherwise, it seems like youâ€™re stuck. But what if you treated some other source language as if it were an intermediate representation?</p>
<p>You write a front end for your language. Then, in the back end, instead of doing all the work to lower the semantics to some primitive target language, you produce a string of valid source code for some other language thatâ€™s about as high level as yours. Then, you use the existing compilation tools for that language as your escape route off the mountain and down to something you can execute.</p>
<p>They used to call this a source-to-source compiler or a transcompiler. After the rise of languages that compile to JavaScript in order to run in the browser, theyâ€™ve affected the hipster sobriquet transpiler.</p>
<p>ä¸ºä¸€ç§è¯­è¨€ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„åç«¯ï¼Œéœ€è¦å¾ˆå¤šçš„å·¥ä½œã€‚å¦‚æœä½ æœ‰ä¸€äº›ç°æœ‰çš„é€šç”¨åç«¯ç›®æ ‡ï¼Œé‚£ä¹ˆä½ å¯ä»¥æŠŠå‰ç«¯è®¾è®¡ä¸ºé€šç”¨åç«¯çš„åŒ¹é…å‰ç«¯ã€‚å¦åˆ™çš„è¯ï¼Œä½ ä¼¼ä¹å¡åœ¨è¿™é‡Œäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ æŠŠå…¶ä»–çš„è¯­è¨€è§†ä¸ºä¸€ç§ä¸­é—´è¡¨ç¤ºï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•åŒ¹é…ï¼Ÿ</p>
<p>ä½ ä¸ºè‡ªå·±çš„è¯­è¨€ç¼–å†™äº†å‰ç«¯ï¼Œç„¶åï¼Œåœ¨åç«¯ï¼Œä½ çš„æƒ³æ³•ä¸æ˜¯ï¼ŒæŠŠç”¨æˆ·ç¨‹åºçš„è¯­ä¹‰å˜æ›´ä¸ºåº•å±‚åŸå§‹çš„ç›®æ ‡è¯­è¨€ï¼Œè€Œæ˜¯æŠŠç”¨æˆ·è¯­ä¹‰è½¬æ¢ä¸ºä¸€ä¸ªæ›´é«˜çº§è¯­è¨€çš„æºä»£ç ã€‚ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ç§é«˜çº§è¯­è¨€çš„å·²ç»å­˜åœ¨çš„ç¼–è¯‘å™¨ï¼Œä½œä¸ºä¸‹å±±çš„å¤‡é€‰è·¯å¾„ã€‚</p>
<p>åœ¨ä»¥å‰ï¼Œè¿™ç§å®ç°æ–¹å¼è¢«ç§°ä¸ºæºä»£ç åˆ°æºä»£ç ç¼–è¯‘å™¨æˆ–è€… è½¬æ¢ç¼–è¯‘å™¨ï¼Œå½“å‡ºç°äº†ä¸€äº›è¯­è¨€ï¼Œä¸ºäº†èƒ½åœ¨æµè§ˆå™¨è¿è¡Œï¼Œï¼Œæœ€ç»ˆç¼–è¯‘ä¸ºJavaScriptåï¼Œå¤§å®¶æƒ³åˆ°äº†ä¸€ä¸ªæ–°çš„åç§° è½¬æ¢æœº æ¥æè¿°ã€‚</p>
<p>While the first transcompiler translated one assembly language to another, today, most transpilers work on higher-level languages. After the viral spread of UNIX to machines various and sundry, there began a long tradition of compilers that produced C as their output language. C compilers were available everywhere UNIX was and produced efficient code, so targeting C was a good way to get your language running on a lot of architectures.</p>
<p>Web browsers are the â€œmachinesâ€ of today, and their â€œmachine codeâ€ is JavaScript, so these days it seems almost every language out there has a compiler that targets JS since thatâ€™s the main way to get your code running in a browser.</p>
<p>The front endâ€”scanner and parserâ€”of a transpiler looks like other compilers. Then, if the source language is only a simple syntactic skin over the target language, it may skip analysis entirely and go straight to outputting the analogous syntax in the destination language.</p>
<p>If the two languages are more semantically different, youâ€™ll see more of the typical phases of a full compiler including analysis and possibly even optimization. Then, when it comes to code generation, instead of outputting some binary language like machine code, you produce a string of grammatically correct source (well, destination) code in the target language.</p>
<p>Either way, you then run that resulting code through the output languageâ€™s existing compilation pipeline, and youâ€™re good to go.</p>
<p>è™½ç„¶ç¬¬ä¸€ä¸ªè½¬æ¢æœºï¼ŒæŠŠä¸€ç§æ±‡ç¼–è¯­è¨€è½¬æ¢ä¸ºå¦å¤–ä¸€ç§æ±‡ç¼–è¯­è¨€ï¼Œä½†æ˜¯ç°åœ¨ï¼Œæˆ‘ä»¬å¸¸å¸¸æŠŠä¸€é—¨è¯­è¨€è½¬æ¢ä¸ºæ›´åŠ é«˜çº§çš„è¯­è¨€ã€‚å› ä¸ºUNIXçš„é£é¡ï¼Œç¼–è¯‘å™¨å¼€å§‹äº†ä¸€ä¸ªä¼ ç»Ÿï¼Œé‚£å°±æ˜¯æŠŠè½¬æ¢æœºè¾“å‡ºè¯­è¨€å˜ä¸º Cè¯­è¨€ã€‚Cè¯­è¨€ç¼–è¯‘å™¨ï¼Œå­˜åœ¨äºä»»æ„çš„UNIXç³»ç»Ÿä¸­ï¼Œæ”¯æŒæ›´å¤šçš„æ¶æ„ï¼Œå¹¶ä¸”Cç¼–è¯‘å™¨å¯ä»¥ç”Ÿæˆæ›´åŠ é«˜æ•ˆçš„ä»£ç ï¼Œå› æ­¤ï¼ŒæŠŠCè¯­è¨€ä½œä¸ºè¾“å‡ºç›®æ ‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹å‘ã€‚</p>
<p>ç°åœ¨ï¼Œwebæµè§ˆå™¨æ˜¯ä¸€ç§æ–°å‹æœºå™¨ï¼Œè¿™ç§æ–°æœºå™¨çš„è¿è¡Œä»£ç æ˜¯JavaScriptï¼Œæ‰€ä»¥ç°åœ¨å¾ˆå¤šè¯­è¨€éƒ½æœ‰ä¸€ä¸ªé’ˆå¯¹JSçš„ç¼–è¯‘å™¨ï¼Œæœ€ç»ˆè¾“å‡ºJSä»£ç ï¼Œè¿™æ ·å¯ä»¥è®©æ–°çš„è¯­è¨€è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚<a href="https://github.com/jashkenas/coffeescript/wiki/list-of-languages-that-compile-to-js">è¯¦ç»†æ¸…å•</a></p>
<p>è½¬æ¢æœºçš„å‰ç«¯éƒ¨åˆ†ï¼Œæ‰«æé˜¶æ®µã€è§£æé˜¶æ®µï¼Œå’Œå…¶ä»–çš„ç¼–è¯‘å™¨ç›¸ä¼¼ï¼Œç„¶è€Œï¼Œå¦‚æœæ–°è¯­è¨€åªæ˜¯ç›®æ ‡è¯­è¨€çš„ä¸€ä¸ªç®€å•çš®è‚¤ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å¯èƒ½ä¼šå®Œå…¨è·³è¿‡åˆ†æé˜¶æ®µï¼Œç›´æ¥è¾“å‡ºç›®æ ‡è¯­è¨€ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœè¿™ä¸¤ç§è¯­è¨€ï¼Œåœ¨è¯­ä¹‰ä¸Šéå¸¸ä¸ç›¸åŒï¼Œé‚£ä¹ˆï¼Œä½ å¯èƒ½ä¼šæ·»åŠ ä¸€äº›ä¼ ç»Ÿç¼–è¯‘å™¨çš„å…¶ä»–é˜¶æ®µï¼Œä¾‹å¦‚ï¼šåˆ†æé˜¶æ®µï¼Œä¼˜åŒ–é˜¶æ®µã€‚ä½†æ˜¯ï¼Œæœ€ç»ˆä»£ç ç”Ÿæˆé˜¶æ®µï¼Œæˆ‘ä»¬ä¸ä¼šç”Ÿæˆä¼ ç»Ÿçš„æœºå™¨ç æˆ–è€…å­—èŠ‚ç ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€ä¸ªè¯­æ³•æ­£ç¡®çš„ç›®æ ‡è¯­è¨€å­—ç¬¦ä¸²ã€‚</p>
<p>æ— è®ºå¦‚ä½•ï¼Œä½ éƒ½å¯ä»¥åœ¨ç¼–è¯‘åï¼Œè·å–åˆ°ç›®æ ‡è¯­è¨€çš„æºä»£ç ï¼Œç„¶åé€šè¿‡ç›®æ ‡è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œå¼€å§‹è¿è¡Œæ–°è¯­è¨€ã€‚</p>
<blockquote>
<p>The first transcompiler, XLT86, translated 8080 assembly into 8086 assembly. That might seem straightforward, but keep in mind the 8080 was an 8-bit chip and the 8086 a 16-bit chip that could use each register as a pair of 8-bit ones. XLT86 did data flow analysis to track register usage in the source program and then efficiently map it to the register set of the 8086.</p>
<p>It was written by Gary Kildall, a tragic hero of computer science if there ever was one. One of the first people to recognize the promise of microcomputers, he created PL/M and CP/M, the first high-level language and OS for them.</p>
<p>He was a sea captain, business owner, licensed pilot, and motorcyclist. A TV host with the Kris Kristofferson-esque look sported by dashing bearded dudes in the â€™80s. He took on Bill Gates and, like many, lost, before meeting his end in a biker bar under mysterious circumstances. He died too young, but sure as hell lived before he did.</p>
<p>ç¬¬ä¸€ä¸ªè½¬æ¢æœºï¼ŒXLT86ï¼ŒæŠŠ8080 æ±‡ç¼–è½¬æ¢ä¸º8086æ±‡ç¼–ï¼Œè¿™çœ‹èµ·æ¥ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†æ˜¯ï¼Œè¯·æ³¨æ„ï¼Œ8080æ˜¯ä¸€ä¸ª8ä½èŠ¯ç‰‡ï¼Œè€Œ8086æ˜¯ä¸€ä¸ª16ä½èŠ¯ç‰‡ï¼Œå¯ä»¥å°†8086çš„å¯„å­˜å™¨ï¼Œä½œä¸º8080çš„ä¸€å¯¹å¯„å­˜å™¨ä½¿ç”¨ï¼ŒXLT86è¿›è¡Œäº†æ•°æ®æµåˆ†æï¼Œç”¨äºè·Ÿè¸ªæºç¨‹åºä¸­çš„å¯„å­˜å™¨ä½¿ç”¨ï¼Œç„¶åï¼Œæœ‰æ•ˆçš„æŠŠè¿™äº›å¯„å­˜å™¨ï¼Œæ˜ å°„ä¸º8086çš„å¯„å­˜å™¨é›†ã€‚</p>
<p>XLT86 æ˜¯ç”±Gary KIldallå®ç°çš„ï¼Œä»–æ˜¯è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä¸€ä¸ªæ‚²å‰§äººç‰©ï¼Œä½œä¸ºæœ€æ—©è®¤è¯†åˆ°å¾®å‹è®¡ç®—æœºå‰æ™¯çš„äººä¹‹ä¸€ï¼Œä»–å¼€å‘äº†PL/M å’Œ CP/Mï¼Œè€ŒCP/Mæ˜¯ç¬¬ä¸€ç§å’Œæ“ä½œç³»ç»Ÿäº¤äº’çš„é«˜çº§è¯­è¨€ã€‚</p>
</blockquote>
<blockquote>
<p>JS used to be the only way to execute code in a browser. Thanks to WebAssembly, compilers now have a second, lower-level language they can target that runs on the web.</p>
<p>JSæ›¾ç»æ˜¯æµè§ˆå™¨ä¸­å”¯ä¸€çš„è¿è¡Œè¯­è¨€ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å¤šäº†ä¸€ç§é€‰æ‹© <a href="https://webassembly.org/">WebAssembly</a>, ç¼–è¯‘å™¨ç°åœ¨æ‹¥æœ‰äº†ç¬¬äºŒç§å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨è¿è¡Œçš„è¯­è¨€ã€‚</p>
</blockquote>
<h3 id="24-just-in-time-compilation"><a class="header" href="#24-just-in-time-compilation">2.4 Just-in-time compilation</a></h3>
<p>å³æ—¶ç¼–è¯‘</p>
<p>This last one is less a shortcut and more a dangerous alpine scramble best reserved for experts. The fastest way to execute code is by compiling it to machine code, but you might not know what architecture your end userâ€™s machine supports. What to do?</p>
<p>You can do the same thing that the HotSpot Java Virtual Machine (JVM), Microsoftâ€™s Common Language Runtime (CLR), and most JavaScript interpreters do. On the end userâ€™s machine, when the program is loadedâ€”either from source in the case of JS, or platform-independent bytecode for the JVM and CLRâ€”you compile it to native code for the architecture their computer supports. Naturally enough, this is called just-in-time compilation. Most hackers just say â€œJITâ€, pronounced like it rhymes with â€œfitâ€.</p>
<p>The most sophisticated JITs insert profiling hooks into the generated code to see which regions are most performance critical and what kind of data is flowing through them. Then, over time, they will automatically recompile those hot spots with more advanced optimizations.</p>
<p>æœ€åä¸€ä¸ªä¸æ˜¯æ·å¾„ï¼Œè€Œæ˜¯å±é™©çš„é«˜å±±æ”€å²©ï¼Œæœ€å¥½ç•™ç»™ä¸“å®¶ã€‚æœ€å¿«çš„ä»£ç æ‰§è¡Œé€Ÿåº¦ï¼Œè‚¯å®šæ˜¯ç¿»è¯‘ä¸ºå…·ä½“çš„æœºå™¨ç ï¼Œä½†æ˜¯ï¼Œç¼–è¯‘é˜¶æ®µï¼Œä½ å¯èƒ½ä¸çŸ¥é“ç”¨æˆ·çš„æœºå™¨æ˜¯ä»€ä¹ˆæ¶æ„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>ä½ å¯ä»¥å€Ÿé‰´JVMï¼ˆJavaè¯­è¨€è™šæ‹Ÿæœºï¼‰ï¼ŒCLRï¼ˆå¾®è½¯çš„é€šç”¨è¯­è¨€è¿è¡Œåº“ï¼‰ï¼Œè¿˜æœ‰å¤§å¤šæ•°JSç¼–è¯‘å™¨åšçš„ï¼Œåœ¨ç”¨æˆ·çš„æœºå™¨ä¸Šï¼Œå½“ç¨‹åºåŠ è½½æ—¶å€™ï¼Œæ— è®ºæ˜¯ä»æºä»£ç ï¼Œè¿˜æ˜¯åœ¨JVM/CLRä¸­åŠ è½½å­—èŠ‚ç ï¼Œä½ å¯ä»¥å°†å…¶ç¼–è¯‘ä¸ºæœ¬æœºçš„æœºå™¨ç ã€‚å¾ˆè‡ªç„¶çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºå³æ—¶ç¼–è¯‘ã€‚å¤§å¤šæ•°ç¼–ç¨‹é«˜æ‰‹ç§°è¿™ç§å®ç°ä¸ºJITï¼Œå‘éŸ³ç±»ä¼¼fitã€‚</p>
<p>æœ€å¤æ‚çš„JITï¼Œä¼šåœ¨ç”Ÿæˆä»£ç ä¸­æ’å…¥ä¸€äº›æ€§èƒ½åˆ†æä»£ç ï¼ŒæŸ¥çœ‹å“ªäº›ä»£ç å—ã€å“ªäº›æ•°æ®ç»“æ„å¯¹äºè¿è¡Œæ€§èƒ½å½±å“æœ€å¤§ã€‚ç„¶åï¼Œéšç€æ—¶é—´ç´¯ç§¯ï¼ŒJITå°†è‡ªåŠ¨ä½¿ç”¨æ›´é«˜çº§çš„ä¼˜åŒ–æ–¹å¼ï¼Œé‡æ–°ç¼–è¯‘çƒ­ç‚¹ä»£ç ã€‚</p>
<blockquote>
<p>This is, of course, exactly where the HotSpot JVM gets its name.</p>
<p>å½“ç„¶ï¼Œè¿™ä¹Ÿæ˜¯JVMçš„ä¸€ç§å®ç°ï¼ŒHotSpot JVMçš„åç§°æ¥æºã€‚</p>
</blockquote>
<h2 id="ä¸‰compilers-and-interpreters"><a class="header" href="#ä¸‰compilers-and-interpreters">ä¸‰ã€Compilers and Interpreters</a></h2>
<p>ç¼–è¯‘å™¨å’Œè§£é‡Šå™¨</p>
<p>Now that Iâ€™ve stuffed your head with a dictionaryâ€™s worth of programming language jargon, we can finally address a question thatâ€™s plagued coders since time immemorial: Whatâ€™s the difference between a compiler and an interpreter?</p>
<p>It turns out this is like asking the difference between a fruit and a vegetable. That seems like a binary either-or choice, but actually â€œfruitâ€ is a botanical term and â€œvegetableâ€ is culinary. One does not strictly imply the negation of the other. There are fruits that arenâ€™t vegetables (apples) and vegetables that arenâ€™t fruits (carrots), but also edible plants that are both fruits and vegetables, like tomatoes.</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¤§è„‘ä¸­å·²ç»å¡æ»¡äº†å„ç§ç¼–è¯‘æœ¯è¯­ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è§£å†³ä¸€ä¸ªè‡ªå¤ä»¥æ¥å°±å›°æ‰°ç€ç¨‹åºå‘˜çš„é—®é¢˜ï¼Œç¼–è¯‘å™¨å’Œè§£é‡Šå™¨æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<p>å®é™…ä¸Šï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ç±»æ¯”ä¸ºï¼Œæ°´æœå’Œè”¬èœæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¿™ä¸ªç­”æ¡ˆçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªäºŒé€‰ä¸€é—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œæ°´æœæ˜¯ä¸€ä¸ªæ¤ç‰©å­¦æœ¯è¯­ï¼Œè”¬èœåˆ™æ˜¯ä¸€ä¸ªçƒ¹é¥ªç”¨è¯­ï¼Œä¸€ä¸ªä¸œè¥¿æ˜¯æ°´æœå¹¶ä¸ä»£è¡¨å®ƒä¸å¯ä»¥æ˜¯è”¬èœï¼Œç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æŸäº›æ°´æœï¼Œä¸æ˜¯è”¬èœï¼Œä¾‹å¦‚ï¼šè‹¹æœï¼›ä¹Ÿå¯ä»¥æ‰¾åˆ°æŸäº›è”¬èœï¼Œä¸å±äºæ°´æœï¼Œä¾‹å¦‚ï¼šèƒ¡èåœï¼›ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°ï¼ŒæŸäº›ä¸œè¥¿ï¼Œå³æ˜¯æ°´æœï¼Œä¹Ÿæ˜¯è”¬èœï¼Œä¾‹å¦‚ï¼šè¥¿çº¢æŸ¿ã€‚</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/plants.png?raw=true" alt="plants" /></p>
<p>So, back to languages:</p>
<ul>
<li>
<p>Compiling is an implementation technique that involves translating a source language to some otherâ€”usually lower-levelâ€”form. When you generate bytecode or machine code, you are compiling. When you transpile to another high-level language, you are compiling too.</p>
</li>
<li>
<p>When we say a language implementation â€œis a compilerâ€, we mean it translates source code to some other form but doesnâ€™t execute it. The user has to take the resulting output and run it themselves.</p>
</li>
<li>
<p>Conversely, when we say an implementation â€œis an interpreterâ€, we mean it takes in source code and executes it immediately. It runs programs â€œfrom sourceâ€.</p>
</li>
</ul>
<p>é‚£ä¹ˆï¼Œè¿”å›åˆ°è¯­è¨€éƒ¨åˆ†ï¼Œ</p>
<ul>
<li>
<p>ç¼–è¯‘æ˜¯ä¸€ç§å®ç°æŠ€æœ¯ï¼Œé€šå¸¸æ˜¯å°†æºè¯­è¨€è½¬æ¢ä¸ºæ›´åŠ ä½çº§åˆ«çš„å½¢å¼ï¼Œå½“ä½ æŠŠä¸€é—¨è¯­è¨€ç¼–è¯‘ä¸ºå­—èŠ‚ç æˆ–è€…æœºå™¨ç æ—¶å€™ï¼Œä½ ä½¿ç”¨äº†ç¼–è¯‘æŠ€æœ¯ï¼Œå½“ä½ è½¬æ¢ä¸ºå¦å¤–ä¸€ç§é«˜çº§è¯­è¨€æ—¶å€™ï¼Œä½ ä¹Ÿåœ¨ä½¿ç”¨ç¼–è¯‘ã€‚</p>
</li>
<li>
<p>å½“æˆ‘ä»¬è¯´å®ç°äº†ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œæˆ‘ä»¬çš„æ„æ€æ˜¯ï¼Œå°†æºè¯­è¨€è½¬æ¢ä¸ºå…¶ä»–å½¢å¼ï¼Œä½†æ˜¯å¹¶ä¸æ‰§è¡Œï¼Œç”¨æˆ·éœ€è¦è·å–åˆ°ç¼–è¯‘ç»“æœï¼Œç„¶åå†è¿è¡Œã€‚</p>
</li>
<li>
<p>å¯¹åº”çš„ï¼Œå½“æˆ‘ä»¬è¯´å®ç°äº†ä¸€ä¸ªè§£é‡Šå™¨ï¼Œæˆ‘ä»¬çš„æ„æ€æ˜¯ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œæºä»£ç ï¼Œçœ‹èµ·æ¥ï¼Œæˆ‘ä»¬å¥½åƒæ˜¯ç›´æ¥ä»æºè¯­è¨€è¿è¡Œã€‚</p>
</li>
</ul>
<p>Like apples and oranges, some implementations are clearly compilers and not interpreters. GCC and Clang take your C code and compile it to machine code. An end user runs that executable directly and may never even know which tool was used to compile it. So those are compilers for C.</p>
<p>In older versions of Matzâ€™s canonical implementation of Ruby, the user ran Ruby from source. The implementation parsed it and executed it directly by traversing the syntax tree. No other translation occurred, either internally or in any user-visible form. So this was definitely an interpreter for Ruby.</p>
<blockquote>
<p>Peanuts (which are not even nuts) and cereals like wheat are actually fruit, but I got this drawing wrong. What can I say, Iâ€™m a software engineer, not a botanist. I should probably erase the little peanut guy, but heâ€™s so cute that I canâ€™t bear to.</p>
<p>Now pine nuts, on the other hand, are plant-based foods that are neither fruits nor vegetables. At least as far as I can tell.</p>
</blockquote>
<p>åƒè‹¹æœå’Œæ©˜å­ä¸€æ ·ï¼Œå®ƒä»¬æ˜¯æ°´æœä½†ä¸æ˜¯è”¬èœï¼Œæœ‰ä¸€äº›å®ç°ï¼Œæ˜¯ç¼–è¯‘å™¨ï¼Œè€Œä¸æ˜¯è§£é‡Šå™¨ã€‚GCCå’ŒClang æ¥æ”¶åŸå§‹çš„Cè¯­è¨€ç¨‹åºï¼Œæœ€ç»ˆç¼–è¯‘ä¸ºæœºå™¨ç ã€‚ç”¨æˆ·æœ€ç»ˆè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œè€Œä¸éœ€è¦çŸ¥é“å…·ä½“ä½¿ç”¨äº†å“ªä¸ªç¼–è¯‘å™¨ï¼Œå®ƒä»¬éƒ½æ˜¯Cè¯­è¨€ç¼–è¯‘å™¨ã€‚</p>
<p>Rubyçš„è€ç‰ˆæœ¬ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä»Rubyæºç è¿è¡Œã€‚Rubyè§£é‡Šå™¨ç›´æ¥è§£ææºç¨‹åºï¼Œç”Ÿæˆè¯­æ³•æ ‘ï¼Œç„¶åï¼Œéå†è¯­æ³•æ ‘ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— è®ºå¤„äºç”¨æˆ·è§’åº¦ï¼Œè¿˜æ˜¯å®é™…å†…éƒ¨æœºåˆ¶ï¼Œéƒ½æ²¡æœ‰å…¶ä»–çš„è½¬æ¢è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šè¿™ç§å®ç°ä¸ºè§£é‡Šå™¨ã€‚</p>
<p>But what of CPython? When you run your Python program using it, the code is parsed and converted to an internal bytecode format, which is then executed inside the VM. From the userâ€™s perspective, this is clearly an interpreterâ€”they run their program from source. But if you look under CPythonâ€™s scaly skin, youâ€™ll see that there is definitely some compiling going on.</p>
<p>The answer is that it is both. CPython is an interpreter, and it has a compiler. In practice, most scripting languages work this way, as you can see:</p>
<p><img src="https://github.com/Kua-Fu/blog-book-images/blob/main/crafting-interpreters/venn.png?raw=true" alt="venn" /></p>
<p>ä½†æ˜¯ï¼ŒCPythonæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“æˆ‘ä»¬è¿è¡ŒPythonç¨‹åºæ—¶å€™ï¼ŒCPythonç¼–è¯‘å™¨å°†Pythonä»£ç è½¬æ¢ä¸ºå†…éƒ¨çš„å­—èŠ‚ç ï¼Œåœ¨Pythonè™šæ‹Ÿæœºä¸­è¿è¡Œã€‚ä»ç”¨æˆ·è§’åº¦çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»åŸå§‹ä»£ç è¿è¡Œï¼Œä½†æ˜¯å¦‚æœä»å†…éƒ¨å®ç°è§’åº¦ï¼Œè¿˜å­˜åœ¨ç€ä¸€äº›ç¼–è¯‘å™¨ã€‚</p>
<p>å‡†ç¡®ç­”æ¡ˆæ˜¯ï¼ŒCPythonæ—¢æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå®é™…ä¸Šï¼Œå¤§éƒ¨åˆ†çš„è„šæœ¬è¯­è¨€éƒ½æ˜¯è¿™æ ·çš„</p>
<p>That overlapping region in the center is where our second interpreter lives too, since it internally compiles to bytecode. So while this book is nominally about interpreters, weâ€™ll cover some compilation too.</p>
<p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬ç¬¬äºŒéƒ¨åˆ†å®ç°çš„Loxè§£é‡Šå™¨ï¼Œå¤„äºä¸­é—´çš„é‡å éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šç”Ÿæˆå­—èŠ‚ç ã€‚å› æ­¤ï¼Œè™½ç„¶æœ¬ä¹¦æ˜¯å…³äºè§£é‡Šå™¨ä»‹ç»çš„ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¼šæ¶‰åŠåˆ°ç¼–è¯‘å™¨çš„å†…å®¹ã€‚</p>
<blockquote>
<p>The Go tool is even more of a horticultural curiosity. If you run go build, it compiles your Go source code to machine code and stops. If you type go run, it does that, then immediately executes the generated executable.</p>
<p>So go is a compiler (you can use it as a tool to compile code without running it), is an interpreter (you can invoke it to immediately run a program from source), and also has a compiler (when you use it as an interpreter, it is still compiling internally).</p>
<p>goè¯­è¨€çš„å‘½ä»¤æ›´åŠ èƒ½è¯´æ˜é—®é¢˜ï¼Œä¾‹å¦‚ï¼šæ‰§è¡Œå‘½ä»¤ go buildï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¦‚æœæ‰§è¡Œå‘½ä»¤ï¼Œgo runï¼Œç¨‹åºä¼šé©¬ä¸Šè¿è¡Œã€‚</p>
<p>æ‰€ä»¥ï¼Œgoæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå¯ä»¥å°†goç¨‹åºç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œgoä¹Ÿæ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œgoç¨‹åºï¼Œä½†æ˜¯è§£é‡Šå™¨ä¸­è¿˜åŒ…å«ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œå½“ç›´æ¥è¿è¡Œgoç¨‹åºæ—¶å€™ï¼Œå†…éƒ¨ä»æœ‰ç¼–è¯‘æ­¥éª¤ã€‚</p>
</blockquote>
<h2 id="å››our-journey"><a class="header" href="#å››our-journey">å››ã€Our Journey</a></h2>
<p>æˆ‘ä»¬çš„æ—…é€”</p>
<p>Thatâ€™s a lot to take in all at once. Donâ€™t worry. This isnâ€™t the chapter where youâ€™re expected to understand all of these pieces and parts. I just want you to know that they are out there and roughly how they fit together.</p>
<p>This map should serve you well as you explore the territory beyond the guided path we take in this book. I want to leave you yearning to strike out on your own and wander all over that mountain.</p>
<p>But, for now, itâ€™s time for our own journey to begin. Tighten your bootlaces, cinch up your pack, and come along. From here on out, all you need to focus on is the path in front of you.</p>
<p>æœ¬ç« ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šå†…å®¹ï¼Œåˆ«æ‹…å¿ƒï¼Œä½ ä¸éœ€è¦ç°åœ¨å°±ç†è§£æ‰€æœ‰å†…å®¹ï¼Œæˆ‘ä»¬åªæ˜¯ï¼Œå…ˆä»‹ç»å®ƒä»¬ï¼Œä½ éœ€è¦çŸ¥é“å®ƒä»¬æ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”éœ€è¦çŸ¥é“å®ƒä»¬æ˜¯å¦‚ä½•ç»“åˆåœ¨ä¸€èµ·çš„ã€‚</p>
<p>æœ¬ç« æ¶‰åŠçš„åœ°å›¾å°†å¾ˆå¥½çš„é™ªä¼´ç€ä½ ï¼Œå› ä¸ºå®ƒåŒ…å«æœ‰ä¸€äº›å†…å®¹ï¼Œæœ¬ä¹¦ä¸­ä¸ä¼šæ¶‰åŠåˆ°ã€‚æˆ‘æƒ³è¦ç¦»å¼€ä½ ï¼Œè®©ä½ ç‹¬è‡ªå»æ¢ç´¢ã€äº«å—çˆ¬å±±çš„è¿‡ç¨‹ã€‚</p>
<p>ä½†æ˜¯ï¼Œç°åœ¨è¿˜ä¸æ˜¯ç‹¬è‡ªæ¢ç´¢çš„æ—¶å€™ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å¼€å¯æ—…ç¨‹ã€‚ç³»ç´§é‹å¸¦ï¼Œæ”¶å¥½èƒŒåŒ…ï¼Œè·Ÿä¸Šæ¥ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œä½ éœ€è¦å…³æ³¨çœ¼å‰çš„é“è·¯ã€‚</p>
<blockquote>
<p>Henceforth, I promise to tone down the whole mountain metaphor thing.</p>
<p>ä»ä»Šå¾€åï¼Œæˆ‘ä¼šæ·¡åŒ–çˆ¬å±±è¿™ä»¶äº‹æƒ…ã€‚</p>
</blockquote>
<h2 id="äº”challenges"><a class="header" href="#äº”challenges">äº”ã€CHALLENGES</a></h2>
<p>ä¹ é¢˜é›†</p>
<ol>
<li>
<p>Pick an open source implementation of a language you like. Download the source code and poke around in it. Try to find the code that implements the scanner and parser. Are they handwritten, or generated using tools like Lex and Yacc? (.l or .y files usually imply the latter.)</p>
<p>é€‰æ‹©ä¸€ç§ä½ ç†Ÿæ‚‰ã€å–œæ¬¢çš„å¼€æºè¯­è¨€ï¼Œä¸‹è½½æºç ç„¶åæµè§ˆä¸€ä¸‹ï¼Œå°è¯•æ‰¾å‡ºå…¶ä¸­çš„æ‰«æå™¨ã€è§£æå™¨éƒ¨åˆ†ï¼Œåˆ¤æ–­å®ƒä»¬æ˜¯è‡ªå·±å®ç°çš„ï¼Œè¿˜æ˜¯ä½¿ç”¨Lex/Yaccç­‰ç¼–è¯‘å™¨å·¥å…·å®ç°çš„ï¼Œå¯ä»¥æŸ¥çœ‹æ˜¯å¦å­˜åœ¨ .l, .y åç¼€çš„æ–‡ä»¶ï¼Œè¿™é€šå¸¸æ˜¯å·¥å…·ç”Ÿæˆæ–‡ä»¶ã€‚</p>
</li>
<li>
<p>Just-in-time compilation tends to be the fastest way to implement dynamically typed languages, but not all of them use it. What reasons are there to not JIT?</p>
<p>å³æ—¶ç¼–è¯‘é€šå¸¸æ˜¯åŠ¨æ€è¯­è¨€æœ€å¿«çš„å®ç°æ–¹å¼ï¼Œä½†æ˜¯å¹¶éæ‰€æœ‰çš„è¯­è¨€éƒ½åˆ©ç”¨è¿™ç§ç‰¹æ€§ï¼Œä¸ºä»€ä¹ˆå®ƒä»¬ä¸æä¾›å³æ—¶ç¼–è¯‘ï¼Ÿ</p>
</li>
<li>
<p>Most Lisp implementations that compile to C also contain an interpreter that lets them execute Lisp code on the fly as well. Why?</p>
<p>å¤§å¤šæ•°çš„Lispå®ç°ï¼Œåœ¨å®ç°ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œç¼–è¯‘ä¸ºCè¯­è¨€çš„åŒæ—¶ï¼Œè¿˜æä¾›ä¸€ä¸ªè§£é‡Šå™¨ï¼Œä¿è¯å¯ä»¥åŠ¨æ€æ‰§è¡ŒLispä»£ç ï¼Œä¸ºä»€ä¹ˆï¼Ÿ</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="loxè¯­è¨€"><a class="header" href="#loxè¯­è¨€">Loxè¯­è¨€</a></h1>
<blockquote>
<p>What nicer thing can you do for somebody than make them breakfast?</p>
<p align="right">â€”â€” Anthony Bourdain</p>
<p>è¿˜æœ‰ä»€ä¹ˆæ¯”ç»™åˆ«äººåšæ—©é¤æ›´å¥½çš„äº‹æƒ…å‘¢ï¼Ÿ</p>
</blockquote>
<p>Weâ€™ll spend the rest of this book illuminating every dark and sundry corner of the Lox language, but it seems cruel to have you immediately start grinding out code for the interpreter without at least a glimpse of what weâ€™re going to end up with.</p>
<p>At the same time, I donâ€™t want to drag you through reams of language lawyering and specification-ese before you get to touch your text editor. So this will be a gentle, friendly introduction to Lox. It will leave out a lot of details and edge cases. Weâ€™ve got plenty of time for those later.</p>
<p>æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦çš„å‰©ä½™éƒ¨åˆ†ï¼Œé˜æ˜Loxè¯­è¨€çš„æ¯ä¸€ä¸ªé»‘æš—å’Œæ‚ä¹±çš„è§’è½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æ— æ³•çœ‹åˆ° Lox è¯­è¨€çš„æœ€ç»ˆæ ·å­ï¼Œå°±å¼€å§‹ç¼–å†™è§£é‡Šå™¨ä»£ç ï¼Œçœ‹èµ·æ¥æœ‰ä¸€äº›åŒ†å¿™ã€‚</p>
<p>åœ¨ä½ ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ä¹‹å‰ï¼Œæˆ‘ä¸æƒ³è¿‡å¤šä»‹ç»è¯­è¨€çš„æ ¼å¼å’Œè§„èŒƒï¼Œæ‰€ä»¥ï¼Œæœ¬ç« å°†æ˜¯ä¸€ä¸ªæ¸©å’Œå‹å¥½çš„Loxä»‹ç»ã€‚å®ƒä¼šé—æ¼å¾ˆå¤šç»†èŠ‚å’Œè¾¹ç¼˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨åé¢æœ‰è¶³å¤Ÿçš„æ—¶é—´å»å­¦ä¹ ã€‚</p>
<blockquote>
<p>A tutorial isnâ€™t very fun if you canâ€™t try the code out yourself. Alas, you donâ€™t have a Lox interpreter yet, since you havenâ€™t built one!</p>
<p>Fear not. You can use mine.</p>
<p>å¦‚æœä¸€ä¸ªæ•™ç¨‹ä¸èƒ½è‡ªå·±å†™ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•™ç¨‹å°±æ²¡æœ‰å¸å¼•åŠ›ã€‚ä½†æ˜¯ï¼Œä½ è¿˜æ²¡æœ‰ä¸€ä¸ªLoxè§£é‡Šå™¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å»å®ç°å®ƒã€‚</p>
<p>ä¸ç”¨æ‹…å¿ƒï¼Œä½ å¯ä»¥å…ˆä½¿ç”¨æˆ‘çš„ğŸ˜„ã€‚</p>
</blockquote>
<h2 id="ä¸€hello-lox"><a class="header" href="#ä¸€hello-lox">ä¸€ã€Hello, Lox</a></h2>
<p>ç¬¬ä¸€ä¸ªç¨‹åº</p>
<pre><code class="language-c">
// Your first Lox program!
print &quot;Hello, world!&quot;;

</code></pre>
<p>Hereâ€™s your very first taste of Lox:</p>
<p>As that // line comment and the trailing semicolon imply, Loxâ€™s syntax is a member of the C family. (There are no parentheses around the string because print is a built-in statement, and not a library function.)</p>
<p>Now, I wonâ€™t claim that C has a great syntax. If we wanted something elegant, weâ€™d probably mimic Pascal or Smalltalk. If we wanted to go full Scandinavian-furniture-minimalism, weâ€™d do a Scheme. Those all have their virtues.</p>
<p>What C-like syntax has instead is something youâ€™ll often find more valuable in a language: familiarity.  I know you are already comfortable with that style because the two languages weâ€™ll be using to implement Loxâ€”Java and Câ€”also inherit it. Using a similar syntax for Lox gives you one less thing to learn.</p>
<p>ä¸Šé¢æ˜¯ç¬¬ä¸€ä¸ªLoxç¨‹åºï¼Œ</p>
<p>æ­£å¦‚ // è¡Œæ³¨é‡Šï¼Œè¡Œå°¾ï¼›æ‰€æš—ç¤ºçš„ï¼ŒLoxè¯­è¨€ï¼Œç»§æ‰¿äº†Cè¯­è¨€è¯­æ³•ã€‚hello, world å­—ç¬¦ä¸²å‘¨å›´ä¸éœ€è¦æ‹¬å·ï¼Œå› ä¸º printæ˜¯ä¸€ä¸ªå†…ç½®è¯­å¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåº“å‡½æ•°ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä¸ä¼šè¯´Cè¯­è¨€æœ‰å¾ˆå¥½çš„è¯­æ³•ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¼˜é›…çš„ä¸œè¥¿ï¼Œå¯èƒ½æ¨¡ä»¿Pascalã€Smalltalkæ›´åŠ åˆé€‚ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å®Œå…¨å®ç° æ–¯å ªçš„çº³ç»´äºšå®¶å…·çš„æç®€ä¸»ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåšä¸€ä¸ªè®¡åˆ’ã€‚è¿™äº›éƒ½æœ‰å®ƒä»¬çš„ä¼˜åŠ¿ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»Cè¯­è¨€è¯­æ³•ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾—æ›´æœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œç†Ÿæ‚‰åº¦ã€‚æˆ‘çŸ¥é“ï¼Œä½ å·²ç»ä¹ æƒ¯äº†è¿™ç§é£æ ¼ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨ä»¥å®ç°Loxçš„ä¸¤ç§è¯­è¨€ï¼ŒJava å’ŒCè¯­è¨€ï¼Œéƒ½æ‹¥æœ‰è¿™ç§ç†Ÿæ‚‰çš„é£æ ¼ã€‚Loxè¯­è¨€ä½¿ç”¨è¿™ç§é£æ ¼çš„è¯­æ³•ï¼Œå¯ä»¥æ›´åŠ å®¹æ˜“å…¥é—¨ã€‚</p>
<blockquote>
<p>Your first taste of Lox, the language, that is. I donâ€™t know if youâ€™ve ever had the cured, cold-smoked salmon before. If not, give it a try too.</p>
<p>ä½ ç¬¬ä¸€æ¬¡å“å°Loxè¯­è¨€ï¼Œå°±æ˜¯è¿™æ ·ã€‚æˆ‘ä¸çŸ¥é“ä½ ä¹‹å‰æœ‰æ²¡æœ‰å°è¯•è¿‡è…Œåˆ¶çš„å†·é²‘é±¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</p>
</blockquote>
<blockquote>
<p>Iâ€™m surely biased, but I think Loxâ€™s syntax is pretty clean. Câ€™s most egregious grammar problems are around types. Dennis Ritchie had this idea called â€œdeclaration reflects useâ€, where variable declarations mirror the operations you would have to perform on the variable to get to a value of the base type.</p>
<p>Lox doesnâ€™t have static types, so we avoid that.</p>
<p>æˆ‘æ˜¯æœ‰åè§çš„ï¼Œä»æˆ‘çš„è§’åº¦ï¼Œæˆ‘è®¤ä¸ºLoxè¯­è¨€è¯­æ³•éå¸¸ç®€æ´ã€‚Cè¯­è¨€ä»¤äººæƒŠè®¶çš„è¯­æ³•é—®é¢˜æ˜¯ï¼Œç±»å‹ã€‚Dennis Ritchie æå‡ºä¸€ä¸ªâ€œå£°æ˜åæ˜ ä½¿ç”¨â€çš„æƒ³æ³•ï¼Œå…¶ä¸­å˜é‡å£°æ˜åæ˜ äº†ä½ å¯¹äºå˜é‡æ‰§è¡Œçš„æ“ä½œï¼Œä»¥è·å¾—åŸºç±»å‹çš„å€¼ã€‚è¿™ä¸ªæƒ³æ³•éå¸¸å¥½ï¼Œä½†æˆ‘è®¤ä¸ºï¼Œåœ¨å®è·µä¸­çš„æ•ˆæœå¹¶ä¸å¥½ã€‚</p>
<p>Loxä¸æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä»¬é¿å…äº†è¿™ç§æƒ…å†µã€‚</p>
</blockquote>
<h2 id="äºŒa-high-level-language"><a class="header" href="#äºŒa-high-level-language">äºŒã€A high-level language</a></h2>
<p>é«˜çº§è¯­è¨€</p>
<p>While this book ended up bigger than I was hoping, itâ€™s still not big enough to fit a huge language like Java in it. In order to fit two complete implementations of Lox in these pages, Lox itself has to be pretty compact.</p>
<p>When I think of languages that are small but useful, what comes to mind are high-level â€œscriptingâ€ languages like JavaScript, Scheme, and Lua. Of those three, Lox looks most like JavaScript, mainly because most C-syntax languages do. As weâ€™ll learn later, Loxâ€™s approach to scoping hews closely to Scheme. The C flavor of Lox weâ€™ll build in Part III is heavily indebted to Luaâ€™s clean, efficient implementation.</p>
<p>è™½ç„¶æœ¬ä¹¦å†…å®¹å¤§å¤§è¶…è¿‡äº†ä¸€å¼€å§‹çš„è®¾æƒ³ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•åˆ©ç”¨ä¸€æœ¬ä¹¦æ¥ä»‹ç»Java è¿™æ ·çš„å¤§å‹è¯­è¨€ã€‚ä¸ºäº†åœ¨æ¥ä¸‹æ¥å»å®ç° Loxè¯­è¨€ä¸¤æ¬¡ï¼ŒLoxæœ¬èº«éœ€è¦éå¸¸ç´§å‡‘ã€‚</p>
<p>å½“æˆ‘ä»¬æåˆ°å°è€Œæœ‰ç”¨çš„è¯­è¨€æ—¶å€™ï¼Œé€šå¸¸ä¼šæƒ³åˆ°çš„æ˜¯ä¸€äº›è„šæœ¬è¯­è¨€ï¼Œä¾‹å¦‚ï¼šJavaScript, Scheme, Lua ç­‰ã€‚åœ¨è¿™ä¸‰ç§è„šæœ¬è¯­è¨€ä¸­ï¼ŒLoxæ›´åƒæ˜¯ JavaScriptï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ç±»C è¯­æ³•ã€‚æ­£å¦‚åé¢å°†è¦ä»‹ç»çš„ï¼ŒLoxçš„ä»£ç å—èŒƒå›´è¡¨ç¤ºï¼Œå’ŒScheme è¯­è¨€ç›¸ä¼¼ã€‚åœ¨ç¬¬ä¸‰éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®ç°çš„Cè¯­è¨€ä¸ºè§£é‡Šå™¨çš„Loxè¯­è¨€ï¼Œå°†æ›´åŠ æ¥è¿‘Luaè¯­è¨€çš„ç®€æ´ã€é«˜æ•ˆç‰¹å¾ã€‚</p>
<p>Lox shares two other aspects with those three languages:</p>
<p>Lox å’Œè„šæœ¬è¯­è¨€è¿˜æœ‰ä¸‹é¢3ä¸ªç›¸åŒç‚¹ï¼š</p>
<h3 id="21-dynamic-typing"><a class="header" href="#21-dynamic-typing">2.1 Dynamic typing</a></h3>
<p>åŠ¨æ€ç±»å‹</p>
<p>Lox is dynamically typed. Variables can store values of any type, and a single variable can even store values of different types at different times. If you try to perform an operation on values of the wrong typeâ€”say, dividing a number by a stringâ€”then the error is detected and reported at runtime.</p>
<p>There are plenty of reasons to like static types, but they donâ€™t outweigh the pragmatic reasons to pick dynamic types for Lox.  A static type system is a ton of work to learn and implement.Skipping it gives you a simpler language and a shorter book. Weâ€™ll get our interpreter up and executing bits of code sooner if we defer our type checking to runtime.</p>
<p>Loxæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å€¼ï¼Œå•ä¸ªå˜é‡å¯ä»¥åœ¨ä¸åŒæ—¶é—´å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚ä½•å°è¯•å¯¹äºé”™è¯¯ç±»å‹çš„å€¼æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚ï¼šæ•°å€¼é™¤ä»¥å­—ç¬¦ä¸²ï¼Œè¿è¡Œæ—¶å€™ä¼šæ£€æµ‹ï¼Œå¹¶ä¸”æŠ¥é”™ã€‚</p>
<p>å–œæ¬¢é™æ€ç±»å‹æœ‰å¾ˆå¤šç†ç”±ï¼Œä½†æ˜¯ä¸ºäº†Loxè¯­è¨€æ›´åŠ å®ç”¨ï¼Œæˆ‘ä»¬é€‰æ‹©äº†åŠ¨æ€ç±»å‹ã€‚é™æ€ç±»å‹ç³»ç»Ÿéœ€è¦å­¦ä¹ å’Œå®ç°å¤§é‡å·¥ä½œã€‚è·³è¿‡é™æ€ç±»å‹ï¼Œä¼šè®©Loxè¯­è¨€å®ç°æ›´åŠ ç®€å•ã€‚å¦‚æœåœ¨è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶å€™ï¼Œæ‰§è¡Œç±»å‹æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¿«çš„æ‰§è¡Œä»£ç ã€‚</p>
<blockquote>
<p>Now that JavaScript has taken over the world and is used to build ginormous applications, itâ€™s hard to think of it as a â€œlittle scripting languageâ€. But Brendan Eich hacked the first JS interpreter into Netscape Navigator in ten days to make buttons animate on web pages. JavaScript has grown up since then, but it was once a cute little language.</p>
<p>æ—¢ç„¶ï¼ŒJavaScriptè¯­è¨€å·²ç»é£é¡è¯­è¨€ä¸–ç•Œï¼Œå¹¶ä¸”ç”¨äºæ„å»ºå¾ˆå¤šçš„å¤§å‹é¡¹ç›®ï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨å°†å®ƒå½“ä½œä¸€ä¸ªå°ä¼—è¯­è¨€ã€‚ä½†æ˜¯ï¼Œåœ¨ç½‘æ™¯å…¬å¸ï¼ŒBrendan Eich ä»…ä»…ä½¿ç”¨äº†10å¤©æ—¶é—´ï¼Œå°±å®Œæˆäº†ç¬¬ä¸€ä¸ªJSç¼–è¯‘å™¨ï¼Œå¹¶ä¸”å®ç°äº†ç½‘é¡µä¸­çš„æŒ‰é’®åŠ¨æ€å±•ç¤ºã€‚JavaScript ä»é‚£æ—¶å¼€å§‹ï¼Œä¸æ–­æˆé•¿ï¼Œä½†æ˜¯å®ƒæ›¾ç»æ˜¯ä¸€é—¨å¯çˆ±çš„å°è¯­è¨€ã€‚</p>
<p>Because Eich slapped JS together with roughly the same raw materials and time as an episode of MacGyver, it has some weird semantic corners where the duct tape and paper clips show through. Things like variable hoisting, dynamically bound this, holes in arrays, and implicit conversions.</p>
<p>å› ä¸ºEichä½¿ç”¨äº†ä¸ã€Šéº¦åŸºå¼—ã€‹ä¸€é›†å¤§è‡´ç›¸åŒçš„åŸææ–™å’Œæ—¶é—´åˆ¶ä½œäº†JSè¯­è¨€ï¼Œæ‰€ä»¥ï¼Œå®ƒå­˜åœ¨ç€ä¸€äº›å¥‡æ€ªçš„è¯­æ³•ï¼Œä¼šå‡ºç°ä¸€äº›èƒ¶å¸¦å’Œå›å½¢é’ˆã€‚ä¾‹å¦‚ï¼šå˜é‡æå‡ï¼ŒåŠ¨æ€ç»‘å®šï¼Œæ•°ç»„ä¸­çš„æ¼æ´å’Œéšå¼è½¬æ¢ã€‚</p>
<p>I had the luxury of taking my time on Lox, so it should be a little cleaner. After all, the two languages weâ€™ll be using to implement Lox are both statically typed.</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘æœ‰æ›´å¤šæ—¶é—´æ‰“ç£¨Loxè¯­è¨€ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼ŒLoxè¯­è¨€ä¼šæ›´åŠ ç®€æ´ã€‚æ¯•ç«Ÿï¼Œæˆ‘ä»¬å®ç°Loxè¯­è¨€çš„åº•å±‚è¯­è¨€Java/Céƒ½æ˜¯é™æ€è¯­è¨€ã€‚</p>
</blockquote>
<h3 id="22-automatic-memory-management"><a class="header" href="#22-automatic-memory-management">2.2 Automatic memory management</a></h3>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†</p>
<p>High-level languages exist to eliminate error-prone, low-level drudgery, and what could be more tedious than manually managing the allocation and freeing of storage? No one rises and greets the morning sun with, â€œI canâ€™t wait to figure out the correct place to call free() for every byte of memory I allocate today!â€</p>
<p>é«˜çº§è¯­è¨€çš„å‡ºç°æ˜¯ä¸ºäº†ï¼Œæ¶ˆé™¤æ›´åŠ å®¹æ˜“å‡ºé”™ã€ä½çº§åˆ«ã€ä¹å‘³çš„å·¥ä½œï¼Œè¿˜æœ‰ä»€ä¹ˆæ¯”æ‰‹åŠ¨ç®¡ç†å†…å­˜åˆ†é…ä¸é‡Šæ”¾ï¼Œæ›´åŠ ç¹çå‘¢ï¼Ÿæ²¡æœ‰äººä¼šç«™èµ·æ¥è¿æ¥å¤ªé˜³ï¼Œæˆ‘å¿ä¸ä½è¦ä¸ºä»Šå¤©åˆ†é…çš„æ¯ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ‰¾åˆ°è°ƒç”¨ free() å‡½æ•°çš„æ­£ç¡®ä½ç½®ã€‚</p>
<p>There are two main techniques for managing memory: reference counting and tracing garbage collection (usually just called garbage collection or GC). Ref counters are much simpler to implementâ€”I think thatâ€™s why Perl, PHP, and Python all started out using them. But, over time, the limitations of ref counting become too troublesome. All of those languages eventually ended up adding a full tracing GC, or at least enough of one to clean up object cycles.</p>
<p>Tracing garbage collection has a fearsome reputation. It is a little harrowing working at the level of raw memory. Debugging a GC can sometimes leave you seeing hex dumps in your dreams. But, remember, this book is about dispelling magic and slaying those monsters, so we are going to write our own garbage collector. I think youâ€™ll find the algorithm is quite simple and a lot of fun to implement.</p>
<p>å†…å­˜ç®¡ç†ä¸»è¦æœ‰ä¸¤ç§æŠ€æœ¯ï¼šå¼•ç”¨è®¡æ•° å’Œ è¿½è¸ªåƒåœ¾å›æ”¶ï¼Œé€šå¸¸ä¹Ÿç§°ä¸ºï¼Œåƒåœ¾å›æ”¶ï¼Œç¼©å†™ä¸º GC</p>
<p>å¼•ç”¨è®¡æ•°çš„å®ç°è¦ç®€å•ä¸€äº›ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯Perl/PHP/Python è¯­è¨€ä¸€å¼€å§‹ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ï¼Œå®ç°å†…å­˜ç®¡ç†çš„åŸå› ã€‚ä½†æ˜¯ï¼Œéšç€æ—¶é—´çš„å˜æ›´ï¼Œå¼•ç”¨è®¡æ•°çš„å±€é™æ€§è¶Šæ¥è¶Šå¤šã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„è¯­è¨€ï¼Œæœ€ç»ˆéƒ½æ·»åŠ äº†å®Œæ•´çš„è¿½è¸ªGC å®ç°ï¼Œæˆ–è€…æœ‰è¶³å¤Ÿçš„ GCé€»è¾‘ å‘¨æœŸæ€§æ¸…ç†å¯¹è±¡ã€‚</p>
<p>è¿½è¸ªåƒåœ¾å›æ”¶å…·æœ‰å¯æ€•çš„åå£°ã€‚åœ¨åŸç”Ÿå†…å­˜çº§åˆ«å·¥ä½œï¼Œéå¸¸ç—›è‹¦ã€‚è°ƒè¯• GCï¼Œä¼šè®©ä½ åœ¨æ¢¦é‡Œéƒ½è¿˜åœ¨æƒ³ç€16è¿›åˆ¶è½¬å‚¨é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œæœ¬ä¹¦ä¼šå¸¦ç€æˆ‘ä»¬ä¸€èµ·é©±æ•£é­”æ³•ï¼Œæ€æ­»æ€ªå…½ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç¼–å†™è‡ªå·±çš„åƒåœ¾å›æ”¶ç¨‹åºã€‚æˆ‘çŒœæƒ³ï¼Œä½ ä¸€å®šä¼šå‘ç°ç®—æ³•éå¸¸ç®€å•ï¼Œå¹¶ä¸”æ•´ä¸ªç¨‹åºéå¸¸æœ‰è¶£ã€‚</p>
<blockquote>
<p>In practice, ref counting and tracing are more ends of a continuum than opposing sides. Most ref counting systems end up doing some tracing to handle cycles, and the write barriers of a generational collector look a bit like retain calls if you squint.</p>
<p>åœ¨å®è·µä¸­ï¼Œå¼•ç”¨è®¡æ•°å’Œè¿½è¸ªæŠ€æœ¯ä¼šæ··åˆä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç›¸äº’å¯¹ç«‹ã€‚å¤§å¤šæ•°çš„å¼•ç”¨è®¡æ•°ï¼Œéƒ½ä¼šè¿›è¡Œä¸€äº›å‘¨æœŸæ€§çš„è¿½è¸ªï¼Œå¦‚æœä½ ä»”ç»†æŸ¥çœ‹ï¼Œåˆ†ä»£é‡‡é›†å™¨çš„ç”¨æ³•çœ‹èµ·æ¥åƒæ˜¯ä¿ç•™è°ƒç”¨ã€‚</p>
<p>For lots more on this, see <a href="https://github.com/Kua-Fu/blog-book-images/blob/main/paper/unified-theory-gc.pdf">â€œA Unified Theory of Garbage Collectionâ€</a> (PDF).</p>
<p>æ›´å¤šçš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://github.com/Kua-Fu/blog-book-images/blob/main/paper/unified-theory-gc.pdf">â€œåƒåœ¾æ”¶é›†çš„ç»Ÿä¸€ç†è®ºâ€</a></p>
</blockquote>
<h2 id="ä¸‰data-types"><a class="header" href="#ä¸‰data-types">ä¸‰ã€Data Types</a></h2>
<p>æ•°æ®ç±»å‹</p>
<p>In Loxâ€™s little universe, the atoms that make up all matter are the built-in data types. There are only a few:</p>
<ol>
<li>
<p><strong>Booleans</strong></p>
<p>You canâ€™t code without logic and you canâ€™t logic without Boolean values. â€œTrueâ€ and â€œfalseâ€, the yin and yang of software. Unlike some ancient languages that repurpose an existing type to represent truth and falsehood, Lox has a dedicated Boolean type. </p>
<p>There are two Boolean values, obviously, and a literal for each one.</p>
<pre><code>
true;  // Not false.
false; // Not *not* false.

</code></pre>
<blockquote>
<p>Boolean variables are the only data type in Lox named after a person, George Boole, which is why â€œBooleanâ€ is capitalized. He died in 1864, nearly a century before digital computers turned his algebra into electricity. I wonder what heâ€™d think to see his name all over billions of lines of Java code.</p>
<p>å¸ƒå°”å˜é‡æ˜¯Loxè¯­è¨€ä¸­ï¼Œå”¯ä¸€ä½¿ç”¨äººåå‘½åçš„æ•°æ®ç±»å‹ã€‚Booleanæ˜¯ä¸ºäº†çºªå¿µ George Boole, ä»–äº1864å¹´å»ä¸–ï¼Œä¸€ä¸ªä¸–çºªåï¼Œè®¡ç®—æœºç§‘å­¦å°†ä»–å‘æ˜çš„å¸ƒå°”ä»£æ•°ï¼Œè½¬æ¢ä¸ºè®¡ç®—æœºè¡¨ç¤ºã€‚æˆ‘æƒ³çŸ¥é“ï¼Œå½“ä»–åœ¨æ•°åäº¿Javaä»£ç ä¸­ï¼Œçœ‹åˆ°è‡ªå·±çš„åå­—ï¼Œä¼šæœ‰ä»€ä¹ˆæ„Ÿæƒ³ğŸ˜„</p>
</blockquote>
</li>
<li>
<p><strong>Numbers</strong></p>
<p>Lox has only one kind of number: double-precision floating point. Since floating-point numbers can also represent a wide range of integers, that covers a lot of territory, while keeping things simple.</p>
<p>Full-featured languages have lots of syntax for numbersâ€”hexadecimal, scientific notation, octal, all sorts of fun stuff. Weâ€™ll settle for basic integer and decimal literals.</p>
<pre><code>
1234;  // An integer.
12.34; // A decimal number.

</code></pre>
</li>
<li>
<p><strong>Strings</strong></p>
<p>Weâ€™ve already seen one string literal in the first example. Like most languages, they are enclosed in double quotes.</p>
<p>As weâ€™ll see when we get to implementing them, there is quite a lot of complexity hiding in that innocuous sequence of characters.</p>
<pre><code>
&quot;I am a string&quot;;
&quot;&quot;;    // The empty string.
&quot;123&quot;; // This is a string, not a number.

</code></pre>
<blockquote>
<p>Even that word â€œcharacterâ€ is a trickster. Is it ASCII? Unicode? A code point or a â€œgrapheme clusterâ€? How are characters encoded? Is each character a fixed size, or can they vary?</p>
<p>å³ä½¿æ˜¯å•è¯ï¼Œå­—èŠ‚ï¼Œä¹ŸåŒ…å«äº†ä¸€äº›éšè—ä¿¡æ¯ï¼Œå­—èŠ‚æ˜¯ASCIIç¼–ç çš„ï¼Œè¿˜æ˜¯Unicodeç¼–ç ï¼›ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªä»£ç ç‚¹ï¼Œè¿˜æ˜¯ä¸€ä¸ªå›¾å½¢é›†ç°‡ï¼›å­—èŠ‚æ˜¯å¦‚ä½•ç¼–ç çš„ï¼Œæ˜¯å®šé•¿ç¼–ç ï¼Œè¿˜æ˜¯å˜é•¿ç¼–ç ï¼Ÿ</p>
</blockquote>
</li>
<li>
<p><strong>Nil</strong></p>
<p>Thereâ€™s one last built-in value whoâ€™s never invited to the party but always seems to show up. It represents â€œno valueâ€. Itâ€™s called â€œnullâ€ in many other languages. In Lox we spell it nil.  (When we get to implementing it, that will help distinguish when weâ€™re talking about Loxâ€™s nil versus Java or Câ€™s null.)</p>
<p>There are good arguments for not having a null value in a language since null pointer errors are the scourge of our industry. If we were doing a statically typed language, it would be worth trying to ban it. In a dynamically typed one, though, eliminating it is often more annoying than having it.</p>
</li>
</ol>
<p>åœ¨Loxçš„å°å®‡å®™ä¸­ï¼Œæ„æˆç‰©è´¨çš„åŸå­æ˜¯å†…ç½®çš„å‡ ç§æ•°æ®ç±»å‹ï¼Œè¯¦è§ä¸‹é¢çš„ä»‹ç»:</p>
<ol>
<li>
<p>å¸ƒå°”ç±»å‹</p>
<p>æ²¡æœ‰é€»è¾‘è¿ç®—ï¼Œæˆ‘ä»¬æ— æ³•è¿›è¡Œç¼–ç¨‹ï¼Œè€Œé€»è¾‘è¿ç®—ï¼Œéœ€è¦å¸ƒå°”æ•°æ®ç±»å‹ã€‚çœŸä¸å‡ï¼Œç¼–ç¨‹ä¸–ç•Œä¸­çš„é˜´ä¸é˜³ï¼Œä¸ä¸€äº›æ—©å…ˆè¯­è¨€å¤ç”¨å…¶ä»–æ•°æ®ç±»å‹è¡¨ç¤ºå¸ƒå°”ç±»å‹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¼šåœ¨Loxè¯­è¨€ä¸­å®šä¹‰ä¸€ä¸ªä¸“ç”¨çš„å¸ƒå°”æ•°æ®ç±»å‹ã€‚</p>
<p>æ˜¾ç„¶ï¼Œå¸ƒå°”å€¼æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œæ¯ä¸ªå€¼å¯¹åº”äº†ä¸€ä¸ªæ–‡æœ¬</p>
<pre><code>true;  // Not false.
false; // Not *not* false.
</code></pre>
</li>
<li>
<p>æ•°å€¼ç±»å‹</p>
<p>Loxè¯­è¨€ï¼Œåªæœ‰ä¸€ç§æ•°å€¼ç±»å‹ï¼ŒåŒç²¾åº¦æµ®ç‚¹æ•°ã€‚å› ä¸ºæµ®ç‚¹æ•°ï¼Œå¯ä»¥åŒ…å«å¤§èŒƒå›´çš„æ•´æ•°ï¼Œè¿™æ ·åšï¼Œä¸ä½†å¯ä»¥åŒ…å«å¾ˆå¤šå…¶ä»–æ•°æ®ç±»å‹ï¼Œè€Œä¸”å¯ä»¥ä¿æŒç®€æ´ã€‚</p>
<p>åŠŸèƒ½é½å…¨çš„è¯­è¨€ï¼Œä¼šæœ‰å¾ˆå¤šçš„æ•°å­—è¯­æ³•ï¼Œä¾‹å¦‚ï¼šåå…­è¿›åˆ¶è¡¨ç¤ºã€ç§‘å­¦è®¡æ•°æ³•ã€å…«è¿›åˆ¶è¡¨ç¤ºï¼Œä»¥åŠå…¶ä»–çš„æœ‰è¶£çš„ä¸œè¥¿ã€‚ä½†æ˜¯åœ¨Loxè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å°†åªä¼šæ»¡è¶³åŸºæœ¬çš„æ•´æ•°è¿ç®—å’Œåè¿›åˆ¶è¡¨ç¤ºã€‚</p>
<pre><code>
1234;  // An integer.
12.34; // A decimal number.

</code></pre>
</li>
<li>
<p>å­—ç¬¦ä¸²</p>
<p>ä»ä¸Šé¢çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²ç±»å‹ &quot;hello, world!&quot;ã€‚ å’Œå¤§å¤šæ•°çš„è¯­è¨€ä¸€æ ·ï¼Œå­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥ã€‚</p>
<p>å½“æˆ‘ä»¬å®ç°å­—ç¬¦ä¸²ç±»å‹æ—¶å€™ï¼Œå°†ä¼šçœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªå®šä¹‰æ˜ç¡®çš„å­—ç¬¦åºåˆ—ä¸­ï¼Œéšè—ç€è®¸å¤šå¤æ‚åœºæ™¯ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p>
<pre><code>
&quot;I am a string&quot;;
&quot;&quot;;    // The empty string.
&quot;123&quot;; // This is a string, not a number.

</code></pre>
</li>
<li>
<p>Nil</p>
<p>æœ€åï¼Œè¿˜æœ‰ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå®ƒä¼¼ä¹ä»æ¥æ²¡æœ‰è¢«é‚€è¯·å‚åŠ ç¼–ç¨‹èšä¼šï¼Œä½†æ˜¯ä½ æ€»æ˜¯èƒ½çœ‹åˆ°å®ƒçš„èº«å½±ã€‚å®ƒï¼Œä»£è¡¨äº†ä¸å­˜åœ¨ï¼Œæ²¡æœ‰æ•°å€¼ã€‚åœ¨è®¸å¤šè¯­è¨€ä¸­ï¼Œä½¿ç”¨ null è¡¨ç¤ºå®ƒï¼Œè€Œåœ¨Loxè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ nil è¡¨ç¤ºå®ƒã€‚å½“æˆ‘ä»¬å®ç°å®ƒæ—¶ï¼Œå¯ä»¥æ›´å¥½çš„ä¸ Java/Cè¯­è¨€ä¸­çš„null åŒºåˆ«å¼€ã€‚</p>
<p>åœ¨è¯­è¨€ä¸­ï¼Œä¸ä½¿ç”¨ nil å­˜åœ¨å¾ˆå¤šå¥½å¤„ï¼Œç©ºæŒ‡é’ˆæŠ¥é”™æ˜¯ç¼–ç¨‹è¡Œä¸šå¸¸è§çš„æŠ¥é”™ã€‚å¦‚æœï¼Œæˆ‘ä»¬è¦å®ç°ä¸€é—¨é™æ€ç±»å‹è¯­è¨€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¦æ­¢ nilç±»å‹æ˜¯å€¼å¾—çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦å®ç°ä¸€é—¨åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œé€šå¸¸ï¼Œä¿ç•™ nilç±»å‹ï¼Œæ‹¥æœ‰æ›´å¤šçš„å¥½å¤„ï¼Œç›¸æ¯”äºç¦æ­¢è¯¥ç±»å‹ã€‚</p>
</li>
</ol>
<h2 id="å››expressions"><a class="header" href="#å››expressions">å››ã€Expressions</a></h2>
<p>è¡¨è¾¾å¼</p>
<p>If built-in data types and their literals are atoms, then expressions must be the molecules. Most of these will be familiar.</p>
<p>å¦‚æœå†…ç½®çš„åŸºç¡€æ•°æ®ç±»å‹å’Œå®ƒä»¬çš„æ–‡å­—ï¼Œæ˜¯åŸå­ï¼Œé‚£ä¹ˆè¡¨è¾¾å¼å°±æ˜¯åˆ†å­ï¼Œä¸‹é¢å°†ä»‹ç»å„ç§è¡¨è¾¾å¼</p>
<h3 id="41-arithmetic"><a class="header" href="#41-arithmetic">4.1 Arithmetic</a></h3>
<p>ç®—æœ¯è¡¨è¾¾å¼</p>
<p>Lox features the basic arithmetic operators you know and love from C and other languages:</p>
<p>Loxè¯­è¨€å…·æœ‰Cè¯­è¨€æˆ–è€…å…¶ä»–è¯­è¨€ä¸­ï¼Œå­˜åœ¨çš„åŸºç¡€ç®—æœ¯è¡¨è¾¾å¼</p>
<pre><code>
add + me;
subtract - me;
multiply * me;
divide / me;

</code></pre>
<p>The subexpressions on either side of the operator are operands. Because there are two of them, these are called binary operators.(It has nothing to do with the ones-and-zeroes use of â€œbinaryâ€.) </p>
<p>Because the operator is fixed in the middle of the operands, these are also called infix operators (as opposed to prefix operators where the operator comes before the operands, and postfix where it comes after).</p>
<p>One arithmetic operator is actually both an infix and a prefix one. The - operator can also be used to negate a number.</p>
<pre><code>-negateMe;
</code></pre>
<p>All of these operators work on numbers, and itâ€™s an error to pass any other types to them. The exception is the + operatorâ€”you can also pass it two strings to concatenate them.</p>
<p>è¿ç®—ç¬¦å·ï¼Œä¸¤è¾¹çš„å­è¡¨è¾¾å¼ï¼Œç§°ä¸ºæ“ä½œæ•°ã€‚å› ä¸ºè¿ç®—ç¬¦å·ï¼Œæœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰€ä»¥ç§°ä¸ºäºŒå…ƒè¿ç®—ç¬¦ã€‚âš ï¸è¿™é‡Œçš„äºŒå…ƒï¼Œå’ŒäºŒè¿›åˆ¶ä¸­çš„0æˆ–è€…1ï¼Œæ²¡æœ‰å…³ç³»ã€‚</p>
<p>å› ä¸ºè¿ç®—ç¬¦ï¼Œå›ºå®šåœ¨æ“ä½œæ•°çš„ä¸­é—´ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸­ç¼€è¿ç®—ç¬¦ã€‚ï¼ˆä¸å‰ç¼€è¿ç®—ç¬¦ä¸åŒï¼Œå‰ç¼€è¿ç®—ç¬¦ä½äºè¡¨è¾¾å¼æœ€å‰é¢ï¼Œåç¼€è¿ç®—ç¬¦ä½äºè¡¨è¾¾å¼æœ€åã€‚ï¼‰</p>
<p>ä¸€å…ƒè¿ç®—ç¬¦ï¼Œå®é™…ä¸Šå¯ä»¥æ˜¯ä¸­ç¼€è¿ç®—ç¬¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å‰ç¼€è¿ç®—ç¬¦ã€‚ä¾‹å¦‚ï¼š- å¯ä»¥è¡¨ç¤ºè´Ÿæ•°</p>
<pre><code>-negateMe;
</code></pre>
<p>ä¸Šé¢çš„ç®—æœ¯è¿ç®—ç¬¦çš„æ“ä½œæ•°ï¼Œåªèƒ½æ˜¯æ•°å€¼ç±»å‹ï¼Œå¦‚æœæ“ä½œæ•°æ˜¯å…¶ä»–æ•°æ®ç±»å‹ï¼Œè¡¨è¾¾å¼è®¡ç®—ä¼šæŠ¥é”™ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸ªä¾‹å¤–ï¼Œ+è¿ç®—ç¬¦å¯ä»¥ä½œç”¨äºå­—ç¬¦ä¸²æ•°æ®ç±»å‹ï¼Œä¸¤ä¸ªå­—ç¬¦ä¸²çš„ + è¿ç®—ï¼Œè¡¨ç¤ºè¿æ¥è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<h3 id="42-comparison-and-equality"><a class="header" href="#42-comparison-and-equality">4.2 Comparison and equality</a></h3>
<p>æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œç›¸ç­‰</p>
<p>Moving along, we have a few more operators that always return a Boolean result. We can compare numbers (and only numbers), using Ye Olde Comparison Operators.</p>
<pre><code>less &lt; than;
lessThan &lt;= orEqual;
greater &gt; than;
greaterThan &gt;= orEqual;
</code></pre>
<p>We can test two values of any kind for equality or inequality. Even different types. Values of different types are never equivalent.</p>
<pre><code>1 == 2;         // false.
&quot;cat&quot; != &quot;dog&quot;; // true.
314 == &quot;pi&quot;; // false.
123 == &quot;123&quot;; // false.
</code></pre>
<p>Iâ€™m generally against implicit conversions.</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»‹ç»å‡ ä¸ªè¿”å›å¸ƒå°”å€¼çš„è¿ç®—ç¬¦ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ æ¯”è¾ƒè¿ç®—ç¬¦ï¼Œæ¯”è¾ƒå¹¶ä¸”ä»…ä»…æ¯”è¾ƒæ•°å€¼</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¯”è¾ƒä¸¤ä¸ªä»»æ„ç±»å‹çš„æ•°æ®ï¼Œæ˜¯å¦ç›¸ç­‰, ç”šè‡³è¿™ä¸¤ä¸ªæ•°æ®ï¼Œä¸æ˜¯ç›¸åŒçš„ç±»å‹ã€‚ä¸åŒæ•°æ®ç±»å‹çš„ä¸¤ä¸ªæ•°æ®ï¼Œè‚¯å®šæ˜¯ä¸æƒ³ç­‰çš„ğŸ¤”ã€‚</p>
<p>é€šå¸¸ï¼Œæˆ‘ä»¬ä¸å»ºè®®ä½¿ç”¨éšå¼è½¬æ¢ã€‚</p>
<h3 id="43-logical-operators"><a class="header" href="#43-logical-operators">4.3 Logical operators</a></h3>
<ol>
<li>
<p>The not operator, a prefix !, returns false if its operand is true, and vice versa.</p>
<pre><code>
!true;  // false.
!false; // true.

</code></pre>
</li>
<li>
<p>The other two logical operators really are control flow constructs in the guise of expressions. An and expression determines if two values are both true. It returns the left operand if itâ€™s false, or the right operand otherwise.</p>
<pre><code>
true and false; // false.
true and true;  // true.

</code></pre>
</li>
<li>
<p>And an or expression determines if either of two values (or both) are true. It returns the left operand if it is true and the right operand otherwise.</p>
</li>
</ol>
<p>The reason and and or are like control flow structures is that they short-circuit. Not only does and return the left operand if it is false, it doesnâ€™t even evaluate the right one in that case. Conversely (contrapositively?), if the left operand of an or is true, the right is skipped.</p>
<p>é€»è¾‘è¿ç®—</p>
<ol>
<li>
<p>é€»è¾‘éè¿ç®—ç¬¦ï¼Œä½¿ç”¨ ï¼è¡¨ç¤ºï¼Œå¦‚æœæ“ä½œæ•°æ˜¯trueï¼Œåˆ™æ·»åŠ é€»è¾‘éçš„è¡¨è¾¾å¼ï¼Œå€¼ä¸ºfalseï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<pre><code>
!true;  // false.
!false; // true.

</code></pre>
</li>
<li>
<p>å¦å¤–ä¸¤ä¸ªé€»è¾‘è¿ç®—ç¬¦ï¼Œä¸å…¶è¯´æ˜¯è¡¨è¾¾å¼ï¼Œæ›´åŠ å‡†ç¡®çš„è¯´æ³•æ˜¯ï¼Œæ§åˆ¶æµã€‚</p>
<p>and é€»è¾‘è¿ç®—ç¬¦ï¼Œå°†ç¡®å®šä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ˜¯å¦éƒ½æ˜¯trueï¼Œå¦‚æœå·¦æ“ä½œæ•°æ˜¯falseï¼Œ åˆ™è¡¨è¾¾å¼è¿”å›å·¦æ“ä½œæ•°çš„å€¼ï¼›å¦‚æœå·¦æ“ä½œæ•°ä¸ºtrueï¼Œåˆ™è¡¨è¾¾å¼è¿”å›å³æ“ä½œæ•°çš„å€¼ã€‚</p>
<pre><code>
true and false; // false.
true and true;  // true.

</code></pre>
</li>
<li>
<p>or é€»è¾‘è¿ç®—ç¬¦ï¼Œå°†ç¡®å®šä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ˜¯å¦åŒ…å«trueï¼Œå¦‚æœå·¦æ“ä½œæ•°ä¸ºtrueï¼Œåˆ™è¡¨è¾¾å¼ç»“æœï¼Œè¿”å›å·¦æ“ä½œæ•°ï¼›å¦‚æœå·¦æ“ä½œæ•°ä¸ºfalseï¼Œè¡¨è¾¾å¼å°†ä¼šè¿”å›å³æ“ä½œæ•°çš„å€¼ã€‚</p>
<pre><code>
false or false; // false.
true or false;  // true.

</code></pre>
</li>
</ol>
<p>and å’Œ or é€»è¾‘è¿ç®—ç¬¦ï¼Œæœ¬è´¨ä¸Šæ˜¯æ§åˆ¶æµç»“æ„çš„åŸå› æ˜¯ï¼Œå®ƒä»¬æ˜¯çŸ­è·¯ã€‚å½“é€»è¾‘è¿ç®—ç¬¦æ˜¯ andï¼Œå·¦æ“ä½œæ•°å€¼ä¸º falseï¼Œæˆ‘ä»¬ç”šè‡³ä¸ä¼šå»è®¡ç®—å³æ“ä½œæ•°ï¼Œç›´æ¥è¿”å›å·¦æ“ä½œæ•°çš„å€¼ã€‚å¦‚æœé€»è¾‘è¿ç®—ç¬¦æ˜¯ orï¼Œå·¦æ“ä½œæ•°å€¼ä¸º trueï¼ŒåŒæ ·çš„ï¼Œæˆ‘ä»¬ä¸ä¼šå»è®¡ç®—å³æ“ä½œæ•°ï¼Œç›´æ¥è¿”å›å·¦æ“ä½œæ•°çš„å€¼ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
