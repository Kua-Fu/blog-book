<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4717236929129160"
     crossorigin="anonymous"></script>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>继承 - crafting-interpreters-zh</title>


        <!-- Custom HTML head -->
	<script src="https://static.guance.com/browser-sdk/v2/dataflux-rum.js" type="text/javascript"></script>
	<script>
	window.DATAFLUX_RUM &&
	window.DATAFLUX_RUM.init({
	applicationId: 'thewind_blog',
	datakitOrigin: 'https://www.poetries.cn/rum', 
	env: 'production',
	version: '1.0.0',
	trackInteractions: true,
	traceType: 'ddtrace',
	allowedTracingOrigins: [/https:\/\/.*\.poetries\.cn/, "https://poetries.cn"], 
	})
	</script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MMN1K84KRS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-MMN1K84KRS');
</script>


        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../index.html">前言</a></li><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">欢迎</li><li class="chapter-item "><a href="../welcome/welcome.html"><strong aria-hidden="true">1.</strong> 欢迎</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../welcome/introduction.html"><strong aria-hidden="true">1.1.</strong> 介绍</a></li><li class="chapter-item "><a href="../welcome/a-map-of-the-territory.html"><strong aria-hidden="true">1.2.</strong> 总览图</a></li><li class="chapter-item "><a href="../welcome/the-lox-language.html"><strong aria-hidden="true">1.3.</strong> Lox语言</a></li></ol></li><li class="chapter-item "><li class="part-title">解析树</li><li class="chapter-item expanded "><a href="../tree/tree.html"><strong aria-hidden="true">2.</strong> 解析树</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tree/scanning.html"><strong aria-hidden="true">2.1.</strong> 扫描</a></li><li class="chapter-item "><a href="../tree/representing-code.html"><strong aria-hidden="true">2.2.</strong> 代码表示</a></li><li class="chapter-item "><a href="../tree/parsing-expression.html"><strong aria-hidden="true">2.3.</strong> 解析表达式</a></li><li class="chapter-item "><a href="../tree/evaluating-expression.html"><strong aria-hidden="true">2.4.</strong> 计算表达式</a></li><li class="chapter-item "><a href="../tree/statements-and-state.html"><strong aria-hidden="true">2.5.</strong> 语句和状态</a></li><li class="chapter-item "><a href="../tree/control-flow.html"><strong aria-hidden="true">2.6.</strong> 控制流程</a></li><li class="chapter-item "><a href="../tree/functions.html"><strong aria-hidden="true">2.7.</strong> 函数</a></li><li class="chapter-item "><a href="../tree/resolving-and-binding.html"><strong aria-hidden="true">2.8.</strong> 解析与绑定</a></li><li class="chapter-item "><a href="../tree/classes.html"><strong aria-hidden="true">2.9.</strong> 类</a></li><li class="chapter-item expanded "><a href="../tree/inheritance.html" class="active"><strong aria-hidden="true">2.10.</strong> 继承</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">crafting-interpreters-zh</h1>

                    <div class="right-buttons">
                        <a href="https://github.com/Kua-Fu/blog-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>


                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="继承"><a class="header" href="#继承">继承</a></h1>
<blockquote>
<p>Once we were blobs in the sea, and then fishes, and then lizards and rats and then monkeys, and hundreds of things in between. This hand was once a fin, this hand once had claws! In my human mouth I have the pointy teeth of a wolf and the chisel teeth of a rabbit and the grinding teeth of a cow! Our blood is as salty as the sea we used to live in! When we’re frightened, the hair on our skin stands up, just like it did when we had fur. We are history! Everything we’ve ever been on the way to becoming us, we still are.</p>
<p align="right"> —— Terry Pratchett, A Hat Full of Sky</p>
<p>曾经我们是海洋中的泥块，然后是鱼，然后是蜥蜴、老鼠，接着是猴子，还有数百种中间形态，这双手曾经是鱼鳍，曾经是爪子，在我们人类的嘴中，有狼的尖牙、兔子的凿齿、牛的磨牙，我们的血液和曾经生活过的海洋一样咸。当我们害怕时候，身上的毛发会树立起来，就像我们还有皮毛一样，我们是历史，曾经经历的一切，都是成为现在的我们的过程中的一部分，我们仍然是那些经历的总和。</p>
<p align="right"> —— Terry Pratchett, A Hat Full of Sky</p>
</blockquote>
<p>Can you believe it? We’ve reached the last chapter of Part II. We’re almost done with our first Lox interpreter. The previous chapter was a big ball of intertwined object-orientation features. I couldn’t separate those from each other, but I did manage to untangle one piece. In this chapter, we’ll finish off Lox’s class support by adding inheritance.</p>
<p>Inheritance appears in object-oriented languages all the way back to the first one, Simula. Early on, Kristen Nygaard and Ole-Johan Dahl noticed commonalities across classes in the simulation programs they wrote. Inheritance gave them a way to reuse the code for those similar parts.</p>
<p>你能相信吗？我们已经到达第二部分的最后一章，我们即将完成第一个解释器，上一章是一个交织着对象导向特性的大球，我无法将其分开，但是，我设法解开了其中的一部分，在本章，我们将添加继承特性来完成Lox语言的类的支持。</p>
<p>继承出现在面向对象的语言中，我们可以追溯到第一个面向对象的语言，Simula, 早期，Kristen Nygaard和Ole-Johan Dahl在编写模拟程序时候，注意到类之间的共性。继承为他们提供了一种复用这些相似部分代码的方式</p>
<blockquote>
<p>You could say all those other languages inherited it from Simula. Hey-ooo! I’ll, uh, see myself out.</p>
<p>你可以说，其他语言的继承都参考了 Simula</p>
</blockquote>
<h2 id="一superclasses-and-subclasses"><a class="header" href="#一superclasses-and-subclasses">一、Superclasses and Subclasses</a></h2>
<p>超类和子类</p>
<p>Given that the concept is “inheritance”, you would hope they would pick a consistent metaphor and call them “parent” and “child” classes, but that would be too easy. Way back when, C. A. R. Hoare coined the term “subclass” to refer to a record type that refines another type. Simula borrowed that term to refer to a class that inherits from another. I don’t think it was until Smalltalk came along that someone flipped the Latin prefix to get “superclass” to refer to the other side of the relationship. From C++, you also hear “base” and “derived” classes. I’ll mostly stick with “superclass” and “subclass”.</p>
<p>鉴于这个概念是继承，你希望他们会选择一个一致的隐喻，称之为父类和子类，这样太容易了。很久以前，C.A.R.Hoare 创造了术语&quot;子类&quot; 来指代一种类型——改进了一种类型。Simula 引入了这个概念，表示从另一个类继承的类。我认为一直到Smalltalk出现，才有人翻转了拉丁前缀，得到超类来指代关系的另一侧，从C++中，你可能还会得到 基类和派生类，多数场景，我会使用超类和子类描述</p>
<p>Our first step towards supporting inheritance in Lox is a way to specify a superclass when declaring a class. There’s a lot of variety in syntax for this. C++ and C# place a : after the subclass’s name, followed by the superclass name. Java uses extends instead of the colon. Python puts the superclass(es) in parentheses after the class name. Simula puts the superclass’s name before the class keyword.</p>
<p>This late in the game, I’d rather not add a new reserved word or token to the lexer. We don’t have extends or even :, so we’ll follow Ruby and use a less-than sign (&lt;).</p>
<p>我们在Lox中支持继承的第一步是，在声明类时候，指定超类的方式。这方面的语法有很多种，</p>
<ul>
<li>
<p>C++ 和 C#，在子类名称后面添加一个冒号，然后是超类名称</p>
<pre><code class="language-C++">class SubclassName : inheritance-access-specifier SuperclassName {
    ......
};
</code></pre>
</li>
<li>
<p>Java使用 extends 代替冒号</p>
<pre><code class="language-java">
public class ArmoredCar extends Car {

}
</code></pre>
</li>
<li>
<p>Python 在类名后面用括号放置超类的名称</p>
<pre><code class="language-python">
class HourlyEmployee(Employee):

</code></pre>
</li>
<li>
<p>Simula 在class 关键字之前放置超类名称</p>
</li>
</ul>
<p>在游戏的最后，我们并不想在词法分析器中，添加新的保留字或者新的token，我们不会使用 extends 或者冒号，我们将参考Ruby的实现方式，使用&lt; 表示继承。</p>
<pre><code class="language-java">

class Doughnut {
  // General doughnut stuff...
}

class BostonCream &lt; Doughnut {
  // Boston Cream-specific stuff...
}

</code></pre>
<p>To work this into the grammar, we add a new optional clause in our existing classDecl rule.</p>
<p>为了将其纳入到语法规则中，我们在classDecl 中添加一个新的分支</p>
<pre><code class="language-java">
classDecl      → &quot;class&quot; IDENTIFIER ( &quot;&lt;&quot; IDENTIFIER )?
                 &quot;{&quot; function* &quot;}&quot; ;
				 
</code></pre>
<p>After the class name, you can have a &lt; followed by the superclass’s name. The superclass clause is optional because you don’t have to have a superclass. Unlike some other object-oriented languages like Java, Lox has no root “Object” class that everything inherits from, so when you omit the superclass clause, the class has no superclass, not even an implicit one.</p>
<p>We want to capture this new syntax in the class declaration’s AST node.</p>
<pre><code class="language-java">
// tool/GenerateAst.java, in main(), replace 1 line

      &quot;Block      : List&lt;Stmt&gt; statements&quot;,
      &quot;Class      : Token name, Expr.Variable superclass,&quot; +
                  &quot; List&lt;Stmt.Function&gt; methods&quot;,
      &quot;Expression : Expr expression&quot;,


</code></pre>
<p>在类名之后，可以紧跟一个小于号，然后是超类的名称，超类子句是可选的，因为我们不是必须指定一个超类，和Java等面向对象的语言不同，Lox语言中没有根类 Object,(所有类都继承Object）。因此，当省略了超类子句时候，该类没有超类，甚至没有隐含的超类。我们将在类声明的AST节点捕获这个新的语法。</p>
<p>You might be surprised that we store the superclass name as an Expr.Variable, not a Token. The grammar restricts the superclass clause to a single identifier, but at runtime, that identifier is evaluated as a variable access. Wrapping the name in an Expr.Variable early on in the parser gives us an object that the resolver can hang the resolution information off of.</p>
<p>The new parser code follows the grammar directly.</p>
<p>你可能会感到惊讶，我们将超类名称存储为Expr.Variable, 而不是Token，语法将超类子句限制为单个标识符，但是在运行时，该标识符将作为变量访问进行计算，在解释器的早期将超类名称包装在 Expr.Variable中，为我们提供了一个对象，解析器可以将解析信息绑定在上面</p>
<p>新的解析器代码将直接遵循语法</p>
<pre><code class="language-java">
// lox/Parser.java, in classDeclaration()

  Token name = consume(IDENTIFIER, &quot;Expect class name.&quot;);

    Expr.Variable superclass = null;
    if (match(LESS)) {
      consume(IDENTIFIER, &quot;Expect superclass name.&quot;);
      superclass = new Expr.Variable(previous());
    }

    consume(LEFT_BRACE, &quot;Expect '{' before class body.&quot;);
	
</code></pre>
<p>Once we’ve (possibly) parsed a superclass declaration, we store it in the AST.</p>
<p>一旦我们解析了超类声明语句，我们将保存超类</p>
<pre><code class="language-java">
// lox/Parser.java, in classDeclaration(), replace 1 line

   consume(RIGHT_BRACE, &quot;Expect '}' after class body.&quot;);

    return new Stmt.Class(name, superclass, methods);
  }


</code></pre>
<p>If we didn’t parse a superclass clause, the superclass expression will be null. We’ll have to make sure the later passes check for that. The first of those is the resolver.</p>
<p>如果没有解析到超类声明子句，超类表达式值为null，我们需要确保后续步骤检查了这一点，第一步是解析器。</p>
<pre><code class="language-java">
// lox/Resolver.java, in visitClassStmt()

    define(stmt.name);

    if (stmt.superclass != null) {
      resolve(stmt.superclass);
    }

    beginScope();
	
</code></pre>
<p>The class declaration AST node has a new subexpression, so we traverse into and resolve that. Since classes are usually declared at the top level, the superclass name will most likely be a global variable, so this doesn’t usually do anything useful. However, Lox allows class declarations even inside blocks, so it’s possible the superclass name refers to a local variable. In that case, we need to make sure it’s resolved.</p>
<p>Because even well-intentioned programmers sometimes write weird code, there’s a silly edge case we need to worry about while we’re in here. Take a look at this:</p>
<p>类声明AST 节点，有一个新的子表达式，因此我们需要遍历并且解析它，由于类通常在顶层声明，因此超类名称很可能是全局变量，因此，这通常不会产生任何有用的结果，但是，Lox允许在块内声明类，因此，超类名称可能引用一个局部变量，在这种情况下，我们需要确保它被解析。</p>
<p>因为即使是有良好意图的程序员，有时候也会写出奇怪的代码，所以，我们需要担心一个愚蠢的边界问题，</p>
<pre><code class="language-java">
class Oops &lt; Oops {}
</code></pre>
<p>There’s no way this will do anything useful, and if we let the runtime try to run this, it will break the expectation the interpreter has about there not being cycles in the inheritance chain. The safest thing is to detect this case statically and report it as an error.</p>
<p>上面的代码没有实际意义，如果在运行时候，尝试运行上面的代码，它会打破解释器对继承链中不存在的循环的预期，最安全的做法是在静态检测时候，检测到这种情况，并且将其报告为错误。</p>
<pre><code class="language-java">
// lox/Resolver.java, in visitClassStmt()

    define(stmt.name);

    if (stmt.superclass != null &amp;&amp;
        stmt.name.lexeme.equals(stmt.superclass.name.lexeme)) {
      Lox.error(stmt.superclass.name,
          &quot;A class can't inherit from itself.&quot;);
    }

    if (stmt.superclass != null) {
	
</code></pre>
<p>Assuming the code resolves without error, the AST travels to the interpreter.</p>
<p>假设代码在解析时候没有报错，AST将被传递到解释器</p>

			<div id="bottom"> 
			     <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>

			     <a href="https://info.flagcounter.com/42Wy"><img src="https://s01.flagcounter.com/count/42Wy/bg_FFFFFF/txt_000000/border_CCCCCC/columns_3/maxflags_9/viewers_0/labels_0/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
		       </div>   	 							 
                       <div id="giscus-container"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <a rel="prev" href="../tree/classes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                        </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tree/classes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../giscus.js"></script>


    </body>


</html>
