<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Loxè¯­è¨€ - crafting-interpreters-zh</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">å‰è¨€</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">æ¬¢è¿</li><li class="chapter-item expanded "><a href="../welcome/welcome.html"><strong aria-hidden="true">1.</strong> æ¬¢è¿</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../welcome/introduction.html"><strong aria-hidden="true">1.1.</strong> ä»‹ç»</a></li></ol></li><li class="chapter-item expanded "><a href="../welcome/a-map-of-the-territory.html"><strong aria-hidden="true">2.</strong> æ€»è§ˆå›¾</a></li><li class="chapter-item expanded "><a href="../welcome/the-lox-language.html" class="active"><strong aria-hidden="true">3.</strong> Loxè¯­è¨€</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">crafting-interpreters-zh</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="loxè¯­è¨€"><a class="header" href="#loxè¯­è¨€">Loxè¯­è¨€</a></h1>
<blockquote>
<p>What nicer thing can you do for somebody than make them breakfast?</p>
<p align="right">â€”â€” Anthony Bourdain</p>
<p>è¿˜æœ‰ä»€ä¹ˆæ¯”ç»™åˆ«äººåšæ—©é¤æ›´å¥½çš„äº‹æƒ…å‘¢ï¼Ÿ</p>
</blockquote>
<p>Weâ€™ll spend the rest of this book illuminating every dark and sundry corner of the Lox language, but it seems cruel to have you immediately start grinding out code for the interpreter without at least a glimpse of what weâ€™re going to end up with.</p>
<p>At the same time, I donâ€™t want to drag you through reams of language lawyering and specification-ese before you get to touch your text editor. So this will be a gentle, friendly introduction to Lox. It will leave out a lot of details and edge cases. Weâ€™ve got plenty of time for those later.</p>
<p>æˆ‘ä»¬å°†åœ¨æœ¬ä¹¦çš„å‰©ä½™éƒ¨åˆ†ï¼Œé˜æ˜Loxè¯­è¨€çš„æ¯ä¸€ä¸ªé»‘æš—å’Œæ‚ä¹±çš„è§’è½ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æ— æ³•çœ‹åˆ° Lox è¯­è¨€çš„æœ€ç»ˆæ ·å­ï¼Œå°±å¼€å§‹ç¼–å†™è§£é‡Šå™¨ä»£ç ï¼Œçœ‹èµ·æ¥æœ‰ä¸€äº›åŒ†å¿™ã€‚</p>
<p>åœ¨ä½ ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ä¹‹å‰ï¼Œæˆ‘ä¸æƒ³è¿‡å¤šä»‹ç»è¯­è¨€çš„æ ¼å¼å’Œè§„èŒƒï¼Œæ‰€ä»¥ï¼Œæœ¬ç« å°†æ˜¯ä¸€ä¸ªæ¸©å’Œå‹å¥½çš„Loxä»‹ç»ã€‚å®ƒä¼šé—æ¼å¾ˆå¤šç»†èŠ‚å’Œè¾¹ç¼˜éƒ¨åˆ†ï¼Œæˆ‘ä»¬åœ¨åé¢æœ‰è¶³å¤Ÿçš„æ—¶é—´å»å­¦ä¹ ã€‚</p>
<blockquote>
<p>A tutorial isnâ€™t very fun if you canâ€™t try the code out yourself. Alas, you donâ€™t have a Lox interpreter yet, since you havenâ€™t built one!</p>
<p>Fear not. You can use mine.</p>
<p>å¦‚æœä¸€ä¸ªæ•™ç¨‹ä¸èƒ½è‡ªå·±å†™ä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•™ç¨‹å°±æ²¡æœ‰å¸å¼•åŠ›ã€‚ä½†æ˜¯ï¼Œä½ è¿˜æ²¡æœ‰ä¸€ä¸ªLoxè§£é‡Šå™¨ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å»å®ç°å®ƒã€‚</p>
<p>ä¸ç”¨æ‹…å¿ƒï¼Œä½ å¯ä»¥å…ˆä½¿ç”¨æˆ‘çš„ğŸ˜„ã€‚</p>
</blockquote>
<h2 id="ä¸€hello-lox"><a class="header" href="#ä¸€hello-lox">ä¸€ã€Hello, Lox</a></h2>
<p>ç¬¬ä¸€ä¸ªç¨‹åº</p>
<pre><code class="language-c">
// Your first Lox program!
print &quot;Hello, world!&quot;;

</code></pre>
<p>Hereâ€™s your very first taste of Lox:</p>
<p>As that // line comment and the trailing semicolon imply, Loxâ€™s syntax is a member of the C family. (There are no parentheses around the string because print is a built-in statement, and not a library function.)</p>
<p>Now, I wonâ€™t claim that C has a great syntax. If we wanted something elegant, weâ€™d probably mimic Pascal or Smalltalk. If we wanted to go full Scandinavian-furniture-minimalism, weâ€™d do a Scheme. Those all have their virtues.</p>
<p>What C-like syntax has instead is something youâ€™ll often find more valuable in a language: familiarity.  I know you are already comfortable with that style because the two languages weâ€™ll be using to implement Loxâ€”Java and Câ€”also inherit it. Using a similar syntax for Lox gives you one less thing to learn.</p>
<p>ä¸Šé¢æ˜¯ç¬¬ä¸€ä¸ªLoxç¨‹åºï¼Œ</p>
<p>æ­£å¦‚ // è¡Œæ³¨é‡Šï¼Œè¡Œå°¾ï¼›æ‰€æš—ç¤ºçš„ï¼ŒLoxè¯­è¨€ï¼Œç»§æ‰¿äº†Cè¯­è¨€è¯­æ³•ã€‚hello, world å­—ç¬¦ä¸²å‘¨å›´ä¸éœ€è¦æ‹¬å·ï¼Œå› ä¸º printæ˜¯ä¸€ä¸ªå†…ç½®è¯­å¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªåº“å‡½æ•°ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä¸ä¼šè¯´Cè¯­è¨€æœ‰å¾ˆå¥½çš„è¯­æ³•ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¼˜é›…çš„ä¸œè¥¿ï¼Œå¯èƒ½æ¨¡ä»¿Pascalã€Smalltalkæ›´åŠ åˆé€‚ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å®Œå…¨å®ç° æ–¯å ªçš„çº³ç»´äºšå®¶å…·çš„æç®€ä¸»ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåšä¸€ä¸ªè®¡åˆ’ã€‚è¿™äº›éƒ½æœ‰å®ƒä»¬çš„ä¼˜åŠ¿ã€‚</p>
<p>ç›¸åï¼Œæˆ‘ä»¬ä½¿ç”¨ç±»Cè¯­è¨€è¯­æ³•ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å¾—æ›´æœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œç†Ÿæ‚‰åº¦ã€‚æˆ‘çŸ¥é“ï¼Œä½ å·²ç»ä¹ æƒ¯äº†è¿™ç§é£æ ¼ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨ä»¥å®ç°Loxçš„ä¸¤ç§è¯­è¨€ï¼ŒJava å’ŒCè¯­è¨€ï¼Œéƒ½æ‹¥æœ‰è¿™ç§ç†Ÿæ‚‰çš„é£æ ¼ã€‚Loxè¯­è¨€ä½¿ç”¨è¿™ç§é£æ ¼çš„è¯­æ³•ï¼Œå¯ä»¥æ›´åŠ å®¹æ˜“å…¥é—¨ã€‚</p>
<blockquote>
<p>Your first taste of Lox, the language, that is. I donâ€™t know if youâ€™ve ever had the cured, cold-smoked salmon before. If not, give it a try too.</p>
<p>ä½ ç¬¬ä¸€æ¬¡å“å°Loxè¯­è¨€ï¼Œå°±æ˜¯è¿™æ ·ã€‚æˆ‘ä¸çŸ¥é“ä½ ä¹‹å‰æœ‰æ²¡æœ‰å°è¯•è¿‡è…Œåˆ¶çš„å†·é²‘é±¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥å°è¯•ä¸€ä¸‹ã€‚</p>
</blockquote>
<blockquote>
<p>Iâ€™m surely biased, but I think Loxâ€™s syntax is pretty clean. Câ€™s most egregious grammar problems are around types. Dennis Ritchie had this idea called â€œdeclaration reflects useâ€, where variable declarations mirror the operations you would have to perform on the variable to get to a value of the base type.</p>
<p>Lox doesnâ€™t have static types, so we avoid that.</p>
<p>æˆ‘æ˜¯æœ‰åè§çš„ï¼Œä»æˆ‘çš„è§’åº¦ï¼Œæˆ‘è®¤ä¸ºLoxè¯­è¨€è¯­æ³•éå¸¸ç®€æ´ã€‚Cè¯­è¨€ä»¤äººæƒŠè®¶çš„è¯­æ³•é—®é¢˜æ˜¯ï¼Œç±»å‹ã€‚Dennis Ritchie æå‡ºä¸€ä¸ªâ€œå£°æ˜åæ˜ ä½¿ç”¨â€çš„æƒ³æ³•ï¼Œå…¶ä¸­å˜é‡å£°æ˜åæ˜ äº†ä½ å¯¹äºå˜é‡æ‰§è¡Œçš„æ“ä½œï¼Œä»¥è·å¾—åŸºç±»å‹çš„å€¼ã€‚è¿™ä¸ªæƒ³æ³•éå¸¸å¥½ï¼Œä½†æˆ‘è®¤ä¸ºï¼Œåœ¨å®è·µä¸­çš„æ•ˆæœå¹¶ä¸å¥½ã€‚</p>
<p>Loxä¸æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä»¬é¿å…äº†è¿™ç§æƒ…å†µã€‚</p>
</blockquote>
<h2 id="äºŒa-high-level-language"><a class="header" href="#äºŒa-high-level-language">äºŒã€A high-level language</a></h2>
<p>é«˜çº§è¯­è¨€</p>
<p>While this book ended up bigger than I was hoping, itâ€™s still not big enough to fit a huge language like Java in it. In order to fit two complete implementations of Lox in these pages, Lox itself has to be pretty compact.</p>
<p>When I think of languages that are small but useful, what comes to mind are high-level â€œscriptingâ€ languages like JavaScript, Scheme, and Lua. Of those three, Lox looks most like JavaScript, mainly because most C-syntax languages do. As weâ€™ll learn later, Loxâ€™s approach to scoping hews closely to Scheme. The C flavor of Lox weâ€™ll build in Part III is heavily indebted to Luaâ€™s clean, efficient implementation.</p>
<p>è™½ç„¶æœ¬ä¹¦å†…å®¹å¤§å¤§è¶…è¿‡äº†ä¸€å¼€å§‹çš„è®¾æƒ³ï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•åˆ©ç”¨ä¸€æœ¬ä¹¦æ¥ä»‹ç»Java è¿™æ ·çš„å¤§å‹è¯­è¨€ã€‚ä¸ºäº†åœ¨æ¥ä¸‹æ¥å»å®ç° Loxè¯­è¨€ä¸¤æ¬¡ï¼ŒLoxæœ¬èº«éœ€è¦éå¸¸ç´§å‡‘ã€‚</p>
<p>å½“æˆ‘ä»¬æåˆ°å°è€Œæœ‰ç”¨çš„è¯­è¨€æ—¶å€™ï¼Œé€šå¸¸ä¼šæƒ³åˆ°çš„æ˜¯ä¸€äº›è„šæœ¬è¯­è¨€ï¼Œä¾‹å¦‚ï¼šJavaScript, Scheme, Lua ç­‰ã€‚åœ¨è¿™ä¸‰ç§è„šæœ¬è¯­è¨€ä¸­ï¼ŒLoxæ›´åƒæ˜¯ JavaScriptï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ç±»C è¯­æ³•ã€‚æ­£å¦‚åé¢å°†è¦ä»‹ç»çš„ï¼ŒLoxçš„ä»£ç å—èŒƒå›´è¡¨ç¤ºï¼Œå’ŒScheme è¯­è¨€ç›¸ä¼¼ã€‚åœ¨ç¬¬ä¸‰éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®ç°çš„Cè¯­è¨€ä¸ºè§£é‡Šå™¨çš„Loxè¯­è¨€ï¼Œå°†æ›´åŠ æ¥è¿‘Luaè¯­è¨€çš„ç®€æ´ã€é«˜æ•ˆç‰¹å¾ã€‚</p>
<p>Lox shares two other aspects with those three languages:</p>
<p>Lox å’Œè„šæœ¬è¯­è¨€è¿˜æœ‰ä¸‹é¢3ä¸ªç›¸åŒç‚¹ï¼š</p>
<h3 id="21-dynamic-typing"><a class="header" href="#21-dynamic-typing">2.1 Dynamic typing</a></h3>
<p>åŠ¨æ€ç±»å‹</p>
<p>Lox is dynamically typed. Variables can store values of any type, and a single variable can even store values of different types at different times. If you try to perform an operation on values of the wrong typeâ€”say, dividing a number by a stringâ€”then the error is detected and reported at runtime.</p>
<p>There are plenty of reasons to like static types, but they donâ€™t outweigh the pragmatic reasons to pick dynamic types for Lox.  A static type system is a ton of work to learn and implement.Skipping it gives you a simpler language and a shorter book. Weâ€™ll get our interpreter up and executing bits of code sooner if we defer our type checking to runtime.</p>
<p>Loxæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„å€¼ï¼Œå•ä¸ªå˜é‡å¯ä»¥åœ¨ä¸åŒæ—¶é—´å­˜å‚¨ä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚ä½•å°è¯•å¯¹äºé”™è¯¯ç±»å‹çš„å€¼æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚ï¼šæ•°å€¼é™¤ä»¥å­—ç¬¦ä¸²ï¼Œè¿è¡Œæ—¶å€™ä¼šæ£€æµ‹ï¼Œå¹¶ä¸”æŠ¥é”™ã€‚</p>
<p>å–œæ¬¢é™æ€ç±»å‹æœ‰å¾ˆå¤šç†ç”±ï¼Œä½†æ˜¯ä¸ºäº†Loxè¯­è¨€æ›´åŠ å®ç”¨ï¼Œæˆ‘ä»¬é€‰æ‹©äº†åŠ¨æ€ç±»å‹ã€‚é™æ€ç±»å‹ç³»ç»Ÿéœ€è¦å­¦ä¹ å’Œå®ç°å¤§é‡å·¥ä½œã€‚è·³è¿‡é™æ€ç±»å‹ï¼Œä¼šè®©Loxè¯­è¨€å®ç°æ›´åŠ ç®€å•ã€‚å¦‚æœåœ¨è§£é‡Šå™¨åœ¨è¿è¡Œæ—¶å€™ï¼Œæ‰§è¡Œç±»å‹æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¿«çš„æ‰§è¡Œä»£ç ã€‚</p>
<blockquote>
<p>Now that JavaScript has taken over the world and is used to build ginormous applications, itâ€™s hard to think of it as a â€œlittle scripting languageâ€. But Brendan Eich hacked the first JS interpreter into Netscape Navigator in ten days to make buttons animate on web pages. JavaScript has grown up since then, but it was once a cute little language.</p>
<p>æ—¢ç„¶ï¼ŒJavaScriptè¯­è¨€å·²ç»é£é¡è¯­è¨€ä¸–ç•Œï¼Œå¹¶ä¸”ç”¨äºæ„å»ºå¾ˆå¤šçš„å¤§å‹é¡¹ç›®ï¼Œæˆ‘ä»¬å¾ˆéš¾åœ¨å°†å®ƒå½“ä½œä¸€ä¸ªå°ä¼—è¯­è¨€ã€‚ä½†æ˜¯ï¼Œåœ¨ç½‘æ™¯å…¬å¸ï¼ŒBrendan Eich ä»…ä»…ä½¿ç”¨äº†10å¤©æ—¶é—´ï¼Œå°±å®Œæˆäº†ç¬¬ä¸€ä¸ªJSç¼–è¯‘å™¨ï¼Œå¹¶ä¸”å®ç°äº†ç½‘é¡µä¸­çš„æŒ‰é’®åŠ¨æ€å±•ç¤ºã€‚JavaScript ä»é‚£æ—¶å¼€å§‹ï¼Œä¸æ–­æˆé•¿ï¼Œä½†æ˜¯å®ƒæ›¾ç»æ˜¯ä¸€é—¨å¯çˆ±çš„å°è¯­è¨€ã€‚</p>
<p>Because Eich slapped JS together with roughly the same raw materials and time as an episode of MacGyver, it has some weird semantic corners where the duct tape and paper clips show through. Things like variable hoisting, dynamically bound this, holes in arrays, and implicit conversions.</p>
<p>å› ä¸ºEichä½¿ç”¨äº†ä¸ã€Šéº¦åŸºå¼—ã€‹ä¸€é›†å¤§è‡´ç›¸åŒçš„åŸææ–™å’Œæ—¶é—´åˆ¶ä½œäº†JSè¯­è¨€ï¼Œæ‰€ä»¥ï¼Œå®ƒå­˜åœ¨ç€ä¸€äº›å¥‡æ€ªçš„è¯­æ³•ï¼Œä¼šå‡ºç°ä¸€äº›èƒ¶å¸¦å’Œå›å½¢é’ˆã€‚ä¾‹å¦‚ï¼šå˜é‡æå‡ï¼ŒåŠ¨æ€ç»‘å®šï¼Œæ•°ç»„ä¸­çš„æ¼æ´å’Œéšå¼è½¬æ¢ã€‚</p>
<p>I had the luxury of taking my time on Lox, so it should be a little cleaner. After all, the two languages weâ€™ll be using to implement Lox are both statically typed.</p>
<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œæˆ‘æœ‰æ›´å¤šæ—¶é—´æ‰“ç£¨Loxè¯­è¨€ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼ŒLoxè¯­è¨€ä¼šæ›´åŠ ç®€æ´ã€‚æ¯•ç«Ÿï¼Œæˆ‘ä»¬å®ç°Loxè¯­è¨€çš„åº•å±‚è¯­è¨€Java/Céƒ½æ˜¯é™æ€è¯­è¨€ã€‚</p>
</blockquote>
<h3 id="22-automatic-memory-management"><a class="header" href="#22-automatic-memory-management">2.2 Automatic memory management</a></h3>
<p>è‡ªåŠ¨å†…å­˜ç®¡ç†</p>
<p>High-level languages exist to eliminate error-prone, low-level drudgery, and what could be more tedious than manually managing the allocation and freeing of storage? No one rises and greets the morning sun with, â€œI canâ€™t wait to figure out the correct place to call free() for every byte of memory I allocate today!â€</p>
<p>é«˜çº§è¯­è¨€çš„å‡ºç°æ˜¯ä¸ºäº†ï¼Œæ¶ˆé™¤æ›´åŠ å®¹æ˜“å‡ºé”™ã€ä½çº§åˆ«ã€ä¹å‘³çš„å·¥ä½œï¼Œè¿˜æœ‰ä»€ä¹ˆæ¯”æ‰‹åŠ¨ç®¡ç†å†…å­˜åˆ†é…ä¸é‡Šæ”¾ï¼Œæ›´åŠ ç¹çå‘¢ï¼Ÿæ²¡æœ‰äººä¼šç«™èµ·æ¥è¿æ¥å¤ªé˜³ï¼Œæˆ‘å¿ä¸ä½è¦ä¸ºä»Šå¤©åˆ†é…çš„æ¯ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ï¼Œæ‰¾åˆ°è°ƒç”¨ free() å‡½æ•°çš„æ­£ç¡®ä½ç½®ã€‚</p>
<p>There are two main techniques for managing memory: reference counting and tracing garbage collection (usually just called garbage collection or GC). Ref counters are much simpler to implementâ€”I think thatâ€™s why Perl, PHP, and Python all started out using them. But, over time, the limitations of ref counting become too troublesome. All of those languages eventually ended up adding a full tracing GC, or at least enough of one to clean up object cycles.</p>
<p>Tracing garbage collection has a fearsome reputation. It is a little harrowing working at the level of raw memory. Debugging a GC can sometimes leave you seeing hex dumps in your dreams. But, remember, this book is about dispelling magic and slaying those monsters, so we are going to write our own garbage collector. I think youâ€™ll find the algorithm is quite simple and a lot of fun to implement.</p>
<p>å†…å­˜ç®¡ç†ä¸»è¦æœ‰ä¸¤ç§æŠ€æœ¯ï¼šå¼•ç”¨è®¡æ•° å’Œ è¿½è¸ªåƒåœ¾å›æ”¶ï¼Œé€šå¸¸ä¹Ÿç§°ä¸ºï¼Œåƒåœ¾å›æ”¶ï¼Œç¼©å†™ä¸º GC</p>
<p>å¼•ç”¨è®¡æ•°çš„å®ç°è¦ç®€å•ä¸€äº›ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯Perl/PHP/Python è¯­è¨€ä¸€å¼€å§‹ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯ï¼Œå®ç°å†…å­˜ç®¡ç†çš„åŸå› ã€‚ä½†æ˜¯ï¼Œéšç€æ—¶é—´çš„å˜æ›´ï¼Œå¼•ç”¨è®¡æ•°çš„å±€é™æ€§è¶Šæ¥è¶Šå¤šã€‚æ‰€ä»¥ï¼Œä¸Šé¢çš„è¯­è¨€ï¼Œæœ€ç»ˆéƒ½æ·»åŠ äº†å®Œæ•´çš„è¿½è¸ªGC å®ç°ï¼Œæˆ–è€…æœ‰è¶³å¤Ÿçš„ GCé€»è¾‘ å‘¨æœŸæ€§æ¸…ç†å¯¹è±¡ã€‚</p>
<p>è¿½è¸ªåƒåœ¾å›æ”¶å…·æœ‰å¯æ€•çš„åå£°ã€‚åœ¨åŸç”Ÿå†…å­˜çº§åˆ«å·¥ä½œï¼Œéå¸¸ç—›è‹¦ã€‚è°ƒè¯• GCï¼Œä¼šè®©ä½ åœ¨æ¢¦é‡Œéƒ½è¿˜åœ¨æƒ³ç€16è¿›åˆ¶è½¬å‚¨é—®é¢˜ã€‚ä½†æ˜¯ï¼Œè¯·è®°ä½ï¼Œæœ¬ä¹¦ä¼šå¸¦ç€æˆ‘ä»¬ä¸€èµ·é©±æ•£é­”æ³•ï¼Œæ€æ­»æ€ªå…½ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿä¼šç¼–å†™è‡ªå·±çš„åƒåœ¾å›æ”¶ç¨‹åºã€‚æˆ‘çŒœæƒ³ï¼Œä½ ä¸€å®šä¼šå‘ç°ç®—æ³•éå¸¸ç®€å•ï¼Œå¹¶ä¸”æ•´ä¸ªç¨‹åºéå¸¸æœ‰è¶£ã€‚</p>
<blockquote>
<p>In practice, ref counting and tracing are more ends of a continuum than opposing sides. Most ref counting systems end up doing some tracing to handle cycles, and the write barriers of a generational collector look a bit like retain calls if you squint.</p>
<p>åœ¨å®è·µä¸­ï¼Œå¼•ç”¨è®¡æ•°å’Œè¿½è¸ªæŠ€æœ¯ä¼šæ··åˆä½¿ç”¨ï¼Œè€Œä¸æ˜¯ç›¸äº’å¯¹ç«‹ã€‚å¤§å¤šæ•°çš„å¼•ç”¨è®¡æ•°ï¼Œéƒ½ä¼šè¿›è¡Œä¸€äº›å‘¨æœŸæ€§çš„è¿½è¸ªï¼Œå¦‚æœä½ ä»”ç»†æŸ¥çœ‹ï¼Œåˆ†ä»£é‡‡é›†å™¨çš„ç”¨æ³•çœ‹èµ·æ¥åƒæ˜¯ä¿ç•™è°ƒç”¨ã€‚</p>
<p>For lots more on this, see <a href="https://github.com/Kua-Fu/blog-book-images/blob/main/paper/unified-theory-gc.pdf">â€œA Unified Theory of Garbage Collectionâ€</a> (PDF).</p>
<p>æ›´å¤šçš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="https://github.com/Kua-Fu/blog-book-images/blob/main/paper/unified-theory-gc.pdf">â€œåƒåœ¾æ”¶é›†çš„ç»Ÿä¸€ç†è®ºâ€</a></p>
</blockquote>
<h2 id="ä¸‰data-types"><a class="header" href="#ä¸‰data-types">ä¸‰ã€Data Types</a></h2>
<p>æ•°æ®ç±»å‹</p>
<p>In Loxâ€™s little universe, the atoms that make up all matter are the built-in data types. There are only a few:</p>
<ol>
<li>
<p><strong>Booleans</strong></p>
<p>You canâ€™t code without logic and you canâ€™t logic without Boolean values. â€œTrueâ€ and â€œfalseâ€, the yin and yang of software. Unlike some ancient languages that repurpose an existing type to represent truth and falsehood, Lox has a dedicated Boolean type. </p>
<p>There are two Boolean values, obviously, and a literal for each one.</p>
<pre><code>
true;  // Not false.
false; // Not *not* false.

</code></pre>
<blockquote>
<p>Boolean variables are the only data type in Lox named after a person, George Boole, which is why â€œBooleanâ€ is capitalized. He died in 1864, nearly a century before digital computers turned his algebra into electricity. I wonder what heâ€™d think to see his name all over billions of lines of Java code.</p>
<p>å¸ƒå°”å˜é‡æ˜¯Loxè¯­è¨€ä¸­ï¼Œå”¯ä¸€ä½¿ç”¨äººåå‘½åçš„æ•°æ®ç±»å‹ã€‚Booleanæ˜¯ä¸ºäº†çºªå¿µ George Boole, ä»–äº1864å¹´å»ä¸–ï¼Œä¸€ä¸ªä¸–çºªåï¼Œè®¡ç®—æœºç§‘å­¦å°†ä»–å‘æ˜çš„å¸ƒå°”ä»£æ•°ï¼Œè½¬æ¢ä¸ºè®¡ç®—æœºè¡¨ç¤ºã€‚æˆ‘æƒ³çŸ¥é“ï¼Œå½“ä»–åœ¨æ•°åäº¿Javaä»£ç ä¸­ï¼Œçœ‹åˆ°è‡ªå·±çš„åå­—ï¼Œä¼šæœ‰ä»€ä¹ˆæ„Ÿæƒ³ğŸ˜„</p>
</blockquote>
</li>
<li>
<p><strong>Numbers</strong></p>
<p>Lox has only one kind of number: double-precision floating point. Since floating-point numbers can also represent a wide range of integers, that covers a lot of territory, while keeping things simple.</p>
<p>Full-featured languages have lots of syntax for numbersâ€”hexadecimal, scientific notation, octal, all sorts of fun stuff. Weâ€™ll settle for basic integer and decimal literals.</p>
<pre><code>
1234;  // An integer.
12.34; // A decimal number.

</code></pre>
</li>
<li>
<p><strong>Strings</strong></p>
<p>Weâ€™ve already seen one string literal in the first example. Like most languages, they are enclosed in double quotes.</p>
<p>As weâ€™ll see when we get to implementing them, there is quite a lot of complexity hiding in that innocuous sequence of characters.</p>
<pre><code>
&quot;I am a string&quot;;
&quot;&quot;;    // The empty string.
&quot;123&quot;; // This is a string, not a number.

</code></pre>
<blockquote>
<p>Even that word â€œcharacterâ€ is a trickster. Is it ASCII? Unicode? A code point or a â€œgrapheme clusterâ€? How are characters encoded? Is each character a fixed size, or can they vary?</p>
<p>å³ä½¿æ˜¯å•è¯ï¼Œå­—èŠ‚ï¼Œä¹ŸåŒ…å«äº†ä¸€äº›éšè—ä¿¡æ¯ï¼Œå­—èŠ‚æ˜¯ASCIIç¼–ç çš„ï¼Œè¿˜æ˜¯Unicodeç¼–ç ï¼›ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸€ä¸ªä»£ç ç‚¹ï¼Œè¿˜æ˜¯ä¸€ä¸ªå›¾å½¢é›†ç°‡ï¼›å­—èŠ‚æ˜¯å¦‚ä½•ç¼–ç çš„ï¼Œæ˜¯å®šé•¿ç¼–ç ï¼Œè¿˜æ˜¯å˜é•¿ç¼–ç ï¼Ÿ</p>
</blockquote>
</li>
<li>
<p><strong>Nil</strong></p>
<p>Thereâ€™s one last built-in value whoâ€™s never invited to the party but always seems to show up. It represents â€œno valueâ€. Itâ€™s called â€œnullâ€ in many other languages. In Lox we spell it nil.  (When we get to implementing it, that will help distinguish when weâ€™re talking about Loxâ€™s nil versus Java or Câ€™s null.)</p>
<p>There are good arguments for not having a null value in a language since null pointer errors are the scourge of our industry. If we were doing a statically typed language, it would be worth trying to ban it. In a dynamically typed one, though, eliminating it is often more annoying than having it.</p>
</li>
</ol>
<p>åœ¨Loxçš„å°å®‡å®™ä¸­ï¼Œæ„æˆç‰©è´¨çš„åŸå­æ˜¯å†…ç½®çš„å‡ ç§æ•°æ®ç±»å‹ï¼Œè¯¦è§ä¸‹é¢çš„ä»‹ç»:</p>
<ol>
<li>
<p>å¸ƒå°”ç±»å‹</p>
<p>æ²¡æœ‰é€»è¾‘è¿ç®—ï¼Œæˆ‘ä»¬æ— æ³•è¿›è¡Œç¼–ç¨‹ï¼Œè€Œé€»è¾‘è¿ç®—ï¼Œéœ€è¦å¸ƒå°”æ•°æ®ç±»å‹ã€‚çœŸä¸å‡ï¼Œç¼–ç¨‹ä¸–ç•Œä¸­çš„é˜´ä¸é˜³ï¼Œä¸ä¸€äº›æ—©å…ˆè¯­è¨€å¤ç”¨å…¶ä»–æ•°æ®ç±»å‹è¡¨ç¤ºå¸ƒå°”ç±»å‹ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¼šåœ¨Loxè¯­è¨€ä¸­å®šä¹‰ä¸€ä¸ªä¸“ç”¨çš„å¸ƒå°”æ•°æ®ç±»å‹ã€‚</p>
<p>æ˜¾ç„¶ï¼Œå¸ƒå°”å€¼æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼Œæ¯ä¸ªå€¼å¯¹åº”äº†ä¸€ä¸ªæ–‡æœ¬</p>
<pre><code>true;  // Not false.
false; // Not *not* false.
</code></pre>
</li>
<li>
<p>æ•°å€¼ç±»å‹</p>
<p>Loxè¯­è¨€ï¼Œåªæœ‰ä¸€ç§æ•°å€¼ç±»å‹ï¼ŒåŒç²¾åº¦æµ®ç‚¹æ•°ã€‚å› ä¸ºæµ®ç‚¹æ•°ï¼Œå¯ä»¥åŒ…å«å¤§èŒƒå›´çš„æ•´æ•°ï¼Œè¿™æ ·åšï¼Œä¸ä½†å¯ä»¥åŒ…å«å¾ˆå¤šå…¶ä»–æ•°æ®ç±»å‹ï¼Œè€Œä¸”å¯ä»¥ä¿æŒç®€æ´ã€‚</p>
<p>åŠŸèƒ½é½å…¨çš„è¯­è¨€ï¼Œä¼šæœ‰å¾ˆå¤šçš„æ•°å­—è¯­æ³•ï¼Œä¾‹å¦‚ï¼šåå…­è¿›åˆ¶è¡¨ç¤ºã€ç§‘å­¦è®¡æ•°æ³•ã€å…«è¿›åˆ¶è¡¨ç¤ºï¼Œä»¥åŠå…¶ä»–çš„æœ‰è¶£çš„ä¸œè¥¿ã€‚ä½†æ˜¯åœ¨Loxè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å°†åªä¼šæ»¡è¶³åŸºæœ¬çš„æ•´æ•°è¿ç®—å’Œåè¿›åˆ¶è¡¨ç¤ºã€‚</p>
<pre><code>
1234;  // An integer.
12.34; // A decimal number.

</code></pre>
</li>
<li>
<p>å­—ç¬¦ä¸²</p>
<p>ä»ä¸Šé¢çš„ç¬¬ä¸€ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²ç±»å‹ &quot;hello, world!&quot;ã€‚ å’Œå¤§å¤šæ•°çš„è¯­è¨€ä¸€æ ·ï¼Œå­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥ã€‚</p>
<p>å½“æˆ‘ä»¬å®ç°å­—ç¬¦ä¸²ç±»å‹æ—¶å€™ï¼Œå°†ä¼šçœ‹åˆ°ï¼Œåœ¨è¿™ä¸ªå®šä¹‰æ˜ç¡®çš„å­—ç¬¦åºåˆ—ä¸­ï¼Œéšè—ç€è®¸å¤šå¤æ‚åœºæ™¯ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚</p>
<pre><code>
&quot;I am a string&quot;;
&quot;&quot;;    // The empty string.
&quot;123&quot;; // This is a string, not a number.

</code></pre>
</li>
<li>
<p>Nil</p>
<p>æœ€åï¼Œè¿˜æœ‰ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå®ƒä¼¼ä¹ä»æ¥æ²¡æœ‰è¢«é‚€è¯·å‚åŠ ç¼–ç¨‹èšä¼šï¼Œä½†æ˜¯ä½ æ€»æ˜¯èƒ½çœ‹åˆ°å®ƒçš„èº«å½±ã€‚å®ƒï¼Œä»£è¡¨äº†ä¸å­˜åœ¨ï¼Œæ²¡æœ‰æ•°å€¼ã€‚åœ¨è®¸å¤šè¯­è¨€ä¸­ï¼Œä½¿ç”¨ null è¡¨ç¤ºå®ƒï¼Œè€Œåœ¨Loxè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ nil è¡¨ç¤ºå®ƒã€‚å½“æˆ‘ä»¬å®ç°å®ƒæ—¶ï¼Œå¯ä»¥æ›´å¥½çš„ä¸ Java/Cè¯­è¨€ä¸­çš„null åŒºåˆ«å¼€ã€‚</p>
<p>åœ¨è¯­è¨€ä¸­ï¼Œä¸ä½¿ç”¨ nil å­˜åœ¨å¾ˆå¤šå¥½å¤„ï¼Œç©ºæŒ‡é’ˆæŠ¥é”™æ˜¯ç¼–ç¨‹è¡Œä¸šå¸¸è§çš„æŠ¥é”™ã€‚å¦‚æœï¼Œæˆ‘ä»¬è¦å®ç°ä¸€é—¨é™æ€ç±»å‹è¯­è¨€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¦æ­¢ nilç±»å‹æ˜¯å€¼å¾—çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦å®ç°ä¸€é—¨åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œé€šå¸¸ï¼Œä¿ç•™ nilç±»å‹ï¼Œæ‹¥æœ‰æ›´å¤šçš„å¥½å¤„ï¼Œç›¸æ¯”äºç¦æ­¢è¯¥ç±»å‹ã€‚</p>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../welcome/a-map-of-the-territory.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../welcome/a-map-of-the-territory.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
